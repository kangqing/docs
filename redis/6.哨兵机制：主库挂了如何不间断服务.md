# 6.哨兵机制：主库挂了，如何不间断服务

上次介绍了主从集群模式，如果从库发生故障，客户端可以向其他从库发送读请求，进行操作，但是如果主库挂了，那就直接会影响从库的同步，因为从库没有相应的主库可以进行数据复制操作。

而且，如果客户端发送的都是读操作请求，那还可以在从库继续提供服务，这在纯读的业务场景下还能被接收，但是一旦有写操作请求，按照主从模式读写分离要求，需要主库完成写操作，此时，也没有实例可以完成写操作了，如下图所示：

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/d828d7eee133cec690dc140e99e26f20.jpg)

无论是写服务中断，还是从库无法进行数据同步，都是不能接受的，所以，如果主库挂了，我们需要运行一个新主库，比如把一个从库切换为主库，这就涉及到三个问题

1. 主库真的挂了吗？
2. 选择那个从库作为新主库？
3. 怎么把新主库的相关信息通知给从库和客户端？

这就要提到哨兵机制了，在Redis 主从集群中，哨兵机制是实现主从库切换的关键机制，它有效的解决了主从复制模式下故障转移的这三个问题。

## 哨兵机制的基本流程

哨兵其实就是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行。哨兵主要负责的就是三个任务：监控、选主、通知。

### 监控

监控是指哨兵进程在运行时，周期性的给所有的主从库发送 PING 命令，检测他们是否仍然在线运行。如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标记为下线状态，同样，如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始自动切换主库的流程。

### 选主

主库挂了以后，哨兵就需要从很多个从库里，按照一定的规则选择一个从库实例，把它作为新主库，这一步完成后，现在的集群就有了新的主库。

### 通知

在执行通知任务时，哨兵把新主库的连接信息发送给其他从库，让他们执行 replicaof 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让他们把请求操作发送到新主库上。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/efcfa517d0f09d057be7da32a84cf2a1.jpg)



在这三个任务中，通知任务相对比较简单，哨兵只需要把新主库信息发送给从库和客户断，让他们和新主库建立连接就行，并不涉及决策逻辑。但是在监控和选主两个任务中，哨兵需要做两个决策：

- 在监控任务中，哨兵需要判断主库是否处于下线状态；
- 在选主任务中，哨兵也要决定选择哪个从库作为新主库。

如何判断主库的下线状态？哨兵对主库的下线判断有`主观下线`和`客观下线`两种，那么为什么会存在两种判断呢？他们的区别和联系是什么呢？

## 主观下线和客观下线

主观下线：哨兵进程会使用PING 命令检测他自己和主、从库的网络连接情况，用来判断实例的状态。如果哨兵发现主库或从库对 PING 命令响应超时了，那么哨兵就会先把他标记为主观下线。

如果检测的是从库，那么哨兵简单的标记他为主观下线就行了，因为从库的下线影响一般不大，集群对外服务不会间断。

但是，如果检测的是主库，那么哨兵还不能简单的标记为主观下线，开始主从切换，因为很有可能存在这样一个情况，那就是哨兵误判了，其实主库并没有故障，可是，一旦启动可主从切换，后续的选主和通知操作就会带来额外的计算和通信开销。

为了避免不必要的开销，我们需要特别注意误判的情况。

### 哨兵误判主库下线

首先，误判就是主库实际上并没有下线，但是哨兵误以为他下线了。误判一般发生在集群网络压力较大、网络拥堵，或者是主库本身压力较大的情况下。

一旦哨兵判断主库下线，就会开始选择新的主库，并让从库和新主库进行数据同步，这个过程本身就有开销，例如，哨兵要花时间选主，从库也要花时间和新主库进行数据同步。而在误判的情况下，主库本身不需要进行切换，所以这个过程开销是没有价值的。正是因为这样，我们需要判断是否有误判，以及减少误判。

那么怎么减少误判呢？在日常生活中，当我们对一些重要的事情进行判断的时候，经常会和家人或者朋友商量一下再做决定。

哨兵机制也是类似，他会通常采用多实例组成的集群模式进行部署，这也被称为哨兵集群。引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好而误判主库下线的情况。同时多个哨兵网络同时不稳定的概率很小，有他们一起做决策，误判概率很低。



只有大多数哨兵都判断主库已经主观下线，主库才会被标记为客观下线，这个叫法也是表明主库下线成为一个客观事实了。这个判断的原则就是少数服从多数。同时，这也会进一步触发哨兵还是进行主从切换流程。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/1945703abf16ee14e2f7559873e4e60d.jpg)

简单来说，客观下线的标准就是，当有N个哨兵时候，最好有 N/2 + 1个实例以上判断主库为主观下线，才能最终判断主库为客观下线。这样一来就可以减少误判的概率。也能避免误判带来无畏的开销。当然，有多少个实例做出主观下线的判断才可以，可以有redis管理员自行设定。

## 如何选定新主库

一般来说，我们把哨兵选择新主库的过程称为`筛选+打分`。简单来说，我们在多个从库中，先按照一定的筛选条件，把不符合条件的从库去掉，然后再按照一定的规则，给剩下的从库逐个打分，将得分最高的从库选为新主库。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/f2e9b8830db46d959daa6a39fbf4a14c.jpg)

筛选条件：一般情况下，我们肯定要保证所选的从库仍然在运行，不过，在选主时从库正常在线，只能表示从库的现状良好，并不代表他就是最适合做主库的。

设想一下，如果一个从库正常运行，就直接选为主库了，可他的网络很快出现了故障，此时就又要重新选主了，这显然不是我们期望的结果。

所以在选主时，不仅要检查从库的在线状态，还要判断它之前的网络连接状态，如果从库总是和主库断连，而且断连次数超过了一定的阈值，我们就可以认为这个从库的网络状况不太好，就可以把这个从库删除了。

具体怎么判断呢？你使用配置项`down-after-milliseconds * 10` 其中，`down-after-milliseconds`是指我们认定主从连接断连的最大连接超时时间。如果在`down-after-milliseconds`毫秒内，主从节点都没有通过网络联系上，我们就可以任务主从节点断连了，如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不太好，不适合作为新主库。

从库打分：我们可以按照三个规则进行三轮打分，分别是从库优先级、从库复制以及从库ID号。只要在某一轮中，有从库得分最高，那么他就是主库了，选主过程到此结束，如果没有出现分数最高的从库，那么就继续下一轮。

### 第一轮优先级最高从库得分高

用户可以通过`slave-priority`配置项，给不同的从库设置不同的优先级。比如，你有两个从库，他们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么他就是新主库了，如果优先级都一样，则进行第二轮打分。

### 第二轮，和旧主库同步程度最接近的从库得高分

这个规则依据是，如果选择和旧主库同步最接近的从库为新主库，那么这个新主库上就会有最新数据。

#### 如何判断从库和旧主库同步进度？

主从库有个命令传播的过程，在这个过程中，主库会用`master_repl_offset`记录当前的最新写操作在`repl_backlog_buffer`中的位置，而从库会用`slave_repl_offset`这个值记录当前的复制进度。

此时，我们想要找到的从库，他的`slave_repl_offset`需要最接近`master_repl_offset`如果在所有从库中，有从库最接近，他的得分就会最高，可以作为新主库。

如下图所示，旧主库的`master_repl_offset`是1000，从库1、2和3的`slave_repl_offset`分别是950、990、900，那么从库2就应该被选为新主库。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/626yy88853a2d15b5196b922367140df.jpg)

如果有两个以上从库的同步程度都是最高，就要进行第三轮打分了。

### 第三轮：ID号小的从库得分高

每个实例都有一个默认ID号，这个ID号类似于从库的编号，目前Redis 在选主时，有一个默认的规定，在优先级和复制进度都相同的情况下，ID号小的从库得分最高，被选为新主库。

