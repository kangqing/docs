# 7.哨兵挂了主从库还能切换吗

如果你配置过哨兵集群，就会知道，在配置哨兵集群的时候，我们只需要用到下面这个配置项，设置主库的 IP 和端口，并没有配置其他的哨兵连接信息。

```bash
sentinel monitor <master-name> <ip> <redis-port> <quorum>
```

这些哨兵实例既不知道彼此的地址，又怎么组成集群呢？要明白这个问题，只需要了解一下哨兵集群的组成和运行机制就行了。

## 基于pub/sub机制的哨兵集群组成

哨兵实例之间可以相互发现，主要依赖 Redis 的pub/sub 机制，也就是发布/订阅机制。

哨兵只要和主库建立连接之后，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP和端口号）同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵在主库上做了发布订阅操作之后，他们之间就知道了彼此的IP地址和端口号。

除了哨兵实例，我们自己编写的应用程序也可以通过Redis 完成消息的发布订阅。所以，为了区分不同应用的消息， Redis 会以频道的形式，对这些消息进行分门别类的管理。所谓的频道，就是消息的类别。当消息类别相同的时候，它就属于一个频道，反之，就属于不同的频道，只有订阅了同一个频道的应用，才能通过发布的消息进行信息的交换。

在主从集群中，主库上有一个名为`__sentinel__:hello`的频道，不同的哨兵就是通过它来实现相互发现，实现相互通信的。

如下图中，哨兵1把自己的IP 和端口发布到`__sentinel__:hello`频道上，哨兵2和哨兵3订阅了该频道，那么此时哨兵2和3就可以从这个频道直接获取哨兵1的地址和端口号。

然后哨兵2和3就可以和哨兵1建立网络连接。通过这个方式，哨兵2和3也可以建立网络连接，这样一来，哨兵集群就形成了。他们之间相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事进行判断和协商。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/ca42698128aa4c8a374efbc575ea22b1.jpg)

哨兵除了彼此之间建立连接形成集群之外，还需要和从库建立连接。这是因为，在哨兵的监控任务中，他需要对主库和从库都进行心跳判断，而且在主从库切换完成后，他还需要通知从库，让他们和新主库进行同步。

### 哨兵如何知道从库的IP地址和端口号

这是由哨兵向主库发送 INFO 命令完成的，就像下图所示，哨兵2给主库发送 INFO 命令，主库返回从库列表，接着哨兵和从库列表中的每个从库建立连接，并在这个连接上持续的对从库进行监控，哨兵1和3也是同样的方式和从库建立连接的。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/88fdc68eb94c44efbdf7357260091de0.jpg)

通过pub/sub机制，哨兵之间可以组成集群，同时哨兵又通过 INFO 命令，获得了从库的连接信息，也能和从库建立连接，并进行监控。

主从库切换后，客户端也需要知道新主库的连接信息，所以，哨兵还需要完成把新主库的信息高速客户端的这个任务。

## 基于发布订阅机制的客户端事件通知

从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过他并不服务请求操作，只是完成监控、选主和通知任务。所以，每个哨兵实例也提供发布订阅机制，客户端可以从哨兵订阅消息，哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。

重要的事件如下：

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/4e9665694a9565abbce1a63cf111f725.jpg)

知道了这些频道之后，你就可以让客户端从哨兵订阅消息了，具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接，然后，就可以在客户端执行订阅命令，获取不同的事件消息。

举个例子，你可以执行如下命令，来订阅所有实例进入客观下线状态的事件：

```bash
SUBSCRIBE +odown
```

当然你也可以执行下面的命令订阅所有事件：

```bash
PSUBSCRIBE *
```

当哨兵把新主库选择出来之后，客户端就会看到下面的switch-master事件。这个事件表示主库已经切换了，新主库的IP地址和端口信息已经有了。这个时候，客户端就可以用这里面的新主库地址和端口进行通信了。

```bash
switch-master <master-name> <oldip> <oldport> <newip> <newport>
```

有了这些事件通知，客户端不仅可以在主从切换后得到新主库的信息，还可以监控到主从库切换过程中发生的各个重要事件，这样，客户端就可以知道主从切换进行到哪一步了，有助于了解切换速度。

## 由哪个哨兵进行主从切换

确定哪个哨兵执行主从切换的过程，和主库客观下线的判断过程类似，也是一个投票的过程。

### 判断客观下线的仲裁过程

任何一个实例只要自身判断主库主观下线后，就会给其他实例发送`is-master-down-by-addr`命令，接着，其他实例会根据自己和主库的连接情况，做出 Y 或者 N 的响应， Y 相当于赞成， N 相当于反对。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/e0832d432c14c98066a94e0ef86af384.jpg)

一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为客观下线，这个所需赞成票数是通过哨兵配置文件中的`quorum` 配置项设定的，例如哨兵数量是 5，quorum设置为 3，那么一个哨兵需要 3 张赞成票，就可以标记主库客观下线，这三张赞成票包括自己的一张赞成票和另外两个哨兵的赞成票。

此时，这个哨兵就可以再给其他哨兵发送命令，表示希望自己来执行主从切换，并让所有其他哨兵进行投票，这个投票的过程称为`Leader选举`。因为最终执行主从切换的哨兵称为Leader,投票过程就是确定Leader的过程。

任何一个哨兵想要称为Leader的两个条件是，第一，拿到半数以上赞成票，第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值，以 3个哨兵为例，quorum 值为2，那么任何一个哨兵想成为Leader 只要拿到 2个赞成票就可以了。

![img](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202102/5f6ceeb9337e158cc759e23c0f375fd9.jpg)

在T1时刻, S1判断主库为客观下线，它想成为Leader进行主从切换，就给自己一张 Y赞成票，然后分别向S2和S3发送命令，表示想成为 Leader.

T2时刻，S3判断主库客观下线，也想成为Leader,自己投自己一票Y，向S1和S2发送命令，表示想成为Leader.

T3时刻，S1收到了S3的Leader投票请求，由于S1已经赞成自己，所以不能给其他哨兵赞成了，只能投N 反对票，同时S2收到了S3的投票请求，由于第一次收到请求，所以他会给第一个收到的投票请求投赞成票，给后续收到的请求投返回票，所以，S2回复S3赞成

T4时刻，S2收到S1的投票请求，因为S2已经投S3赞成票，所以只能回复反对。

最后，T5时刻，S1得票一个Y一个N，而S3得票，一个N两个Y，S3不仅获得了半数以上赞成票，还达到了预设的quorum值，也就是2，所以成功当选Leader,接着S3会进行选主操作，而且在选定新主库之后，会给其他的从库和客户端通知新主库的信息。

如果S3没有拿到S2的赞成票，那么这轮投票就不会产生Leader,哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的2倍）在进行重新选举，这是因为，哨兵集群能够进行成功投票，很大程度上依赖于选举命令的正常网络传播，如果网络压力大或短时阻塞，就可能导致没有一个哨兵拿到半数以上的赞成票，所以等网络拥塞好转之后，在进行选举成功的概率就会增加。

需要注意的是，如果有两个哨兵实例，此时一个哨兵要想成为Leader,必须获得两票，而不是一票，所以有个哨兵挂了，那么集群是无法进行主从切换的，所以通常至少要配置 3个哨兵实例，这一点很重要，在实际运用中不能忽略。

**要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断值 down-after-milliseconds**

