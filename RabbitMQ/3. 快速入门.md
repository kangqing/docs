# 3. å¿«é€Ÿå…¥é—¨

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) ã€‚

åœ¨ AMQP ä¸­ï¼ŒProducer å°†æ¶ˆæ¯å‘é€åˆ° Exchange ï¼Œå†ç”± Exchange å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª Queue ä¸­ï¼ˆæˆ–è€…ä¸¢å¼ƒï¼‰ã€‚

> æ¦‚å¿µçš„è®²è§£ï¼Œå¼•ç”¨è‡ª [ã€ŠRabbitMQ åŸºç¡€æ¦‚å¿µè¯¦è§£ã€‹](http://www.iocoder.cn/RabbitMQ/Detailed-understanding-of-the-basic-concepts-of-RabbitMQ/?self) æ–‡ç« ã€‚

Exchange æ ¹æ® Routing Key å’Œ Binding Key å°†æ¶ˆæ¯è·¯ç”±åˆ° Queue ã€‚ç›®å‰æä¾›äº† Directã€Topicã€Fanoutã€Headers å››ç§ç±»å‹ã€‚

## 3.1 Direct Exchange

Direct ç±»å‹çš„ Exchange è·¯ç”±è§„åˆ™æ¯”è¾ƒç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº› binding key ä¸ routing key å®Œå…¨åŒ¹é…çš„ Queue ä¸­ã€‚ä»¥ä¸‹å›¾çš„é…ç½®ä¸ºä¾‹ï¼š

![Direct Exchange](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202303/aeb33c91bbf83726c24ba1dae9dc4e00.png)

- æˆ‘ä»¬ä»¥ `routingKey="error"` å‘é€æ¶ˆæ¯åˆ° Exchange ï¼Œåˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ° Queue1(`amqp.gen-S9bâ€¦`) ã€‚
- æˆ‘ä»¬ä»¥ `routingKey="info"` æˆ– `routingKey="warning"` æ¥å‘é€æ¶ˆæ¯ï¼Œåˆ™æ¶ˆæ¯åªä¼šè·¯ç”±åˆ° Queue2(`amqp.gen-Aglâ€¦`) ã€‚
- å¦‚æœæˆ‘ä»¬ä»¥å…¶å®ƒ routingKey å‘é€æ¶ˆæ¯ï¼Œåˆ™æ¶ˆæ¯ä¸ä¼šè·¯ç”±åˆ°è¿™ä¸¤ä¸ª Queue ä¸­ã€‚
- æ€»ç»“æ¥è¯´ï¼ŒæŒ‡å®š Exchange + routing key ï¼Œæœ‰ä¸”ä»…ä¼šè·¯ç”±åˆ°è‡³å¤šä¸€ä¸ª Queue ä¸­ã€‚ğŸ˜ˆ æç«¯æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œæ¶ˆæ¯å°±å‘é€åˆ°â€œç©ºæ°”â€ä¸­ï¼Œä¸ä¼šè¿›å…¥ä»»ä½• Queue ä¸­ã€‚

> æ³¨ï¼šQueue åå­— `amqp.gen-S9bâ€¦` å’Œ `amqp.gen-Aglâ€¦` è‡ªåŠ¨ç”Ÿæˆçš„ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª Direct Exchange çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯¹åº” [lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) é¡¹ç›®ã€‚

### 3.1.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-04-rabbitmq-demo</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ RabbitMQ çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

</project>
```



å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

### 3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`resources`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/resources) ç›®å½•ä¸‹ï¼Œåˆ›å»º [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/resources/application.yaml) é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
```



- åœ¨ `spring.rabbitmq` é…ç½®é¡¹ï¼Œè®¾ç½® RabbitMQ çš„é…ç½®ï¼Œå¯¹åº” [RabbitProperties](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitProperties.java) é…ç½®ç±»ã€‚è¿™é‡Œå’±æš‚æ—¶æœ€å°åŒ–æ·»åŠ ï¼Œæ›´å¤šçš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬åœ¨ä¸‹æ–‡çš„ç¤ºä¾‹ä¸­ï¼Œä¸€ç‚¹ç‚¹æŠ½ä¸å‰¥èŒ§ã€‚
- Spring Boot æä¾›çš„ [RabbitAutoConfiguration](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration.java) è‡ªåŠ¨åŒ–é…ç½®ç±»ï¼Œå®ç° RabbitMQ çš„è‡ªåŠ¨é…ç½®ï¼Œåˆ›å»ºç›¸åº”çš„ Producer å’Œ Consumer ã€‚

### 3.1.3 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Application.java

@SpringBootApplication
@EnableAsync // å¼€å¯å¼‚æ­¥
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```



- æˆ‘ä»¬é¢å¤–æ·»åŠ äº† `@EnableAsync` æ³¨è§£ï¼Œå› ä¸ºæˆ‘ä»¬ç¨åè¦ä½¿ç”¨ Spring æä¾›çš„å¼‚æ­¥è°ƒç”¨çš„åŠŸèƒ½ã€‚ä¸äº†è§£è¿™å—çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹è‰¿è‰¿å†™çš„ [ã€ŠèŠ‹é“ Spring Boot å¼‚æ­¥ä»»åŠ¡å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/Async-Job/?self) æ–‡ç« ã€‚

### 3.1.4 Demo01Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo01Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo01Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo01Message.java

public class Demo01Message implements Serializable {

    public static final String QUEUE = "QUEUE_DEMO_01";

    public static final String EXCHANGE = "EXCHANGE_DEMO_01";

    public static final String ROUTING_KEY = "ROUTING_KEY_01";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- æ³¨æ„ï¼Œè¦å®ç° Java Serializable åºåˆ—åŒ–æ¥å£ã€‚å› ä¸º RabbitTemplate é»˜è®¤ä½¿ç”¨ Java è‡ªå¸¦çš„åºåˆ—åŒ–æ–¹å¼ï¼Œè¿›è¡Œåºåˆ—åŒ– POJO ç±»å‹çš„æ¶ˆæ¯ã€‚
- åœ¨æ¶ˆæ¯ç±»é‡Œï¼Œæˆ‘ä»¬æšä¸¾äº† Exchangeã€Queueã€RoutingKey çš„åå­—ã€‚

### 3.1.5 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  Direct Exchange ç¤ºä¾‹ç›¸å…³çš„ Exchangeã€Queueã€Binding çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

import org.springframework.amqp.core.Queue;

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo01Queue() {
            return new Queue(Demo01Message.QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo01Exchange() {
            return new DirectExchange(Demo01Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo01Message.EXCHANGE
        // Routing keyï¼šDemo01Message.ROUTING_KEY
        // Queueï¼šDemo01Message.QUEUE
        @Bean
        public Binding demo01Binding() {
            return BindingBuilder.bind(demo01Queue()).to(demo01Exchange()).with(Demo01Message.ROUTING_KEY);
        }

    }

}
```



- åœ¨ DirectExchangeDemoConfiguration å†…éƒ¨é™æ€ç±»ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº† Exchangeã€Queueã€Binding ä¸‰ä¸ª Bean ï¼Œåç»­ [RabbitAdmin](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitAdmin.java) ä¼šè‡ªåŠ¨åˆ›å»ºäº¤æ¢å™¨ã€é˜Ÿåˆ—ã€ç»‘å®šå™¨ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [`RabbitAdmin#initialize()`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitAdmin.java#L555-L612) æ–¹æ³•ï¼Œæˆ– [ã€ŠRabbitMQ è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—/äº¤æ¢å™¨/ç»‘å®šã€‹](https://my.oschina.net/huaxian8812/blog/782300) æ–‡ç« ã€‚

### 3.1.6 Demo01Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo01Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo01Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo01Producer.java

@Component
public class Demo01Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º Demo01Message æ¶ˆæ¯
        Demo01Message message = new Demo01Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo01Message.EXCHANGE, Demo01Message.ROUTING_KEY, message);
    }

    public void syncSendDefault(Integer id) {
        // åˆ›å»º Demo01Message æ¶ˆæ¯
        Demo01Message message = new Demo01Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo01Message.QUEUE, message);
    }

    @Async
    public ListenableFuture<Void> asyncSend(Integer id) {
        try {
            // å‘é€æ¶ˆæ¯
            this.syncSend(id);
            // è¿”å›æˆåŠŸçš„ Future
            return AsyncResult.forValue(null);
        } catch (Throwable ex) {
            // è¿”å›å¼‚å¸¸çš„ Future
            return AsyncResult.forExecutionException(ex);
        }
    }

}
```



- RabbitTemplate æ˜¯ [AmqpTemplate](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/AmqpTemplate.java) æ¥å£çš„å®ç°ç±»ï¼Œæ‰€ä»¥æ­¤æ—¶ä½¿ç”¨ AmqpTemplate äº¦å¯ã€‚ä¸è¿‡åˆå› ä¸º RabbitTemplate è¿˜å®ç°äº†å…¶å®ƒæ¥å£ï¼Œæ‰€ä»¥æ“ä½œä¼šæ›´ä¸ºä¸°å¯Œã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©äº†æ³¨å…¥ RabbitTemplate å±æ€§ã€‚

- `#syncSend(Integer id)` æ–¹æ³•ï¼Œè°ƒç”¨ RabbitTemplate çš„åŒæ­¥å‘é€æ¶ˆæ¯æ–¹æ³•ã€‚æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š

  ```
  // AmqpTemplate.java
  
  void convertAndSend(String exchange, String routingKey, Object message) throws AmqpException;
  ```

  

  - æŒ‡å®š Exchange + RoutingKey ï¼Œä»è€Œè·¯ç”±åˆ°ä¸€ä¸ª Queue ä¸­ã€‚

- `#syncSendDefault(Integer id)` æ–¹æ³•ï¼Œä¹Ÿè°ƒç”¨ RabbitTemplate çš„åŒæ­¥å‘é€æ¶ˆæ¯æ–¹æ³•ã€‚æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š

  ```
  // AmqpTemplate.java
  
  void convertAndSend(String routingKey, Object message) throws AmqpException;
  ```

  

  - æ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å¥‡æ€ªï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„ RoutingKey ä¸ºé˜Ÿåˆ—åï¼Ÿï¼å› ä¸º RabbitMQ æœ‰ä¸€æ¡é»˜è®¤çš„ [Exchange: (AMQP default)](https://emacsist.github.io/2015/12/06/rabbitmqä¸­çš„åŸºæœ¬æ¦‚å¿µ/#default-exchange-é»˜è®¤äº¤æ¢æœº) è§„åˆ™ï¼š`The default exchange is implicitly bound to every queue, with a routing key equal to the queue name. It is not possible to explicitly bind to, or unbind from the default exchange. It also cannot be deleted` ã€‚
  - ç¿»è¯‘è¿‡æ¥çš„æ„æ€ï¼šé»˜è®¤äº¤æ¢å™¨ï¼Œéšå¼åœ°ç»‘å®šåˆ°æ¯ä¸ªé˜Ÿåˆ—ï¼Œè·¯ç”±é”®ç­‰äºé˜Ÿåˆ—åç§°ã€‚
  - æ‰€ä»¥ï¼Œæ­¤å¤„å³ä½¿æˆ‘ä»¬ä¼ å…¥çš„ RoutingKey ä¸ºé˜Ÿåˆ—åï¼Œä¸€æ ·å¯ä»¥å‘åˆ°å¯¹åº”é˜Ÿåˆ—ã€‚

- `#asyncSend(Integer id)` æ–¹æ³•ï¼Œé€šè¿‡ `@Async` æ³¨è§£ï¼Œå£°æ˜å¼‚æ­¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä»è€Œå®ç°å¼‚æ­¥æ¶ˆæ¯åˆ° RabbitMQ ä¸­ã€‚å› ä¸º RabbitTemplate å¹¶æœªåƒ [KafkaTemplate](https://github.com/spring-projects/spring-kafka/blob/master/spring-kafka/src/main/java/org/springframework/kafka/core/KafkaTemplate.java) æˆ– [RocketMQTemplate](https://github.com/apache/rocketmq-spring/blob/master/rocketmq-spring-boot/src/main/java/org/apache/rocketmq/spring/core/RocketMQTemplate.java) ç›´æ¥æä¾›äº†å¼‚æ­¥å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»“åˆ Spring å¼‚æ­¥è°ƒç”¨æ¥å®ç°ã€‚

  > åœ¨å†™å®Œæœ¬æ–‡ä¹‹åï¼Œå‘ç°è¿˜å­˜åœ¨ [AsyncRabbitTemplate](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/AsyncRabbitTemplate.java) ç±»ï¼Œæä¾›ä¸€éƒ¨çš„ RabbitMQ æ“ä½œã€‚ğŸ˜ˆ

### 3.1.7 Demo01Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo01Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo01Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo01Consumer.java

@Component
@RabbitListener(queues = Demo01Message.QUEUE)
public class Demo01Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo01Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

//    @RabbitHandler(isDefault = true)
//    public void onMessage(org.springframework.amqp.core.Message message) {
//        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
//    }

}
```



- åœ¨ç±»ä¸Šï¼Œæ·»åŠ äº† [`@RabbitListener`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/RabbitListener.java) æ³¨è§£ï¼Œå£°æ˜äº†æ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_01"` ã€‚
- åœ¨æ–¹æ³•ä¸Šï¼Œæ·»åŠ äº† [`@RabbitHandler`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/RabbitHandler.java) æ³¨è§£ï¼Œç”³æ˜äº†å¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€‚åŒæ—¶ï¼Œæ–¹æ³•å…¥å‚ä¸ºæ¶ˆæ¯çš„ç±»å‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ã€‚
- å¦‚æœæˆ‘ä»¬æƒ³è¦è·å¾—æ¶ˆè´¹æ¶ˆæ¯çš„æ›´å¤šä¿¡æ¯ï¼Œä¾‹å¦‚è¯´ï¼ŒRoutingKeyã€åˆ›å»ºæ—¶é—´ç­‰ç­‰ä¿¡æ¯ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨è‰¿è‰¿**æ³¨é‡Šæ‰çš„é‚£æ®µä»£ç **ï¼Œé€šè¿‡æ–¹æ³•å…¥å‚ä¸º [`org.springframework.amqp.core.Message`](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/Message.java) ç±»å‹ã€‚ä¸è¿‡ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆåšã€‚

### 3.1.8 ç®€å•æµ‹è¯•

åˆ›å»º [Demo01ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo01ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸‰ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo01Producer ä¸‰ä¸ªå‘é€æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo01ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo01ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo01Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void tesSyncSendDefault() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSendDefault(id);
        logger.info("[tesSyncSendDefault][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void testAsyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.asyncSend(id).addCallback(new ListenableFutureCallback<Void>() {

            @Override
            public void onFailure(Throwable e) {
                logger.info("[testASyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€å¼‚å¸¸]]", id, e);
            }

            @Override
            public void onSuccess(Void aVoid) {
                logger.info("[testASyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸï¼Œå‘é€æˆåŠŸ]", id);
            }

        });
        logger.info("[testASyncSend][å‘é€ç¼–å·ï¼š[{}] è°ƒç”¨å®Œæˆ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ä¸‰ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•åŒæ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 00:19:18.736  INFO 87164 --- [           main] c.i.s.l.r.producer.Demo01ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575908358] å‘é€æˆåŠŸ]

# Demo01Consumer æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 00:19:18.751  INFO 87164 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1575908358}]
```



- åŒæ­¥å‘é€çš„æ¶ˆæ¯ï¼ŒæˆåŠŸè¢«æ¶ˆè´¹ã€‚

æˆ‘ä»¬å†æ¥æ‰§è¡Œ `#tesSyncSendDefault()` æ–¹æ³•ï¼Œæµ‹è¯•å¦ä¸€ä¸ªåŒæ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 00:20:50.226  INFO 87515 --- [           main] c.i.s.l.r.producer.Demo01ProducerTest    : [tesSyncSendDefault][å‘é€ç¼–å·ï¼š[1575908450] å‘é€æˆåŠŸ]

# Demo01Consumer æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 00:20:50.240  INFO 87515 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1575908450}]
```



- åŒæ­¥å‘é€çš„æ¶ˆæ¯ï¼ŒæˆåŠŸä¹Ÿè¢«æ¶ˆè´¹ã€‚

æˆ‘ä»¬æœ€åæ¥æ‰§è¡Œ `#testAsyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•å¼‚æ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer å¼‚æ­¥å‘é€æ¶ˆæ¯çš„è°ƒç”¨å®Œæˆã€‚
2019-12-15 00:22:48.891  INFO 88018 --- [           main] c.i.s.l.r.producer.Demo01ProducerTest    : [testASyncSend][å‘é€ç¼–å·ï¼š[1575908568] è°ƒç”¨å®Œæˆ]

# Producer å¼‚æ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚ã€å›è°ƒã€‘
2019-12-15 00:22:48.905  INFO 88018 --- [         task-1] c.i.s.l.r.producer.Demo01ProducerTest    : [testASyncSend][å‘é€ç¼–å·ï¼š[1575908568] å‘é€æˆåŠŸï¼Œå‘é€æˆåŠŸ]

# Demo01Consumer æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 00:22:48.918  INFO 88018 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1575908568}]
```



- å¼‚æ­¥å‘é€çš„æ¶ˆæ¯ï¼ŒæˆåŠŸä¹Ÿè¢«æ¶ˆè´¹ã€‚

## 3.2 Topic Exchange

å‰é¢è®²åˆ° Direct Exchangeè·¯ç”±è§„åˆ™ï¼Œæ˜¯å®Œå…¨åŒ¹é… binding key ä¸routing keyï¼Œä½†è¿™ç§ä¸¥æ ¼çš„åŒ¹é…æ–¹å¼åœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¸èƒ½æ»¡è¶³å®é™…ä¸šåŠ¡éœ€æ±‚ã€‚

Topic Exchange åœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸ Direct ç±»å‹çš„Exchange **ç›¸ä¼¼**ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ° binding key ä¸ routing key ç›¸åŒ¹é…çš„ Queue ä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®šï¼š

- routing key ä¸ºä¸€ä¸ªå¥ç‚¹å· `"."` åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å°†è¢«å¥ç‚¹å·`"."`åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯ï¼Œä¾‹å¦‚ "stock.usd.nyse"ã€"nyse.vmw"ã€"quick.orange.rabbit"
- binding key ä¸ routing key ä¸€æ ·ä¹Ÿæ˜¯å¥ç‚¹å· `"."` åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚
- binding key ä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ `"*"` ä¸ `"#"`ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ã€‚å…¶ä¸­ `"*"` ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œ`"#"` ç”¨äºåŒ¹é…å¤šä¸ªå•è¯ï¼ˆå¯ä»¥æ˜¯é›¶ä¸ªï¼‰ã€‚

ä»¥ä¸‹å›¾ä¸­çš„é…ç½®ä¸ºä¾‹ï¼š![Topic Exchange](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202303/d343228b9d7606ac673ccd0028d4e424.png)

- `routingKey="quick.orange.rabbit"` çš„æ¶ˆæ¯ä¼šåŒæ—¶è·¯ç”±åˆ° Q1 ä¸ Q2 ã€‚
- `routingKey="lazy.orange.fox"` çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ° Q1 ã€‚
- `routingKey="lazy.brown.fox"` çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ° Q2 ã€‚
- `routingKey="lazy.pink.rabbit"` çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ°Q2ï¼ˆåªä¼šæŠ•é€’ç»™ Q2 ä¸€æ¬¡ï¼Œè™½ç„¶è¿™ä¸ª routingKey ä¸ Q2 çš„ä¸¤ä¸ª bindingKey éƒ½åŒ¹é…ï¼‰ã€‚
- `routingKey="quick.brown.fox"`ã€`routingKey="orange"`ã€`routingKey="quick.orange.male.rabbit"` çš„æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰åŒ¹é…ä»»ä½• bindingKey ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª Topic Exchange çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œç»§ç»­åœ¨ [lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) é¡¹ç›®ã€‚

### 3.2.1 Demo02Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo02Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo02Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo02Message.java

public class Demo02Message implements Serializable {

    public static final String QUEUE = "QUEUE_DEMO_02";

    public static final String EXCHANGE = "EXCHANGE_DEMO_02";

    public static final String ROUTING_KEY = "#.yu.nai";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- åœ¨æ¶ˆæ¯ç±»é‡Œï¼Œæˆ‘ä»¬æšä¸¾äº† Exchangeã€Queueã€RoutingKey çš„åå­—ã€‚
- é‡ç‚¹çœ‹æˆ‘ä»¬æ–°å®šä¹‰çš„è·¯ç”±é”® `ROUTING_KEY = "#.yu.nai"` ï¼Œæˆ‘ä»¬è¦åŒ¹é…ä»¥ `"yu.nai"` ç»“å°¾ï¼Œå¼€å¤´å¯ä»¥æ˜¯ä»»æ„ä¸ªå•è¯çš„ã€‚

### 3.2.2 RabbitConfig

ä¿®æ”¹ [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  Topic Exchange ç¤ºä¾‹ç›¸å…³çš„ Exchangeã€Queueã€Binding çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

/**
 * Topic Exchange ç¤ºä¾‹çš„é…ç½®ç±»
 */
public static class TopicExchangeDemoConfiguration {

    // åˆ›å»º Queue
    @Bean
    public Queue demo02Queue() {
        return new Queue(Demo02Message.QUEUE, // Queue åå­—
                true, // durable: æ˜¯å¦æŒä¹…åŒ–
                false, // exclusive: æ˜¯å¦æ’å®ƒ
                false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    }

    // åˆ›å»º Topic Exchange
    @Bean
    public TopicExchange demo02Exchange() {
        return new TopicExchange(Demo02Message.EXCHANGE,
                true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                false);  // exclusive: æ˜¯å¦æ’å®ƒ
    }

    // åˆ›å»º Binding
    // Exchangeï¼šDemo02Message.EXCHANGE
    // Routing keyï¼šDemo02Message.ROUTING_KEY
    // Queueï¼šDemo02Message.QUEUE
    @Bean
    public Binding demo02Binding() {
        return BindingBuilder.bind(demo02Queue()).to(demo02Exchange()).with(Demo02Message.ROUTING_KEY);
    }

}
```



- åœ¨ TopicExchangeDemoConfiguration å†…éƒ¨é™æ€ç±»ä¸­ï¼Œæˆ‘ä»¬**ä¹Ÿæ˜¯**åˆ›å»ºäº† Exchangeã€Queueã€Binding ä¸‰ä¸ª Bean ã€‚æœ‰å·®å¼‚ç‚¹çš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ [TopicExchange](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/TopicExchange.java) ã€‚

### 3.2.3 Demo02Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo02Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo02Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo02Producer.java

@Component
public class Demo02Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id, String routingKey) {
        // åˆ›å»º Demo02Message æ¶ˆæ¯
        Demo02Message message = new Demo02Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo02Message.EXCHANGE, routingKey, message);
    }

}
```



- å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„ `#syncSend(Integer id)` æ–¹æ³•å¤§ä½“ç›¸ä¼¼ï¼Œå·®å¼‚ç‚¹åœ¨äºæ–°å¢äº†æ–¹æ³•å‚æ•° `routingKey` ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¼ å…¥ä¸åŒçš„è·¯ç”±é”®ã€‚

### 3.2.4 Demo02Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo02Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo02Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_02"` ã€‚

### 3.2.5 ç®€å•æµ‹è¯•

åˆ›å»º [Demo02ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo02ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸¤ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo02Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo02ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo02ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo02Producer producer;

    @Test
    public void testSyncSendSuccess() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id, "da.yu.nai");
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void testSyncSendFailure() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id, "yu.nai.shuai");
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- `#testSyncSendSuccess()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„ RoutingKey æ˜¯ `"da.yu.nai"` ï¼Œå¯ä»¥åŒ¹é…åˆ° `"DEMO_QUEUE_02"` ã€‚
- `#testSyncSendFailure()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„ RoutingKey æ˜¯ `"yu.nai.shuai"` ï¼Œæ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_02"` ã€‚

æˆ‘ä»¬å…ˆæ¥æ‰§è¡Œ `#testSyncSendSuccess()` æ–¹æ³•ï¼Œå¯ä»¥åŒ¹é…åˆ° `"DEMO_QUEUE_02"` çš„æƒ…å†µã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 09:35:54.924  INFO 6894 --- [           main] c.i.s.l.r.producer.Demo02ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575941754] å‘é€æˆåŠŸ]

# Demo02Consumer æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 09:35:54.941  INFO 6894 --- [ntContainer#1-1] c.i.s.l.r.consumer.Demo02Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:19 æ¶ˆæ¯å†…å®¹ï¼šDemo02Message{id=1575941754}]
```



- ç¬¦åˆé¢„æœŸã€‚

æˆ‘ä»¬å†æ¥æ‰§è¡Œ `#testSyncSendFailure()` æ–¹æ³•ï¼Œæ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_02"` çš„æƒ…å†µã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 09:37:11.353  INFO 7186 --- [           main] c.i.s.l.r.producer.Demo02ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575941831] å‘é€æˆåŠŸ]
```



- ç¬¦åˆé¢„æœŸã€‚å› ä¸º æ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_02"` ï¼Œè‡ªç„¶ Demo02Consumer æ— æ³•è¿›è¡Œæ¶ˆè´¹ã€‚

## 3.3 Fanout Exchange

Fanout Exchange è·¯ç”±è§„åˆ™éå¸¸ç®€å•ï¼Œå®ƒä¼šæŠŠæ‰€æœ‰å‘é€åˆ°è¯¥ Exchange çš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸å®ƒç»‘å®šçš„ Queue ä¸­ã€‚å¦‚ä¸‹å›¾ï¼š

![Fanout Exchange](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202303/203b64e17bd9e398cf619acb5df98e6b.png)

- ç”Ÿäº§è€…ï¼ˆPï¼‰å‘é€åˆ° Exchangeï¼ˆXï¼‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè·¯ç”±åˆ°å›¾ä¸­çš„ä¸¤ä¸ª Queueï¼Œå¹¶æœ€ç»ˆè¢«ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ˆC1 ä¸ C2ï¼‰æ¶ˆè´¹ã€‚
- æ€»ç»“æ¥è¯´ï¼ŒæŒ‡å®š Exchange ï¼Œä¼šè·¯ç”±åˆ°**å¤šä¸ª**ç»‘å®šçš„ Queue ä¸­ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª Fanout Exchange çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œç»§ç»­åœ¨ [lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) é¡¹ç›®ã€‚

### 3.3.1 Demo03Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo03Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo03Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo03Message.java

public class Demo03Message implements Serializable {

    public static final String QUEUE_A = "QUEUE_DEMO_03_A";
    public static final String QUEUE_B = "QUEUE_DEMO_03_B";

    public static final String EXCHANGE = "EXCHANGE_DEMO_03";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- æˆ‘ä»¬**æœª**å®šæ„æ€ RoutingKey çš„åå­—ã€‚å› ä¸ºï¼ŒFanout Exchange ä»…éœ€è¦ Exchange å³å¯ã€‚
- æˆ‘ä»¬å®šä¹‰**ä¸¤ä¸ª** Queue çš„åå­—ã€‚å› ä¸ºï¼Œæˆ‘ä»¬è¦æµ‹è¯• Fanout Exchange æŠ•é€’åˆ°å¤šä¸ª Queue çš„æ•ˆæœã€‚

### 3.3.2 RabbitConfig

ä¿®æ”¹ [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  Fanout Exchange ç¤ºä¾‹ç›¸å…³çš„ Exchangeã€Queueã€Binding çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

/**
 * Fanout Exchange ç¤ºä¾‹çš„é…ç½®ç±»
 */
public static class FanoutExchangeDemoConfiguration {

    // åˆ›å»º Queue A
    @Bean
    public Queue demo03QueueA() {
        return new Queue(Demo03Message.QUEUE_A, // Queue åå­—
                true, // durable: æ˜¯å¦æŒä¹…åŒ–
                false, // exclusive: æ˜¯å¦æ’å®ƒ
                false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    }

    // åˆ›å»º Queue B
    @Bean
    public Queue demo03QueueB() {
        return new Queue(Demo03Message.QUEUE_B, // Queue åå­—
                true, // durable: æ˜¯å¦æŒä¹…åŒ–
                false, // exclusive: æ˜¯å¦æ’å®ƒ
                false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    }

    // åˆ›å»º Fanout Exchange
    @Bean
    public FanoutExchange demo03Exchange() {
        return new FanoutExchange(Demo03Message.EXCHANGE,
                true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                false);  // exclusive: æ˜¯å¦æ’å®ƒ
    }

    // åˆ›å»º Binding A
    // Exchangeï¼šDemo03Message.EXCHANGE
    // Queueï¼šDemo03Message.QUEUE_A
    @Bean
    public Binding demo03BindingA() {
        return BindingBuilder.bind(demo03QueueA()).to(demo03Exchange());
    }

    // åˆ›å»º Binding B
    // Exchangeï¼šDemo03Message.EXCHANGE
    // Queueï¼šDemo03Message.QUEUE_B
    @Bean
    public Binding demo03BindingB() {
        return BindingBuilder.bind(demo03QueueB()).to(demo03Exchange());
    }

}
```



- åœ¨ FanoutExchangeDemoConfiguration å†…éƒ¨é™æ€ç±»ä¸­ï¼Œæˆ‘ä»¬**ä¹Ÿæ˜¯**åˆ›å»ºäº† Exchangeã€Queueã€Binding ä¸‰ä¸ª Bean ã€‚æœ‰å·®å¼‚ç‚¹çš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ [FanoutExchange](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/FanoutExchange.java) ã€‚
- åŒæ—¶ï¼Œå› ä¸ºæˆ‘ä»¬è¦æŠ•é€’åˆ°ä¸¤ä¸ª Queue ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ª Binding ã€‚

### 3.3.3 Demo03Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo03Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo03Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo03Producer.java

@Component
public class Demo03Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º Demo03Message æ¶ˆæ¯
        Demo03Message message = new Demo03Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo03Message.EXCHANGE, null, message);
    }

}
```



- å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„ `#syncSend(Integer id)` æ–¹æ³•å¤§ä½“ç›¸ä¼¼ï¼Œå·®å¼‚ç‚¹åœ¨äºä¼ å…¥ `routingKey = null` ï¼Œå› ä¸ºä¸éœ€è¦ã€‚

### 3.3.4 Demo03Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo03ConsumerA](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo03ConsumerA.java) å’Œ [Demo03ConsumerB](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo03ConsumerB.java) **ä¸¤ä¸ª**ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo03ConsumerA.java
@Component
@RabbitListener(queues = Demo03Message.QUEUE_A)
public class Demo03ConsumerA {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo03Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}

// Demo03ConsumerB.java
@Component
@RabbitListener(queues = Demo03Message.QUEUE_B)
public class Demo03ConsumerB {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo03Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œåˆ†åˆ«æ¶ˆè´¹ `"QUEUE_DEMO_03_A"`ã€`"QUEUE_DEMO_03_B"` é˜Ÿåˆ—ã€‚

### 3.3.5 ç®€å•æµ‹è¯•

åˆ›å»º [Demo03ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo03ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo03Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo03ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo03ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo03Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æˆ‘ä»¬å…ˆæ¥æ‰§è¡Œ `#testSyncSend()` æ–¹æ³•ï¼Œç¡®è®¤ä¸‹ Fanout Exchange çš„æ•ˆæœã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 13:42:51.794  INFO 50616 --- [           main] c.i.s.l.r.producer.Demo03ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575956571] å‘é€æˆåŠŸ]

# Demo03ConsumerA æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 13:42:51.811  INFO 50616 --- [ntContainer#2-1] c.i.s.l.r.consumer.Demo03ConsumerA       : [onMessage][çº¿ç¨‹ç¼–å·:22 æ¶ˆæ¯å†…å®¹ï¼šDemo03Message{id=1575956571}]

# Demo03ConsumerB ä¹ŸæˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 13:42:51.811  INFO 50616 --- [ntContainer#3-1] c.i.s.l.r.consumer.Demo03ConsumerB       : [onMessage][çº¿ç¨‹ç¼–å·:24 æ¶ˆæ¯å†…å®¹ï¼šDemo03Message{id=1575956571}]
```



- ç¬¦åˆé¢„æœŸã€‚
- å‘é€çš„æ¶ˆæ¯ï¼ŒæˆåŠŸæŠ•é€’åˆ°äº†ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥è¢«ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½æ¶ˆè´¹åˆ°äº†ã€‚

## 3.4 Headers Exchange

Headers Exchange ä¸ä¾èµ–äº routing key ä¸ binding key çš„åŒ¹é…è§„åˆ™æ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„ headers å±æ€§è¿›è¡ŒåŒ¹é…ã€‚

- åœ¨ç»‘å®š Queue ä¸ Exchange æ—¶æŒ‡å®šä¸€ç»„ headers é”®å€¼å¯¹ã€‚
- å½“æ¶ˆæ¯å‘é€åˆ° Exchange æ—¶ï¼ŒRabbitMQ ä¼šå–åˆ°è¯¥æ¶ˆæ¯çš„ headersï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„å½¢å¼ï¼‰ï¼Œå¯¹æ¯”å…¶ä¸­çš„é”®å€¼å¯¹æ˜¯å¦å®Œå…¨åŒ¹é… Queue ä¸ Exchange ç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹ï¼›å¦‚æœå®Œå…¨åŒ¹é…åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥ Queue ï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±åˆ°è¯¥ Queue ã€‚

ä¸è¿‡è‰¿è‰¿åœ¨æŸ¥è¯¢èµ„æ–™çš„æ—¶å€™ï¼Œæœ‰èµ„æ–™è¯´ Headers Exchange æ€§èƒ½å¾ˆå·®ï¼Œå®é™…åœºæ™¯ä¹Ÿä½¿ç”¨æ¯”è¾ƒå°‘ã€‚æ‰€ä»¥æœ¬å°èŠ‚çš„å†…å®¹ï¼Œèƒ–å‹å¯ä»¥é€‰æ‹©æ€§çœ‹ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª Headers Exchange çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œç»§ç»­åœ¨ [lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) é¡¹ç›®ã€‚

### 3.4.1 Demo04Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo04Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo04Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo03Message.java

public class Demo04Message implements Serializable {

    public static final String QUEUE = "QUEUE_DEMO_04_A";

    public static final String EXCHANGE = "EXCHANGE_DEMO_04";

    public static final String HEADER_KEY = "color";
    public static final String HEADER_VALUE = "red";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- æˆ‘ä»¬**æœª**å®šæ„æ€ RoutingKey çš„åå­—ã€‚å› ä¸ºï¼ŒHeaders Exchange æ˜¯é€šè¿‡ Exchange + Headers çš„ç»„åˆã€‚
- æˆ‘ä»¬å®šä¹‰**ä¸€ä¸ª** Headers é”®å€¼å¯¹ï¼Œ`color = red` ã€‚

### 3.4.2 RabbitConfig

ä¿®æ”¹ [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  Headers Exchange ç¤ºä¾‹ç›¸å…³çš„ Exchangeã€Queueã€Binding çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

/**
 * Headers Exchange ç¤ºä¾‹çš„é…ç½®ç±»
 */
public static class HeadersExchangeDemoConfiguration {

    // åˆ›å»º Queue
    @Bean
    public Queue demo04Queue() {
        return new Queue(Demo04Message.QUEUE, // Queue åå­—
                true, // durable: æ˜¯å¦æŒä¹…åŒ–
                false, // exclusive: æ˜¯å¦æ’å®ƒ
                false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    }

    // åˆ›å»º Headers Exchange
    @Bean
    public HeadersExchange demo04Exchange() {
        return new HeadersExchange(Demo04Message.EXCHANGE,
                true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                false);  // exclusive: æ˜¯å¦æ’å®ƒ
    }

    // åˆ›å»º Binding
    // Exchangeï¼šDemo04Message.EXCHANGE
    // Queueï¼šDemo04Message.QUEUE
    // Headers: Demo04Message.HEADER_KEY + Demo04Message.HEADER_VALUE
    @Bean
    public Binding demo4Binding() {
        return BindingBuilder.bind(demo04Queue()).to(demo04Exchange())
                .where(Demo04Message.HEADER_KEY).matches(Demo04Message.HEADER_VALUE); // é…ç½® Headers åŒ¹é…
    }

}
```



- åœ¨ TopicExchangeDemoConfiguration å†…éƒ¨é™æ€ç±»ä¸­ï¼Œæˆ‘ä»¬**ä¹Ÿæ˜¯**åˆ›å»ºäº† Exchangeã€Queueã€Binding ä¸‰ä¸ª Bean ã€‚æœ‰å·®å¼‚ç‚¹çš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ [HeadersExchange](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/HeadersExchange.java) ã€‚
- åŒæ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ Binding æ˜¯åŸºäº Headers åŒ¹é…ã€‚

### 3.4.3 Demo04Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo04Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo04Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo02Producer.java

@Component
public class Demo04Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id, String headerValue) {
        // åˆ›å»º MessageProperties å±æ€§
        MessageProperties messageProperties = new MessageProperties();
        messageProperties.setHeader(Demo04Message.HEADER_KEY, headerValue); // è®¾ç½® header
        // åˆ›å»º Message æ¶ˆæ¯
        Message message = rabbitTemplate.getMessageConverter().toMessage(
                new Demo04Message().setId(id), messageProperties);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.send(Demo04Message.EXCHANGE, null, message);
    }

}
```



- å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„ `#syncSend(Integer id)` æ–¹æ³•å¤§ä½“ç›¸ä¼¼ï¼Œå·®å¼‚ç‚¹åœ¨äºæ–°å¢äº†æ–¹æ³•å‚æ•° `headerValue` ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¼ å…¥ä¸åŒçš„ Headers å€¼ã€‚
- å› ä¸º RabbitTemplate ä¼šæä¾›å¾ˆæ–¹ä¾¿çš„ä¼ é€’ Headers çš„ API æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªå¥½è‡ªå·±æ„å»ºï¼Œå½“ç„¶ä¹Ÿæ¯”è¾ƒç®€å•å“ˆã€‚

### 3.4.4 Demo04Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo04Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo04Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_04"` ã€‚

### 3.4.5 ç®€å•æµ‹è¯•

åˆ›å»º [Demo04ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo04ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸¤ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo04Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo04ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo04ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo04Producer producer;

    @Test
    public void testSyncSendSuccess() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id, Demo04Message.HEADER_VALUE);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void testSyncSendFailure() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id, "error");
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- `#testSyncSendSuccess()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„ Headers çš„å€¼ `"red"` ï¼Œå¯ä»¥åŒ¹é…åˆ° `"DEMO_QUEUE_04"` ã€‚
- `#testSyncSendFailure()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„ Headers çš„å€¼ `"error"` ï¼Œæ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_04"` ã€‚

æˆ‘ä»¬å…ˆæ¥æ‰§è¡Œ `#testSyncSendSuccess()` æ–¹æ³•ï¼Œå¯ä»¥åŒ¹é…åˆ° `"DEMO_QUEUE_04"` çš„æƒ…å†µã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 14:30:05.872  INFO 61498 --- [           main] c.i.s.l.r.producer.Demo04ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575959405] å‘é€æˆåŠŸ]

# Demo04Consumer æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
2019-12-15 14:30:05.888  INFO 61498 --- [ntContainer#4-1] c.i.s.l.r.consumer.Demo04Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:25 æ¶ˆæ¯å†…å®¹ï¼šDemo04Message{id=1575959405}]
```



- ç¬¦åˆé¢„æœŸã€‚

æˆ‘ä»¬å†æ¥æ‰§è¡Œ `#testSyncSendFailure()` æ–¹æ³•ï¼Œæ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_04"` çš„æƒ…å†µã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 14:30:47.090  INFO 61664 --- [           main] c.i.s.l.r.producer.Demo04ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575959447] å‘é€æˆåŠŸ]
```



- ç¬¦åˆé¢„æœŸã€‚å› ä¸º æ— æ³•åŒ¹é…åˆ° `"DEMO_QUEUE_04"` ï¼Œè‡ªç„¶ Demo04Consumer æ— æ³•è¿›è¡Œæ¶ˆè´¹ã€‚