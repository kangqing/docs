# 9. æ¶ˆæ¯æ¨¡å¼

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-message-model](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model)

åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæœ‰ä¸¤ç§ç»å…¸çš„æ¶ˆæ¯æ¨¡å¼ï¼šã€Œç‚¹å¯¹ç‚¹ã€å’Œã€Œå‘å¸ƒè®¢é˜…ã€ã€‚å…·ä½“çš„æ¦‚å¿µï¼Œè‰¿è‰¿å°±å…ˆä¸è§£é‡Šï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹[ã€Šæ¶ˆæ¯é˜Ÿåˆ—ä¸¤ç§æ¨¡å¼ï¼šç‚¹å¯¹ç‚¹ä¸å‘å¸ƒè®¢é˜…ã€‹](http://www.iocoder.cn/Fight/There-are-two-modes-of-message-queuing-point-to-point-and-publish-subscription/?self)æ–‡ç« ã€‚

å¦‚æœèƒ–å‹æœ‰ä½¿ç”¨è¿‡ RocketMQ æˆ–è€… Kafka æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯èƒ½æ¯”è¾ƒä¹ æƒ¯çš„å«æ³•æ˜¯ï¼š

> **é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰**ï¼šå¯¹åº”ã€Œç‚¹å¯¹ç‚¹ã€ é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ã€‚
>
> **å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰**ï¼šå¯¹åº”ã€Œå‘å¸ƒè®¢é˜…ã€ å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯ã€‚

ğŸ˜ˆ è€ƒè™‘åˆ°è‰¿è‰¿è‡ªå·±çš„ä¹ æƒ¯ï¼Œä¸‹æ–‡æˆ‘ä»¬ç»Ÿä¸€é‡‡ç”¨é›†ç¾¤æ¶ˆè´¹å’Œå¹¿æ’­æ¶ˆè´¹å«æ³•ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨[ã€Œ9.1 é›†ç¾¤æ¶ˆè´¹ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å’Œ[ã€Œ9.2 å¹¿æ’­æ¶ˆè´¹ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„ç¤ºä¾‹ä»£ç ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-message-model](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model) é¡¹ç›®ã€‚

## 9.1 é›†ç¾¤æ¶ˆè´¹

åœ¨ RabbitMQ ä¸­ï¼Œå¦‚æœå¤šä¸ª Consumer è®¢é˜…ç›¸åŒçš„ Queue ï¼Œé‚£ä¹ˆæ¯ä¸€æ¡æ¶ˆæ¯æœ‰ä¸”ä»…ä¼šè¢«ä¸€ä¸ª Consumer æ‰€æ¶ˆè´¹ã€‚è¿™ä¸ªç‰¹æ€§ï¼Œå°±ä¸ºæˆ‘ä»¬å®ç°é›†ç¾¤æ¶ˆè´¹æä¾›äº†åŸºç¡€ã€‚

åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠä¸€ä¸ª Queue ä½œä¸ºä¸€ä¸ª Consumer Group ï¼ŒåŒæ—¶åˆ›å»ºæ¶ˆè´¹è¯¥ Queue çš„ Consumer ã€‚è¿™æ ·ï¼Œåœ¨æˆ‘ä»¬å¯åŠ¨å¤šä¸ª JVM è¿›ç¨‹æ—¶ï¼Œå°±ä¼šæœ‰å¤šä¸ª Consumer æ¶ˆè´¹è¯¥ Queue ï¼Œä»è€Œå®ç°é›†ç¾¤æ¶ˆè´¹çš„æ•ˆæœã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬å¼€å§‹é›†ç¾¤æ¶ˆè´¹çš„ç¤ºä¾‹ã€‚

### 9.1.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/pom.xml) æ–‡ä»¶ã€‚

### 9.1.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

### 9.1.3 ClusteringMessage

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [ClusteringMessage](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/ClusteringMessage.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ClusteringMessage.java

public class ClusteringMessage implements Serializable {

    public static final String QUEUE = "QUEUE_CLUSTERING";

    public static final String EXCHANGE = "EXCHANGE_CLUSTERING";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å®šä¹‰ RoutingKey çš„æšä¸¾ï¼Œç­”æ¡ˆæˆ‘ä»¬åœ¨[ã€Œ9.1.6 ClusteringConsumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ­æ™“ã€‚

### 9.1.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ é›†ç¾¤æ¶ˆè´¹éœ€è¦çš„ Exchange çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * é›†ç¾¤æ¶ˆè´¹çš„ç¤ºä¾‹çš„é…ç½®
     */
    public static class ClusteringConfiguration {

        // åˆ›å»º Topic Exchange
        @Bean
        public TopicExchange clusteringExchange() {
            return new TopicExchange(ClusteringMessage.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

    }

}
```



- åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº† Exchange ç±»å‹æ˜¯ **Topic** ã€‚

ä¸ºä»€ä¹ˆä¸é€‰æ‹© Exchange ç±»å‹æ˜¯ **Direct** å‘¢ï¼Ÿè€ƒè™‘åˆ°é›†ç¾¤æ¶ˆè´¹çš„æ¨¡å¼ï¼Œä¼šå­˜åœ¨å¤š Consumer Group æ¶ˆè´¹çš„æƒ…å†µï¼Œæ˜¾ç„¶æˆ‘ä»¬è¦æ”¯æŒä¸€æ¡æ¶ˆæ¯æŠ•é€’åˆ°å¤šä¸ª Queue ä¸­ï¼Œæ‰€ä»¥ Direct Exchange åŸºæœ¬å°±è¢«æ’é™¤äº†ã€‚

ä¸ºä»€ä¹ˆä¸é€‰æ‹© Exchange ç±»å‹æ˜¯ **Fanout** æˆ–è€… **Headers** å‘¢ï¼Ÿå®é™…æ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡è¯¢é—®äº†æœ‹å‹(didi) [Spring Cloud Stream RabbitMQ](https://github.com/spring-cloud/spring-cloud-stream-binder-rabbit) æ˜¯æ€ä¹ˆå®ç°çš„ã€‚å¾—çŸ¥ç­”æ¡ˆæ˜¯[é»˜è®¤](https://raw.githubusercontent.com/spring-cloud/spring-cloud-stream-binder-rabbit/master/docs/src/main/asciidoc/images/rabbit-binder.png)æ˜¯ä½¿ç”¨ Topic Exchange çš„ï¼Œæ‰€ä»¥è‰¿è‰¿ç¤ºä¾‹è¿™é‡Œä¹Ÿå°±ä½¿ç”¨ Topic Exchange ç±»å‹äº†ã€‚

### 9.1.5 ClusteringProducer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [ClusteringProducer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/ClusteringProducer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ClusteringProducer.java

@Component
public class ClusteringProducer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º ClusteringMessage  æ¶ˆæ¯
        ClusteringMessage message = new ClusteringMessage();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(ClusteringMessage.EXCHANGE, null, message);
    }

}
```



- å’Œ[ã€Œ3.2.3 Demo02Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œé™¤äº†è°ƒç”¨ RabbitTemplate å‘é€æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬ä¼ é€’çš„ `routingKey` å‚æ•°ä¸º `null` ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæˆ‘ä»¬ä¹Ÿåœ¨[ã€Œ9.1.6 ClusteringConsumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ­æ™“ã€‚

### 9.1.6 ClusteringConsumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [ClusteringConsumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/ClusteringConsumer.java) ç±»ï¼Œ**é›†ç¾¤**æ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ClusteringConsumer.java

@Component
@RabbitListener(
        bindings = @QueueBinding(
                value = @Queue(
                        name = ClusteringMessage.QUEUE + "-" + "GROUP-01"
                ),
                exchange = @Exchange(
                        name = ClusteringMessage.EXCHANGE,
                        type = ExchangeTypes.TOPIC,
                        declare = "false"
                ),
                key = "#"
        )
)
public class ClusteringConsumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(ClusteringMessage message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- ç›¸æ¯”å…¶å®ƒ Consumer ç¤ºä¾‹æ¥è¯´ï¼Œè¿™é‡Œæ·»åŠ çš„ `@RabbitListener` æ³¨è§£å¤æ‚å¾ˆå¤šã€‚

- åœ¨ `bindings` å±æ€§ï¼Œæˆ‘ä»¬æ·»åŠ äº† [`@QueueBinding`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/QueueBinding.java) æ³¨è§£ï¼Œæ¥å®šä¹‰äº†ä¸€ä¸ª Binding ã€‚é€šè¿‡ `key` å±æ€§ï¼Œè®¾ç½®ä½¿ç”¨çš„ RoutingKey ä¸º `#` ï¼Œ**åŒ¹é…æ‰€æœ‰**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨[ã€Œ9.1.3 ClusteringMessageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æœªå®šä¹‰ RoutingKey ï¼Œä»¥åŠåœ¨[ã€Œ9.1.5 ClusteringProducerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸­ä½¿ç”¨ `routingKey = null` çš„åŸå› ã€‚

- åœ¨

   

  ```
  exchange
  ```

   

  å±æ€§ï¼Œæˆ‘ä»¬æ·»åŠ äº†

   

  `@Exchange`

   

  æ³¨è§£ï¼Œè®¾ç½®äº†å¯¹åº”

   

  ```
  EXCHANGE_CLUSTERING
  ```

   

  è¿™ä¸ª Exchange ã€‚

  - `type` å±æ€§ï¼Œè®¾ç½®æ˜¯ TopicExchange ã€‚
  - `declare` å±æ€§ï¼Œå› ä¸º[ã€Œ9.1.4 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸­ï¼Œå·²ç»é…ç½®åˆ›å»ºè¿™ä¸ª Exchange äº†ã€‚

- åœ¨ `value` å±æ€§ï¼Œæˆ‘ä»¬æ·»åŠ äº† [`@Queue`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/Queue.java) æ³¨è§£ï¼Œè®¾ç½®æ¶ˆè´¹ `QUEUE_CLUSTERING-GROUP-01` è¿™ä¸ª Queue çš„æ¶ˆæ¯ã€‚

æ³¨æ„ï¼Œé€šè¿‡æ·»åŠ  `@Exchange`ã€`@Queue`ã€`@QueueBinding` æ³¨è§£ï¼Œå¦‚æœæœªå£°æ˜ `declare="false"` æ—¶ï¼Œä¼š**è‡ªåŠ¨åˆ›å»ºå¯¹åº”**çš„ Exchangeã€Queueã€Binding ã€‚

### 9.1.7 ç®€å•æµ‹è¯•

åˆ›å»º [ClusteringProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/ClusteringProducerTest.java) æµ‹è¯•ç±»ï¼Œç”¨äºæµ‹è¯•é›†ç¾¤æ¶ˆè´¹ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ClusteringProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class ClusteringProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private ClusteringProducer producer;

    @Test
    public void mock() throws InterruptedException {
        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void testSyncSend() throws InterruptedException {
        // å‘é€ 3 æ¡æ¶ˆæ¯
        for (int i = 0; i < 3; i++) {
            int id = (int) (System.currentTimeMillis() / 1000);
            producer.syncSend(id);
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);
        }

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



é¦–å…ˆï¼Œæ‰§è¡Œ `#mock()` æµ‹è¯•æ–¹æ³•ï¼Œå…ˆå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹ `"QUEUE_CLUSTERING-GROUP-01"` è¿™ä¸ª Queue çš„ Consumer èŠ‚ç‚¹ã€‚

ç„¶åï¼Œæ‰§è¡Œ `#testSyncSend()` æµ‹è¯•æ–¹æ³•ï¼Œå†å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹ `"QUEUE_CLUSTERING-GROUP-01"` è¿™ä¸ª Queue çš„ Consumer èŠ‚ç‚¹ã€‚åŒæ—¶ï¼Œè¯¥æµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ `ClusteringProducer#syncSend(id)` æ–¹æ³•ï¼ŒåŒæ­¥å‘é€äº† 3 æ¡æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// #### testSyncSend æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####

# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
2019-12-15 22:13:44.372  INFO 43363 --- [           main] c.i.s.l.r.p.ClusteringProducerTest       : [testSyncSend][å‘é€ç¼–å·ï¼š[1576073624] å‘é€æˆåŠŸ]
2019-12-15 22:13:44.373  INFO 43363 --- [           main] c.i.s.l.r.p.ClusteringProducerTest       : [testSyncSend][å‘é€ç¼–å·ï¼š[1576073624] å‘é€æˆåŠŸ]
2019-12-15 22:13:44.374  INFO 43363 --- [           main] c.i.s.l.r.p.ClusteringProducerTest       : [testSyncSend][å‘é€ç¼–å·ï¼š[1576073624] å‘é€æˆåŠŸ]

# ClusteringConsumer æ¶ˆè´¹äº† 1 æ¡æ¶ˆæ¯
2019-12-15 22:13:44.393  INFO 43363 --- [ntContainer#1-1] c.i.s.l.r.consumer.ClusteringConsumer    : [onMessage][çº¿ç¨‹ç¼–å·:19 æ¶ˆæ¯å†…å®¹ï¼šClusteringtMessage{id=1576073624}]

// ### mock æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####

# ClusteringConsumer æ¶ˆè´¹äº† 2 æ¡æ¶ˆæ¯
2019-12-15 22:13:44.396  INFO 43308 --- [ntContainer#1-1] c.i.s.l.r.consumer.ClusteringConsumer    : [onMessage][çº¿ç¨‹ç¼–å·:19 æ¶ˆæ¯å†…å®¹ï¼šClusteringtMessage{id=1576073624}]
2019-12-15 22:13:44.398  INFO 43308 --- [ntContainer#1-1] c.i.s.l.r.consumer.ClusteringConsumer    : [onMessage][çº¿ç¨‹ç¼–å·:19 æ¶ˆæ¯å†…å®¹ï¼šClusteringtMessage{id=1576073624}]
```



- 3 æ¡æ¶ˆæ¯ï¼Œéƒ½ä»…è¢« **ä¸¤ä¸ª** Consumer èŠ‚ç‚¹çš„**ä¸€ä¸ª**è¿›è¡Œæ¶ˆè´¹ã€‚ç¬¦åˆé›†ç¾¤æ¶ˆè´¹çš„é¢„æœŸ~

å› ä¸ºè€ƒè™‘è®©é›†ç¾¤æ¶ˆè´¹çš„ç¤ºä¾‹åšçš„æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¹¶æœªæä¾›ä¸€æ¡æ¶ˆæ¯æŠ•é€’åˆ°å¤šä¸ª Queue ä¸­ï¼Œä»è€Œå®ç°å¤šé›†ç¾¤ä¸‹çš„é›†ç¾¤æ¶ˆè´¹çš„æ•ˆæœã€‚ä¸è¿‡æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹å¯ä»¥è‡ªè¡Œåœ¨åˆ›å»ºä¸€ä¸ªç±»ä¼¼[ã€Œ9.1.6 ClusteringConsumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„æ¶ˆè´¹è€…ç±»ï¼Œè®¾ç½®æ¶ˆè´¹å¦å¤–ä¸€ä¸ª Queue å³å¯ã€‚ä¾‹å¦‚è¯´ï¼š



```
@Component
@RabbitListener(
        bindings = @QueueBinding(
                value = @Queue(
                        name = ClusteringMessage.QUEUE + "-" + "GROUP-02" // è¿™é‡Œä» "GROUP-01" æ”¹æˆäº† "GROUP-02" ã€‚
                ),
                exchange = @Exchange(
                        name = ClusteringMessage.EXCHANGE,
                        type = ExchangeTypes.TOPIC,
                        declare = "false"
                ),
                key = "#"
        )
)
```



## 9.2 å¹¿æ’­æ¶ˆè´¹

åœ¨[ã€Œ9.1 é›†ç¾¤æ¶ˆè´¹ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡â€œåœ¨ RabbitMQ ä¸­ï¼Œå¦‚æœå¤šä¸ª Consumer è®¢é˜…ç›¸åŒçš„ Queue ï¼Œé‚£ä¹ˆæ¯ä¸€æ¡æ¶ˆæ¯æœ‰ä¸”ä»…ä¼šè¢«ä¸€ä¸ª Consumer æ‰€æ¶ˆè´¹â€ç‰¹æ€§ï¼Œæ¥å®ç°äº†é›†ç¾¤æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨å®ç°å¹¿æ’­æ¶ˆè´¹æ—¶ï¼Œè¿™ä¸ªç‰¹æ€§æ°æ°æˆä¸ºäº†ä¸€ç§é˜»ç¢ã€‚

ä¸è¿‡æœºæ™ºçš„æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™æ¯ä¸ª Consumer åˆ›å»ºä¸€ä¸ªå…¶**ç‹¬æœ‰** Queue ï¼Œä»è€Œä¿è¯éƒ½èƒ½æ¥æ”¶åˆ°å…¨é‡çš„æ¶ˆæ¯ã€‚åŒæ—¶ï¼ŒRabbitMQ æ”¯æŒé˜Ÿåˆ—çš„è‡ªåŠ¨åˆ é™¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ Consumer å…³é—­çš„æ—¶å€™ï¼Œé€šè¿‡è¯¥åŠŸèƒ½åˆ é™¤å…¶**ç‹¬æœ‰**çš„ Queue ã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬å¼€å§‹é›†ç¾¤æ¶ˆè´¹çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ç®€ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ç»§ç»­åœ¨ [lab-04-rabbitmq-demo](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo) é¡¹ç›®æ”¹é€ ã€‚

### 9.2.1 BroadcastMessage

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [BroadcastMessage](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/BroadcastMessage.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// BroadcastMessage.java

public class BroadcastMessage implements Serializable {

    public static final String QUEUE = "QUEUE_BROADCASTING";

    public static final String EXCHANGE = "EXCHANGE_BROADCASTING";

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- å’Œ[ã€Œ9.1.3 ClusteringMessageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Queue å’Œ Exchange çš„åå­—ä¸åŒã€‚

### 9.2.2 RabbitConfig

ä¿®æ”¹ [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„ [SimpleRabbitListenerContainerFactory](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/config/SimpleRabbitListenerContainerFactory.java) Bean ï¼Œæ·»åŠ å¹¿æ’­æ¶ˆè´¹éœ€è¦çš„ Exchange çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

/**
 * å¹¿æ’­æ¶ˆè´¹çš„ç¤ºä¾‹çš„é…ç½®
 */
public static class BroadcastingConfiguration {

    // åˆ›å»º Topic Exchange
    @Bean
    public TopicExchange broadcastingExchange() {
        return new TopicExchange(BroadcastMessage.EXCHANGE,
                true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                false);  // exclusive: æ˜¯å¦æ’å®ƒ
    }

}
```



- å’Œ[ã€Œ9.1.4 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„ ClusteringConfiguration é…ç½®ç±»æ˜¯ä¸€è‡´ï¼Œåªæ˜¯åˆ›å»ºäº†ä¸åŒçš„ Exchange ã€‚

### 9.2.3 BroadcastProducer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [BroadcastProducer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/BroadcastProducer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// BroadcastProducer.java

@Component
public class BroadcastProducer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º BroadcastMessage æ¶ˆæ¯
        BroadcastMessage message = new BroadcastMessage();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(BroadcastMessage.EXCHANGE, null, message);
    }

}
```



- å’Œ[ã€Œ9.1.5 ClusteringProducerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ˜¯ä¸€è‡´ï¼Œåªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„ Exchange å’Œæ¶ˆæ¯ã€‚

### 9.2.4 BroadcastConsumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [BroadcastConsumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/ClusteringConsumer.java) ç±»ï¼Œ**å¹¿æ’­**æ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// BroadcastConsumer.java

@Component
@RabbitListener(
        bindings = @QueueBinding(
                value = @Queue(
                        name = BroadcastMessage.QUEUE + "-" + "#{T(java.util.UUID).randomUUID()}",
                        autoDelete = "true"
                ),
                exchange = @Exchange(
                        name = BroadcastMessage.EXCHANGE,
                        type = ExchangeTypes.TOPIC,
                        declare = "false"
                )
        )
)
public class BroadcastConsumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(BroadcastMessage message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- æ€»ä½“å’Œ[ã€Œ9.1.6 ClusteringConsumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ˜¯ä¸€è‡´ï¼Œä¸»è¦å·®å¼‚åœ¨ä¸¤ç‚¹ã€‚
- ç¬¬ä¸€ç‚¹ï¼Œåœ¨ `@Queue` æ³¨è§£çš„ `name` å±æ€§ï¼Œæˆ‘ä»¬é€šè¿‡ Spring EL è¡¨è¾¾å¼ï¼Œåœ¨ Queue çš„åå­—ä¸Šï¼Œä½¿ç”¨ UUID ç”Ÿæˆå…¶åç¼€ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½ä¿è¯æ¯ä¸ªé¡¹ç›®å¯åŠ¨çš„ Consumer çš„ Queue ä¸åŒï¼Œä»¥è¾¾åˆ°å¹¿æ’­æ¶ˆè´¹çš„ç›®çš„ã€‚
- ç¬¬äºŒç‚¹ï¼Œåœ¨ `@Queue` æ³¨è§£çš„ `autoDelete` å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®ä¸º `"true"` ï¼Œè¿™æ ·åœ¨ Consumer å…³é—­æ—¶ï¼Œè¯¥é˜Ÿåˆ—å°±å¯ä»¥è¢«è‡ªåŠ¨åˆ é™¤äº†ã€‚

### 9.2.5 ç®€å•æµ‹è¯•

åˆ›å»º [BroadcastProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-message-model/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/BroadcastProducerTest.java) æµ‹è¯•ç±»ï¼Œç”¨äºæµ‹è¯•å¹¿æ’­æ¶ˆè´¹ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// BroadcastProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class BroadcastProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private BroadcastProducer producer;

    @Test
    public void mock() throws InterruptedException {
        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



é¦–å…ˆï¼Œæ‰§è¡Œ `#mock()` æµ‹è¯•æ–¹æ³•ï¼Œå…ˆå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹ `"QUEUE_BROADCAST-${UUID1}"` è¿™ä¸ª Queue çš„ Consumer èŠ‚ç‚¹ã€‚

ç„¶åï¼Œæ‰§è¡Œ `#testSyncSend()` æµ‹è¯•æ–¹æ³•ï¼Œå†å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹ `"QUEUE_BROADCAST-${UUID2}"` è¿™ä¸ª Queue çš„ Consumer èŠ‚ç‚¹ã€‚åŒæ—¶ï¼Œè¯¥æµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ `BroadcastProducer#syncSend(id)` æ–¹æ³•ï¼ŒåŒæ­¥å‘é€äº† 3 æ¡æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// #### testSyncSend æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####

# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
2019-12-15 00:11:41.459  INFO 64479 --- [           main] c.i.s.l.r.p.BroadcastProducerTest        : [testSyncSend][å‘é€ç¼–å·ï¼š[1576080701] å‘é€æˆåŠŸ]
2019-12-15 00:11:41.460  INFO 64479 --- [           main] c.i.s.l.r.p.BroadcastProducerTest        : [testSyncSend][å‘é€ç¼–å·ï¼š[1576080701] å‘é€æˆåŠŸ]
2019-12-15 00:11:41.461  INFO 64479 --- [           main] c.i.s.l.r.p.BroadcastProducerTest        : [testSyncSend][å‘é€ç¼–å·ï¼š[1576080701] å‘é€æˆåŠŸ]

# BroadcastConsumer æ¶ˆè´¹äº† 3 æ¡æ¶ˆæ¯
2019-12-15 00:11:41.478  INFO 64479 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]
2019-12-15 00:11:41.479  INFO 64479 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]
2019-12-15 00:11:41.480  INFO 64479 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]

// ### mock æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####

# BroadcastConsumer ä¹Ÿæ¶ˆè´¹äº† 3 æ¡æ¶ˆ
2019-12-15 00:11:41.460  INFO 63795 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]
2019-12-15 00:11:41.462  INFO 63795 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]
2019-12-15 00:11:41.462  INFO 63795 --- [ntContainer#0-1] c.i.s.l.r.consumer.BroadcastConsumer     : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šBroadcastMessage{id=1576080701}]
```



- **ä¸¤ä¸ª** Consumer èŠ‚ç‚¹ï¼Œéƒ½æ¶ˆè´¹äº†è¿™æ¡å‘é€çš„æ¶ˆæ¯ã€‚ç¬¦åˆå¹¿æ’­æ¶ˆè´¹çš„é¢„æœŸ~