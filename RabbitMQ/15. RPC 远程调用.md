# 15. RPC è¿œç¨‹è°ƒç”¨

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-rpc](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc) ã€‚

åœ¨ RabbitMQ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ [Direct Reply-to](https://www.rabbitmq.com/direct-reply-to.html) ç‰¹æ€§ï¼Œå®ç° RPC è¿œç¨‹è°ƒç”¨çš„åŠŸèƒ½ã€‚å…·ä½“çš„å®ç°åŸç†ï¼Œèƒ–å‹è‡ªå·±çœ‹[ã€ŠRabbitMQ ä¹‹ RPC å®ç°ã€‹](http://www.iocoder.cn/RabbitMQ/RPC-implementation/?self)æ–‡ç« ï¼Œè¿™é‡Œè‰¿è‰¿å°±ä¸èµ˜è¿°äº†ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ª RPC çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-rpc](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc) é¡¹ç›®ã€‚

## 15.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/pom.xml) æ–‡ä»¶ã€‚

## 15.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo14ProducerTest.java) æ–‡ä»¶ã€‚

## 15.3 Demo14Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo14Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo14Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 15.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  Direct Exchange ç¤ºä¾‹ç›¸å…³çš„ Exchangeã€Queueã€Binding çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo01Queue() {
            return new Queue(Demo14Message.QUEUE, // Queue åå­—
                    false, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo01Exchange() {
            return new DirectExchange(Demo14Message.EXCHANGE,
                    false,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo01Message.EXCHANGE
        // Routing keyï¼šDemo01Message.ROUTING_KEY
        // Queueï¼šDemo01Message.QUEUE
        @Bean
        public Binding demo01Binding() {
            return BindingBuilder.bind(demo01Queue()).to(demo01Exchange()).with(Demo14Message.ROUTING_KEY);
        }

    }

}
```



- ä¸åŒäº[ã€Œ3.1.5 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„é…ç½®ï¼Œæˆ‘ä»¬è®¾ç½®é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯æ— éœ€æŒä¹…åŒ–ï¼Œæ¯•ç«Ÿ RPC æ˜¯ä¸ªç¬æ€æ“ä½œã€‚

## 15.5 Demo14Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo14Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo14Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç° RPC æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo14Producer.java

@Component
public class Demo14Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public String syncSend(Integer id) {
        // åˆ›å»º Demo01Message æ¶ˆæ¯
        Demo14Message message = new Demo14Message();
        message.setId(id);
        // <1> åˆ›å»º CorrelationData å¯¹è±¡
        CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
        // <2> åŒæ­¥å‘é€æ¶ˆæ¯ï¼Œå¹¶æ¥æ”¶ç»“æœ
        return (String) rabbitTemplate.convertSendAndReceive(Demo14Message.EXCHANGE, Demo14Message.ROUTING_KEY, message,
                correlationData);
    }

}
```



- `<1>` å¤„ï¼Œåˆ›å»º CorrelationData å¯¹è±¡ï¼Œä½¿ç”¨ UUID ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚
- `<2>` å¤„ï¼Œè°ƒç”¨ `RabbitTemplate#convertSendAndReceive(exchange, routingKey, message, correlationData)` æ–¹æ³•ï¼ŒProducer å‘é€æ¶ˆæ¯ï¼Œå¹¶ç­‰å¾…ç»“æœã€‚è¯¥ç»“æœï¼Œæ˜¯ Consumer æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¿”å›çš„ç»“æœã€‚

## 15.6 Demo14Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo14Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo14Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo14Consumer.java

@Component
@RabbitListener(queues = Demo14Message.QUEUE)
public class Demo14Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public String onMessage(Demo14Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        // è¿”å›ç»“æœ
        return "nicai";
    }

}
```



- æ¶ˆè´¹å®Œæˆåï¼Œé¢å¤–è¿”å›äº† `"nicai"` å­—ç¬¦ä¸²ã€‚

## 15.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo14ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-rpc/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo14ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo14Producer çš„ RPC çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo14ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo14ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo14Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        String result = producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ æ¶ˆè´¹ç»“æœï¼š[{}]]", id, result);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œ `#testSyncSend()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
# Demo14Consumer æˆåŠŸæ¶ˆè´¹å‘é€çš„æ¶ˆæ¯
2019-12-13 19:13:36.627  INFO 93696 --- [ntContainer#4-1] c.i.s.l.r.consumer.Demo14Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:25 æ¶ˆæ¯å†…å®¹ï¼šDemo14Message{id=1576235616}]

# Producer æ‰“å°å‘é€æ¶ˆæ¯çš„æ¶ˆè´¹ç»“æœ
2019-12-13 19:13:36.630  INFO 93696 --- [           main] c.i.s.l.r.producer.Demo14ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1576235616] å‘é€æˆåŠŸ æ¶ˆè´¹ç»“æœï¼š[nicai]]
```



- ç¬¦åˆé¢„æœŸ~æ•´ä¸ªè¿‡ç¨‹ï¼Œå¥½å¥½ç†è§£è‰¿è‰¿åœ¨æ—¥å¿—ä¸Šï¼Œæ·»åŠ çš„è¿‡ç¨‹æ³¨é‡Šå™¢ã€‚

ğŸ˜ˆ é€šè¿‡ RabbitMQ æ¥å®ç° RPC çš„åŠŸèƒ½ï¼Œçœ‹èµ·æ¥æ˜¯æ¯”è¾ƒé…·ç‚«çš„ã€‚ä¸è¿‡è‰¿è‰¿æš‚æ—¶æ²¡æœ‰æƒ³åˆ°å®é™…çš„ä½¿ç”¨åœºæ™¯ï¼Œæœ‰äº†è§£çš„èƒ–å‹ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹è‰¿è‰¿å™¢ï¼Œè°¢è°¢ã€‚

# 16. MessageConverter

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-json](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json) ã€‚

åœ¨ Spring-AMQP ä¸­ï¼Œé€šè¿‡ [MessageConverter](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/support/converter/MessageConverter.java) æ¥ä½œä¸ºæ¶ˆæ¯è½¬æ¢å™¨ï¼š

- åœ¨ Producer ä¸­ï¼Œå°† Java POJO è½¬æ¢æˆ AMQP [Message](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/Message.java) ã€‚
- åœ¨ Consumer ä¸­ï¼Œå°† AMQP [Message](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/Message.java) è½¬æ¢æˆ Java POJO ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitTemplate é‡‡ç”¨ [SimpleMessageConverter](https://github.com/spring-projects/spring-framework/blob/master/spring-messaging/src/main/java/org/springframework/messaging/converter/SimpleMessageConverter.java) ã€‚è€Œ SimpleMessageConverter å†…éƒ¨ï¼Œé‡‡ç”¨ Java **è‡ªå¸¦**åºåˆ—åŒ–æ–¹å¼ï¼Œå®ç°å¯¹ Java POJO å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥å®˜æ–¹ç›®å‰ä¸æ˜¯å¾ˆæ¨èã€‚ä¸»è¦ç¼ºç‚¹å¦‚ä¸‹ï¼š

- æ— æ³•è·¨è¯­è¨€
- åºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„å¤ªå¤§
- åºåˆ—åŒ–æ€§èƒ½å¤ªä½

å› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®é‡‡ç”¨ [Jackson2JsonMessageConverter](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/support/converter/Jackson2JsonMessageConverter.java) ï¼Œä½¿ç”¨ **JSON** å®ç°å¯¹ Java POJO å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ª Jackson2JsonMessageConverter çš„ä½¿ç”¨ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-json](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json) é¡¹ç›®ã€‚

## 16.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-04-rabbitmq-demo-json</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ RabbitMQ çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>

        <!-- Jackson ä¾èµ–  -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.9.10.1</version>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

</project>
```



- ç›¸æ¯”[ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œé¢å¤–å¼•å…¥ `jackson-databind` ä¾èµ–ã€‚

## 16.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/resources/https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

## 16.3 Demo15Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo15Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo15Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 16.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé¢å¤–æ·»åŠ åˆ›å»º Jackson2JsonMessageConverter Bean ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo15Queue() {
            return new Queue(Demo15Message.QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo15Exchange() {
            return new DirectExchange(Demo15Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo15Message.EXCHANGE
        // Routing keyï¼šDemo15Message.ROUTING_KEY
        // Queueï¼šDemo15Message.QUEUE
        @Bean
        public Binding demo15Binding() {
            return BindingBuilder.bind(demo15Queue()).to(demo15Exchange()).with(Demo15Message.ROUTING_KEY);
        }

    }

    @Bean
    public MessageConverter messageConverter() {
        return new Jackson2JsonMessageConverter();
    }

}
```



- åœ¨ `#messageConverter()` æ–¹æ³•ï¼Œåˆ›å»º Jackson2JsonMessageConverter Bean å¯¹è±¡ã€‚åç»­ï¼Œ[RabbitAutoConfiguration.RabbitTemplateConfiguration](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration.java) åœ¨åˆ›å»º RabbitTemplate Bean æ—¶ï¼Œä¼šè‡ªåŠ¨æ³¨å…¥å®ƒã€‚

## 16.5 Demo15Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo15Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo15Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€RoutingKey åå­—ä¸åŒã€‚

å¯¹äºèƒ–å‹æ¥è¯´ï¼Œå¯èƒ½æœ€å…³å¿ƒçš„æ˜¯ï¼Œæ¶ˆæ¯ Message æ˜¯æ€ä¹ˆåºåˆ—åŒ–çš„ã€‚

- åœ¨åºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Jackson2JsonMessageConverter åºåˆ—åŒ– Message æ¶ˆæ¯å¯¹è±¡ï¼Œå®ƒä¼šåœ¨ RabbitMQ æ¶ˆæ¯ [MessageProperties](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/MessageProperties.java) çš„ `__TypeId__` ä¸Šï¼Œå€¼ä¸º Message æ¶ˆæ¯å¯¹åº”çš„**ç±»å…¨å**ã€‚
- åœ¨ååºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Jackson2JsonMessageConverter åºåˆ—åŒ–å‡º Message æ¶ˆæ¯å¯¹è±¡ï¼Œå®ƒä¼šæ ¹æ® RabbitMQ æ¶ˆæ¯ [MessageProperties](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/MessageProperties.java) çš„ `__TypeId__` çš„å€¼ï¼Œååºåˆ—åŒ–æ¶ˆæ¯å†…å®¹æˆè¯¥ Message å¯¹è±¡ã€‚

## 16.6 Demo15Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo15Consumer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo15Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo15Consumer.java

@Component
@RabbitListener(queues = Demo15Message.QUEUE)
public class Demo15Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler(isDefault = true)
    public void onMessage(Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(),
                new String(message.getBody()));
    }

}
```



- å› ä¸ºæˆ‘ä»¬å¸Œæœ›é€šè¿‡æŸ¥çœ‹å…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯çœŸçš„ä½¿ç”¨ JSON æ ¼å¼ï¼Œæ‰€ä»¥é‡‡ç”¨ AMQP Message æ¥æ”¶æ¶ˆæ¯ã€‚

## 16.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo15ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-json/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo15ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo15Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo15ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo15ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo15Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œ `#testSyncSend()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
// Producer åŒæ­¥å‘é€ 1 æ¡æ¶ˆæ¯æˆåŠŸ
2019-12-13 20:38:37.311  INFO 4285 --- [           main] c.i.s.l.r.producer.Demo15ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1576240717] å‘é€æˆåŠŸ]

// Demo15Consumer æ¶ˆè´¹ 1 æ¡æ¶ˆæ¯æˆåŠŸ
// ä»æ¶ˆæ¯å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JSON æ ¼å¼ï¼Œè¯´æ˜é…ç½®ç”Ÿæ•ˆï¼Œå˜¿å˜¿ã€‚
2019-12-13 20:38:37.335  INFO 4285 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo15Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼š{"id":1576240717}]
```



- ç¬¦åˆé¢„æœŸ~