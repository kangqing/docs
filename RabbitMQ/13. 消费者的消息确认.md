# 13. æ¶ˆè´¹è€…çš„æ¶ˆæ¯ç¡®è®¤

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-ack](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack) ã€‚

åœ¨ RabbitMQ ä¸­ï¼ŒConsumer æœ‰ä¸¤ç§æ¶ˆæ¯ç¡®è®¤çš„æ–¹å¼ï¼š

- æ–¹å¼ä¸€ï¼Œè‡ªåŠ¨ç¡®è®¤ã€‚
- æ–¹å¼äºŒï¼Œæ‰‹åŠ¨ç¡®è®¤ã€‚

å¯¹äº**è‡ªåŠ¨ç¡®è®¤**çš„æ–¹å¼ï¼ŒRabbitMQ Broker åªè¦å°†æ¶ˆæ¯å†™å…¥åˆ° TCP Socket ä¸­æˆåŠŸï¼Œå°±è®¤ä¸ºè¯¥æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œè€Œæ— éœ€ Consumer **æ‰‹åŠ¨ç¡®è®¤**ã€‚

å¯¹äº**æ‰‹åŠ¨ç¡®è®¤**çš„æ–¹å¼ï¼ŒRabbitMQ Broker å°†æ¶ˆæ¯å‘é€ç»™ Consumer ä¹‹åï¼Œç”± Consumer **æ‰‹åŠ¨ç¡®è®¤**ä¹‹åï¼Œæ‰ä»»åŠ¡æ¶ˆæ¯æŠ•é€’æˆåŠŸã€‚

å®é™…åœºæ™¯ä¸‹ï¼Œå› ä¸ºè‡ªåŠ¨ç¡®è®¤å­˜åœ¨å¯èƒ½**ä¸¢å¤±æ¶ˆæ¯**çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨å¯¹**å¯é æ€§**æœ‰è¦æ±‚çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åŸºæœ¬é‡‡ç”¨æ‰‹åŠ¨ç¡®è®¤ã€‚å½“ç„¶ï¼Œå¦‚æœå…è®¸æ¶ˆæ¯æœ‰ä¸€å®šçš„ä¸¢å¤±ï¼Œå¯¹**æ€§èƒ½**æœ‰æ›´é«˜çš„äº§ç»ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é‡‡ç”¨è‡ªåŠ¨ç¡®è®¤ã€‚

ğŸ˜ˆ æ›´å¤šå…³äºæ¶ˆè´¹è€…çš„æ¶ˆæ¯ç¡®è®¤çš„å†…å®¹ï¼Œèƒ–å‹å¯ä»¥é˜…è¯»å¦‚ä¸‹çš„æ–‡ç« ï¼š

- [ã€ŠConsumer Acknowledgements and Publisher Confirmsã€‹](https://www.rabbitmq.com/confirms.html) çš„æ¶ˆè´¹è€…éƒ¨åˆ†çš„å†…å®¹ï¼Œå¯¹åº”ä¸­æ–‡ç¿»è¯‘ä¸º [ã€Šæ¶ˆè´¹è€…åº”ç­”ï¼ˆACKï¼‰å’Œå‘å¸ƒè€…ç¡®è®¤ï¼ˆConfirmï¼‰ã€‹](https://blog.bossma.cn/rabbitmq/consumer-ack-and-publisher-confirm/) ã€‚
- [ã€ŠRabbitMQ ä¹‹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆäº‹åŠ¡ + Confirmï¼‰ã€‹](http://www.iocoder.cn/RabbitMQ/message-confirmation-mechanism-transaction-Confirm/?self) æ–‡ç« çš„[ã€Œæ¶ˆæ¯ç¡®è®¤ï¼ˆConsumerç«¯ï¼‰ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ã€‚

åœ¨ Spring-AMQP ä¸­ï¼Œåœ¨ [AcknowledgeMode](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/core/AcknowledgeMode.java) ä¸­ï¼Œå®šä¹‰äº†ä¸‰ç§æ¶ˆæ¯ç¡®è®¤çš„æ–¹å¼ï¼š



```
// AcknowledgeMode.java

/**
 * No acks - {@code autoAck=true} in {@code Channel.basicConsume()}.
 */
NONE, // å¯¹åº” Consumer çš„è‡ªåŠ¨ç¡®è®¤

/**
 * Manual acks - user must ack/nack via a channel aware listener.
 */
MANUAL, // å¯¹åº” Consumer çš„æ‰‹åŠ¨ç¡®è®¤ï¼Œç”±å¼€å‘è€…åœ¨æ¶ˆè´¹é€»è¾‘ä¸­ï¼Œæ‰‹åŠ¨è¿›è¡Œç¡®è®¤ã€‚

/**
 * Auto - the container will issue the ack/nack based on whether
 * the listener returns normally, or throws an exception.
 * <p><em>Do not confuse with RabbitMQ {@code autoAck} which is
 * represented by {@link #NONE} here</em>.
 */
AUTO; // å¯¹åº” Consumer çš„æ‰‹åŠ¨ç¡®è®¤ï¼Œåœ¨æ¶ˆè´¹æ¶ˆæ¯å®Œæˆï¼ˆåŒ…æ‹¬æ­£å¸¸è¿”å›ã€å’ŒæŠ›å‡ºå¼‚å¸¸ï¼‰åï¼Œç”± Spring-AMQP æ¡†æ¶æ¥â€œè‡ªåŠ¨â€è¿›è¡Œç¡®è®¤ã€‚
```



- å®é™…ä¸Šï¼Œå°±æ˜¯å°†**æ‰‹åŠ¨ç¡®è®¤**è¿›ä¸€æ­¥ç»†åˆ†ï¼Œæä¾›äº†ç”± Spring-AMQP æä¾› Consumer çº§åˆ«çš„è‡ªåŠ¨ç¡®è®¤ã€‚

**åœ¨ä¸Šè¿°çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨äº† Spring-AMQP é»˜è®¤çš„ `AUTO` æ¨¡å¼**ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ª `MANUAL` æ¨¡å¼ï¼Œæ‰‹åŠ¨ç¡®è®¤çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-ack](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack) é¡¹ç›®ã€‚

## 13.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/pom.xml) æ–‡ä»¶ã€‚

## 13.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`resources`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/resources) ç›®å½•ä¸‹ï¼Œåˆ›å»º [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/resources/application.yaml) é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
    listener:
      simple:
        acknowledge-mode: manual # é…ç½® Consumer æ‰‹åŠ¨æäº¤
```



- ç›¸æ¯”[ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡**æ–°å¢** `spring.rabbitmq.listener.simple.acknowledge-mode=true` é…ç½®é¡¹ï¼Œæ¥é…ç½® Consumer æ‰‹åŠ¨æäº¤ã€‚

## 13.3 Demo12Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo12Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo12Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 13.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé…ç½®ç›¸å…³çš„ Exchangeã€Queueã€Binding ã€‚

å’Œ[ã€Œ3.1.5 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 13.5 Demo12Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo12Producer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/Demo12Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€RoutingKey åå­—ä¸åŒã€‚

## 13.6 Demo12Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo09Consumer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo12Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo12Consumer.java

@Component
@RabbitListener(queues = Demo12Message.QUEUE)
public class Demo12Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo12Message message, Channel channel,
                          @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) throws IOException {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        // æäº¤æ¶ˆè´¹è¿›åº¦
        if (message.getId() % 2 == 1) {
            // ack ç¡®è®¤æ¶ˆæ¯
            // ç¬¬äºŒä¸ªå‚æ•° multiple ï¼Œç”¨äºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯ï¼Œä¸ºäº†å‡å°‘ç½‘ç»œæµé‡ï¼Œæ‰‹åŠ¨ç¡®è®¤å¯ä»¥è¢«æ‰¹å¤„ã€‚
            // 1. å½“ multiple ä¸º true æ—¶ï¼Œåˆ™å¯ä»¥ä¸€æ¬¡æ€§ç¡®è®¤ deliveryTag å°äºç­‰äºä¼ å…¥å€¼çš„æ‰€æœ‰æ¶ˆæ¯
            // 2. å½“ multiple ä¸º false æ—¶ï¼Œåˆ™åªç¡®è®¤å½“å‰ deliveryTag å¯¹åº”çš„æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
        }
    }

}
```



- åœ¨æ¶ˆè´¹æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬å¢åŠ ç±»å‹ä¸º [Channel](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java) çš„æ–¹æ³•å‚æ•°ï¼Œå’Œ `deliveryTag` ã€‚é€šè¿‡è°ƒç”¨å…¶ `Channel#basicAck(deliveryTag, multiple)` æ–¹æ³•ï¼Œå¯ä»¥è¿›è¡Œæ¶ˆæ¯çš„ç¡®è®¤ã€‚è¿™é‡Œï¼Œè‰¿è‰¿æ·»åŠ äº†æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±ç…ç…å™¢ã€‚
- åœ¨ `@RabbitListener` æ³¨è§£çš„ `ackMode` å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è‡ªå®šä¹‰çš„ AcknowledgeMode æ¨¡å¼ã€‚
- åœ¨æ¶ˆè´¹é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬æ•…æ„åªæäº¤æ¶ˆè´¹çš„æ¶ˆæ¯çš„ `Demo12Message.id` ä¸º**å¥‡æ•°**çš„æ¶ˆæ¯ã€‚ğŸ˜ˆ è¿™æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦å‘é€ä¸€æ¡ `id=1` ï¼Œä¸€æ¡ `id=2` çš„æ¶ˆæ¯ï¼Œå¦‚æœç¬¬äºŒæ¡çš„æ¶ˆè´¹è¿›åº¦æ²¡æœ‰è¢«æäº¤ï¼Œå°±å¯ä»¥è¯´æ˜æ‰‹åŠ¨æäº¤æ¶ˆè´¹è¿›åº¦æˆåŠŸã€‚

## 13.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo12ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-ack/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo12ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæµ‹è¯•æ‰‹åŠ¨æäº¤æ¶ˆè´¹è¿›åº¦ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo12ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo12ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo12Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        for (int id = 1; id <= 2; id++) {
            producer.syncSend(id);
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);
        }

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œ `#testSyncSend()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
// Producer åŒæ­¥å‘é€ 2 æ¡æ¶ˆæ¯æˆåŠŸ
2019-12-13 00:19:33.403  INFO 45869 --- [           main] c.i.s.l.r.producer.Demo12ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1] å‘é€æˆåŠŸ]
2019-12-13 00:19:33.406  INFO 45869 --- [           main] c.i.s.l.r.producer.Demo12ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[2] å‘é€æˆåŠŸ]

// Demo08Consumer æ¶ˆè´¹ 2 æ¡æ¶ˆæ¯æˆåŠŸ
2019-12-13 00:19:33.420  INFO 45869 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo12Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo12Message{id=1}]
2019-12-13 00:19:33.421  INFO 45869 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo12Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo12Message{id=2}]
```



æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ [RabbitMQ Management](https://static.iocoder.cn/7c5541295505e7a3be4ac7ab2882feeb) æ¥æŸ¥çœ‹ `"DEMO_12"` çš„è¯¥æ¶ˆè´¹è€…ï¼š![ çš„æ¶ˆè´¹è€…åˆ—](https://yunqing-img.oss-cn-beijing.aliyuncs.com/hexo/article/202303/02.png)

- æœ‰ 1 æ¡æ¶ˆæ¯çš„æœªç¡®è®¤ï¼Œç¬¦åˆé¢„æœŸ~