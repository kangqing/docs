# 4. æ‰¹é‡å‘é€æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-batch](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch) ã€‚

åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ Producer æ‰¹é‡å‘é€æ¶ˆæ¯ï¼Œæé«˜å‘é€æ€§èƒ½ã€‚ä¸åŒäºæˆ‘ä»¬åœ¨[ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RocketMQ/?self) çš„[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) åŠŸèƒ½ï¼ŒRocketMQ æ˜¯æä¾›äº†ä¸€ä¸ªå¯ä»¥æ‰¹é‡å‘é€å¤šæ¡æ¶ˆæ¯çš„ API ã€‚è€Œ Spring-AMQP æä¾›çš„æ‰¹é‡å‘é€æ¶ˆæ¯ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª [MessageBatch](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/batch/MessageBatch.java) æ¶ˆæ¯æ”¶é›†å™¨ï¼Œå°†å‘é€ç»™**ç›¸åŒ Exchange + RoutingKey çš„æ¶ˆæ¯ä»¬**ï¼Œâ€œ**å·å·**â€æ”¶é›†åœ¨ä¸€èµ·ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶å€™ï¼Œä¸€æ¬¡æ€§æ‰¹é‡å‘é€æäº¤ç»™ RabbitMQ Broker ã€‚

Spring-AMQP é€šè¿‡ [BatchingRabbitTemplate](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/BatchingRabbitTemplate.java) æä¾›æ‰¹é‡å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ã€‚å¦‚ä¸‹æ˜¯ä¸‰ä¸ªæ¡ä»¶ï¼Œæ»¡è¶³**ä»»ä¸€**å³ä¼šæ‰¹é‡å‘é€ï¼š

- ã€æ•°é‡ã€‘`batchSize` ï¼šè¶…è¿‡æ”¶é›†çš„æ¶ˆæ¯æ•°é‡çš„æœ€å¤§æ¡æ•°ã€‚
- ã€ç©ºé—´ã€‘`bufferLimit` ï¼šè¶…è¿‡æ”¶é›†çš„æ¶ˆæ¯å ç”¨çš„æœ€å¤§å†…å­˜ã€‚
- ã€æ—¶é—´ã€‘`timeout` ï¼šè¶…è¿‡æ”¶é›†çš„æ—¶é—´çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚ğŸ˜ˆ ä¸è¿‡è¦æ³¨æ„ï¼Œè¿™é‡Œçš„è¶…æ—¶å¼€å§‹è®¡æ—¶çš„æ—¶é—´ï¼Œæ˜¯**ä»¥æœ€åä¸€æ¬¡å‘é€æ—¶é—´ä¸ºèµ·ç‚¹**ã€‚ä¹Ÿå°±è¯´ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼Œéƒ½ä»¥å½“å‰æ—¶åˆ»å¼€å§‹è®¡æ—¶ï¼Œé‡æ–°åˆ°è¾¾ `timeout` æ¯«ç§’æ‰ç®—è¶…æ—¶ã€‚

å¦å¤–ï¼ŒBatchingRabbitTemplate æä¾›çš„æ‰¹é‡å‘é€æ¶ˆæ¯çš„èƒ½åŠ›**æ¯”è¾ƒå¼±**ã€‚å¯¹äºåŒä¸€ä¸ª BatchingRabbitTemplate å¯¹è±¡æ¥è¯´ï¼Œ**åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ‰¹æ¬¡(ä¿è¯ Exchange + RoutingKey ç›¸åŒ)**ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª Producer æ‰¹é‡å‘é€æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“[ã€Œ3. å¿«é€Ÿå…¥é—¨ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-batch](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch) é¡¹ç›®ã€‚

## 4.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/pom.xml) æ–‡ä»¶ã€‚

## 4.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

## 4.3 Demo05Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo05Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo05Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 4.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ  BatchingRabbitTemplate çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo05Queue() {
            return new Queue(Demo05Message.QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo05Exchange() {
            return new DirectExchange(Demo05Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo05Message.EXCHANGE
        // Routing keyï¼šDemo05Message.ROUTING_KEY
        // Queueï¼šDemo05Message.QUEUE
        @Bean
        public Binding demo05Binding() {
            return BindingBuilder.bind(demo05Queue()).to(demo05Exchange()).with(Demo05Message.ROUTING_KEY);
        }

    }

    @Bean
    public BatchingRabbitTemplate batchRabbitTemplate(ConnectionFactory connectionFactory) {
        // åˆ›å»º BatchingStrategy å¯¹è±¡ï¼Œä»£è¡¨æ‰¹é‡ç­–ç•¥
        int batchSize = 16384; // è¶…è¿‡æ”¶é›†çš„æ¶ˆæ¯æ•°é‡çš„æœ€å¤§æ¡æ•°ã€‚
        int bufferLimit = 33554432; // æ¯æ¬¡æ‰¹é‡å‘é€æ¶ˆæ¯çš„æœ€å¤§å†…å­˜
        int timeout = 30000; // è¶…è¿‡æ”¶é›†çš„æ—¶é—´çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
        BatchingStrategy batchingStrategy = new SimpleBatchingStrategy(batchSize, bufferLimit, timeout);

        // åˆ›å»º TaskScheduler å¯¹è±¡ï¼Œç”¨äºå®ç°è¶…æ—¶å‘é€çš„å®šæ—¶å™¨
        TaskScheduler taskScheduler = new ConcurrentTaskScheduler();

        // åˆ›å»º BatchingRabbitTemplate å¯¹è±¡
        BatchingRabbitTemplate batchTemplate = new BatchingRabbitTemplate(batchingStrategy, taskScheduler);
        batchTemplate.setConnectionFactory(connectionFactory);
        return batchTemplate;
    }

}
```



- DirectExchangeDemoConfiguration é…ç½®ç±»ï¼Œç”¨äºå®šä¹‰ Queueã€Exchangeã€Binding çš„é…ç½®ã€‚

- ```
  #batchRabbitTemplate(ConnectionFactory connectionFactory)
  ```

   

  æ–¹æ³•ï¼Œåˆ›å»º BatchingRabbitTemplate Bean å¯¹è±¡ã€‚

  - å…·ä½“çš„ `batchSize`ã€`bufferLimit`ã€`timeout` æ•°å€¼é…ç½®å¤šå°‘ï¼Œæ ¹æ®è‡ªå·±çš„åº”ç”¨æ¥ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æ•…æ„å°† `timeout` é…ç½®æˆäº† 30 ç§’ï¼Œä¸»è¦ä¸ºäº†æ¼”ç¤ºä¹‹ç”¨ã€‚
  - åˆ›å»º BatchingRabbitTemplate å¯¹è±¡çš„ä»£ç ï¼Œè‰¿è‰¿å·²ç»æ·»åŠ æ³¨é‡Šï¼Œå¯ä»¥è‡ªå·±é˜…è¯»ç†è§£ä¸‹å™¢ã€‚

## 4.5 Demo05Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo05Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo05Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ BatchingRabbitTemplate ï¼Œå®ç°æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo05Producer.java

@Component
public class Demo05Producer {

    @Autowired
    private BatchingRabbitTemplate batchingRabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º Demo05Message æ¶ˆæ¯
        Demo05Message message = new Demo05Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        batchingRabbitTemplate.convertAndSend(Demo05Message.EXCHANGE, Demo05Message.ROUTING_KEY, message);
    }

}
```



- çœ‹èµ·æ¥å’Œæˆ‘ä»¬åœ¨[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æä¾›çš„å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼Œé™¤äº†æ¢æˆäº† BatchingRabbitTemplate æ¥å‘é€æ¶ˆæ¯ï¼Œå…¶å®ƒéƒ½æ˜¯ä¸€è‡´çš„ã€‚ğŸ˜ˆ å¯¹çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè‰¿è‰¿åœ¨ä¸Šæ–‡è¯´åˆ°ï¼ŒSpring-AMQP æ˜¯â€œ**å·å·**â€æ”¶é›†æ¥å®ç°æ‰¹é‡å‘é€ï¼Œå¯¹äºæˆ‘ä»¬ä½¿ç”¨å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼Œè¿˜æ˜¯ä¸€è‡´çš„ã€‚

BatchingRabbitTemplate é€šè¿‡é‡å†™ [`#send(String exchange, String routingKey, Message message, CorrelationData correlationData)`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/BatchingRabbitTemplate.java#L76-L99) **æ ¸å¿ƒ**æ–¹æ³•ï¼Œå®ç°æ‰¹é‡å‘é€çš„åŠŸèƒ½ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸‹æºç ï¼Œä¸å¤æ‚å“ˆ~

## 4.6 Demo05Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo05Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo05Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo05Consumer.java

@Component
@RabbitListener(queues = Demo05Message.QUEUE)
public class Demo05Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo05Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_02"` ã€‚

## 4.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo05ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo05ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæµ‹è¯• Producer æ‰¹é‡å‘é€æ¶ˆæ¯çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo05ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo05ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo05Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        for (int i = 0; i < 3; i++) {
            // åŒæ­¥å‘é€æ¶ˆæ¯
            int id = (int) (System.currentTimeMillis() / 1000);
            producer.syncSend(id);

            // æ•…æ„æ¯æ¡æ¶ˆæ¯ä¹‹é—´ï¼Œéš”ç¦» 10 ç§’
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);
            Thread.sleep(10 * 1000L);
        }

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- åŒæ­¥å‘é€ä¸‰æ¡æ¶ˆæ¯ï¼Œæ¯æ¬¡å‘é€æ¶ˆæ¯ä¹‹é—´ï¼Œéƒ½æ•…æ„ sleep 10 ç§’ã€‚ğŸ˜ˆ ç›®çš„æ˜¯ï¼Œæ°å¥½æ»¡è¶³æˆ‘ä»¬é…ç½®çš„ `timeout` æœ€å¤§ç­‰å¾…æ—¶é•¿ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testASyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer æˆåŠŸåŒæ­¥å‘é€äº† 3 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡é—´éš” 10 ç§’ã€‚
2019-12-15 16:50:15.419  INFO 94085 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575967815] å‘é€æˆåŠŸ]
2019-12-15 16:50:25.426  INFO 94085 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575967825] å‘é€æˆåŠŸ]
2019-12-15 16:50:35.427  INFO 94085 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575967835] å‘é€æˆåŠŸ]

// Demo05Consumer åœ¨æœ€åä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸåæœçš„ 30 ç§’ï¼Œæ¶ˆè´¹åˆ°è¿™ 3 æ¡æ¶ˆæ¯ã€‚
2019-12-15 16:51:05.449  INFO 94085 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo05Message{id=1575967815}]
2019-12-15 16:51:05.450  INFO 94085 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo05Message{id=1575967825}]
2019-12-15 16:51:05.450  INFO 94085 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo05Message{id=1575967835}]
```



- å› ä¸ºä½¿ç”¨ BatchingRabbitTemplate æ‰¹é‡å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨ Producer æˆåŠŸå‘é€å®Œç¬¬ä¸€æ¡æ¶ˆæ¯åï¼ŒConsumer å¹¶æœªæ¶ˆè´¹åˆ°è¿™æ¡æ¶ˆæ¯ã€‚
- åˆå› ä¸º BatchingRabbitTemplate æ˜¯æŒ‰ç…§æ¯æ¬¡å‘é€åï¼Œéƒ½é‡æ–°è®¡æ—¶ï¼Œæ‰€ä»¥åœ¨æœ€åä¸€æ¡æ¶ˆæ¯æˆåŠŸå‘é€åçš„ 30 ç§’ï¼ŒConsumer æ‰æ¶ˆè´¹åˆ°æ‰¹é‡å‘é€çš„ 3 æ¡æ¶ˆæ¯ã€‚

# 5. æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-batch-consume](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume)

åœ¨[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å®ç°æ‰¹é‡å‘é€æ¶ˆæ¯åˆ° RabbitMQ Broker ä¸­ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ‰¹æ¶ˆæ¯åœ¨ RabbitMQ Broker åˆ°åº•æ˜¯å­˜å‚¨**ä¸€æ¡**æ¶ˆæ¯ï¼Œè¿˜æ˜¯**å¤šæ¡**æ¶ˆæ¯ï¼Ÿ

- å¦‚æœèƒ–å‹ä½¿ç”¨è¿‡ Kafkaã€RocketMQ è¿™ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œé‚£ä¹ˆåˆ¤æ–­è‚¯å®šä¼šæ˜¯**å¤šæ¡**æ¶ˆæ¯ã€‚
- ä»[ã€Œ4.6 Demo05Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°**é€æ¡**æ¶ˆæ¯çš„æ¶ˆè´¹ï¼Œä¹Ÿä¼šè®¤ä¸ºæ˜¯**å¤šæ¡**æ¶ˆæ¯ã€‚

ğŸ˜­ å®é™…ä¸Šï¼ŒRabbitMQ Broker å­˜å‚¨çš„æ˜¯**ä¸€æ¡**æ¶ˆæ¯ã€‚åˆæˆ–è€…è¯´ï¼Œ**RabbitMQ å¹¶æ²¡æœ‰æä¾›æ‰¹é‡æ¥æ”¶æ¶ˆæ¯çš„ API æ¥å£**ã€‚

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)èƒ½å¤Ÿå®ç°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ‰¹é‡å‘é€æ¶ˆæ¯æ˜¯ Spring-AMQP çš„ [SimpleBatchingStrategy](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/batch/SimpleBatchingStrategy.java) æ‰€å°è£…æä¾›ï¼š

- åœ¨ Producer æœ€ç»ˆæ‰¹é‡å‘é€æ¶ˆæ¯æ—¶ï¼ŒSimpleBatchingStrategy ä¼šé€šè¿‡ [`#assembleMessage()`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/batch/SimpleBatchingStrategy.java#L141-L156) æ–¹æ³•ï¼Œå°†æ‰¹é‡å‘é€çš„**å¤šæ¡**æ¶ˆæ¯**ç»„è£…**æˆä¸€æ¡â€œæ‰¹é‡â€æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå‘é€ã€‚
- åœ¨ Consumer æ‹‰å–åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šæ ¹æ®[`#canDebatch(MessageProperties properties)`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/batch/SimpleBatchingStrategy.java#L158-L163) æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥æ¶ˆæ¯æ˜¯å¦ä¸ºä¸€æ¡â€œæ‰¹é‡â€æ¶ˆæ¯ï¼Ÿå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨[`# deBatch(Message message, Consumer fragmentConsumer)`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/batch/SimpleBatchingStrategy.java#L165-L194) æ–¹æ³•ï¼Œå°†ä¸€æ¡â€œæ‰¹é‡â€æ¶ˆæ¯**æ‹†å¼€**ï¼Œå˜æˆ**å¤šæ¡**æ¶ˆæ¯ã€‚

> è¿™ä¸ªæ“ä½œï¼Œæ˜¯ä¸æ˜¯ç•¥å¾®æœ‰ç‚¹éªšæ°”ï¼Ÿï¼è‰¿è‰¿åœ¨è¿™é‡Œå¡äº†å¾ˆä¹…ï¼ï¼ï¼è«åå…¶å¦™çš„~ä¸€ç›´ä»¥ä¸ºï¼ŒRabbitMQ æä¾›äº†æ‰¹é‡å‘é€æ¶ˆæ¯çš„ API æ¥å£å•Šã€‚
>
> OK ï¼Œè™½ç„¶å¾ˆæ‚²ä¼¤ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å›åˆ°è¿™ä¸ªå°èŠ‚çš„ä¸»é¢˜ã€‚

åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ Consumer æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦ã€‚åœ¨ Spring-AMQP ä¸­ï¼Œæä¾›äº†ä¸¤ç§æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„æ–¹å¼ã€‚æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ç§ï¼Œå®ƒéœ€è¦åŸºäº[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¹‹ä¸Šå®ç°ã€‚

åœ¨ SimpleBatchingStrategy å°†ä¸€æ¡â€œæ‰¹é‡â€æ¶ˆæ¯æ‹†å¼€ï¼Œå˜æˆå¤šæ¡æ¶ˆæ¯åï¼Œç›´æ¥**æ‰¹é‡**äº¤ç»™ Consumer è¿›è¡Œæ¶ˆè´¹å¤„ç†ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª Consumer æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ [lab-04-rabbitmq-demo-batch](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch) é¡¹ç›®çš„åŸºç¡€ä¸Šï¼Œå¤åˆ¶å‡ºä¸€ä¸ª [lab-04-rabbitmq-demo-batch-consume](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume) é¡¹ç›®ã€‚ğŸ˜ˆ é…±ç´«ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å°‘å†™ç‚¹ä»£ç ï¼Œå“ˆå“ˆå“ˆ~

## 5.1 RabbitConfig

ä¿®æ”¹ [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„ [SimpleRabbitListenerContainerFactory](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/config/SimpleRabbitListenerContainerFactory.java) Bean ï¼Œæ”¯æŒç”¨äºåˆ›å»º**æ”¯æŒæ‰¹é‡æ¶ˆè´¹**çš„ [SimpleRabbitListenerContainer](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java) ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Bean(name = "consumerBatchContainerFactory")
public SimpleRabbitListenerContainerFactory consumerBatchContainerFactory(
        SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory connectionFactory) {
    // åˆ›å»º SimpleRabbitListenerContainerFactory å¯¹è±¡
    SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
    configurer.configure(factory, connectionFactory);
    // <X> é¢å¤–æ·»åŠ æ‰¹é‡æ¶ˆè´¹çš„å±æ€§
    factory.setBatchListener(true);
    return factory;
}
```



- åœ¨ [RabbitAnnotationDrivenConfiguration](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitAnnotationDrivenConfiguration.java) è‡ªåŠ¨åŒ–é…ç½®ç±»ä¸­ï¼Œå®ƒä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªåå­—ä¸º `"rabbitListenerContainerFactory"` çš„ SimpleRabbitListenerContainerFactory Bean ï¼Œå¯ç”¨äºæ¶ˆè´¹è€…çš„ç›‘å¬å™¨æ˜¯**å•ä¸ª**æ¶ˆè´¹æ¶ˆè´¹çš„ã€‚
- æˆ‘ä»¬è‡ªå®šä¹‰åˆ›å»ºçš„ä¸€ä¸ªåå­—ä¸º`"consumerBatchContainerFactory"` çš„ SimpleRabbitListenerContainerFactory Bean ï¼Œå¯ç”¨äºæ¶ˆè´¹è€…çš„ç›‘å¬å™¨æ˜¯**æ‰¹é‡**æ¶ˆè´¹æ¶ˆè´¹çš„ã€‚é‡ç‚¹æ˜¯ `<X>` å¤„ï¼Œé…ç½®æ¶ˆè´¹è€…çš„ç›‘å¬å™¨æ˜¯**æ‰¹é‡**æ¶ˆè´¹æ¶ˆæ¯çš„ç±»å‹ï¼Œå…¶å®ƒçš„å¯ä»¥æš‚æ—¶ä¸ç”¨ç†è§£ã€‚

## 5.2 Demo05Consumer

ä¿®æ”¹ [Demo05Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo05Consumer.java) ç±»ï¼Œ**æ‰¹é‡**æ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo05Consumer.java

@Component
@RabbitListener(queues = Demo05Message.QUEUE,
    containerFactory = "consumerBatchContainerFactory")
public class Demo05Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(List<Demo05Message> messages) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯æ•°é‡ï¼š{}]", Thread.currentThread().getId(), messages.size());
    }

}
```



- åœ¨ç±»ä¸Šçš„ `@@RabbitListener` æ³¨è§£çš„ `containerFactory` å±æ€§ï¼Œè®¾ç½®äº†æˆ‘ä»¬åœ¨[ã€Œ5.1 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åˆ›å»ºçš„ SimpleRabbitListenerContainerFactory Bean ï¼Œè¡¨ç¤ºå®ƒè¦æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€‚
- åœ¨ `#onMessage(...)` æ¶ˆè´¹æ–¹æ³•ä¸Šï¼Œä¿®æ”¹æ–¹æ³•å…¥å‚çš„ç±»å‹ä¸º List æ•°ç»„ã€‚

## 5.3 ç®€å•æµ‹è¯•

å’Œ [ã€Œ4.7 ç®€å•æµ‹è¯•ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [Demo05ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo05ProducerTest.java) å•å…ƒæµ‹è¯•ç±»ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testASyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer æˆåŠŸåŒæ­¥å‘é€äº† 3 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡é—´éš” 10 ç§’ã€‚
2019-12-15 22:42:08.755  INFO 60216 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575988928] å‘é€æˆåŠŸ]
2019-12-15 22:42:18.757  INFO 60216 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575988938] å‘é€æˆåŠŸ]
2019-12-15 22:42:28.758  INFO 60216 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575988948] å‘é€æˆåŠŸ]

// Demo05Consumer åœ¨æœ€åä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸåæœçš„ 30 ç§’ï¼Œä¸€æ¬¡æ€§æ‰¹é‡æ¶ˆè´¹äº†è¿™ 3 æ¡æ¶ˆæ¯ã€‚
2019-12-15 22:42:58.775  INFO 60216 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯æ•°é‡ï¼š3]
```



- ç¬¦åˆé¢„æœŸï¼ŒDemo05Consumer æ‰¹é‡æ¶ˆè´¹äº† 3 æ¡æ¶ˆæ¯ã€‚

# 6. æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ï¼ˆç¬¬äºŒå¼¹ï¼‰

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-batch-consume-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02)

åœ¨[ã€Œ5. æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†ä¸€ç§æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„æ–¹å¼ã€‚å› ä¸ºå…¶ä¾èµ–[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)çš„åŠŸèƒ½ï¼Œæœ‰ç‚¹è¿‡äºè‹›åˆ»ã€‚æ‰€ä»¥ï¼ŒSpring-AMQP æä¾›äº†ç¬¬äºŒç§æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„æ–¹å¼ã€‚

å…¶å®ç°æ–¹å¼æ˜¯ï¼Œé˜»å¡ç­‰å¾…æœ€å¤š `receiveTimeout` ç§’ï¼Œæ‹‰å– `batchSize` æ¡æ¶ˆæ¯ï¼Œè¿›è¡Œæ‰¹é‡æ¶ˆè´¹ã€‚

- å¦‚æœåœ¨ `receiveTimeout` ç§’å†…å·²ç»æˆåŠŸæ‹‰å–åˆ° `batchSize` æ¡æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è¿›è¡Œæ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€‚
- å¦‚æœåœ¨ `receiveTimeout` ç§’è¿˜æ²¡æ‹‰å–åˆ° `batchSize` æ¡æ¶ˆæ¯ï¼Œä¸å†ç­‰å¾…ï¼Œè€Œæ˜¯è¿›è¡Œæ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€‚

ä¸è¿‡ Spring-AMQP çš„é˜»å¡ç­‰å¾…æ—¶é•¿ `receiveTimeout` çš„è®¾è®¡æœ‰ç‚¹â€œç¥å¥‡â€ã€‚

- å®ƒä»£è¡¨çš„æ˜¯ï¼Œæ¯æ¬¡æ‹‰å–ä¸€æ¡æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡ç­‰å¾… `receiveTimeout` æ—¶é•¿ã€‚å¦‚æœç­‰å¾…ä¸åˆ°ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™è¿›å…¥å·²è·å–åˆ°çš„æ¶ˆæ¯çš„æ‰¹é‡æ¶ˆè´¹ã€‚ğŸ˜ˆ ä¹Ÿå°±æ˜¯è¯´ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½ç­‰å¾… `receiveTimeout * batchSize` æ—¶é•¿ï¼Œæ‰ä¼šè¿›è¡Œæ‰¹é‡æ¶ˆè´¹ã€‚
- æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥ç‚¹å‡» [`SimpleMessageListenerContainer#doReceiveAndExecute(BlockingQueueConsumer consumer)`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L922) æ–¹æ³•ï¼Œç®€å•é˜…è¯»æºç ï¼Œå³å¯å¿«é€Ÿç†è§£ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª Consumer æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-batch-consume-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02) é¡¹ç›®ã€‚

## 6.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/pom.xml) æ–‡ä»¶ã€‚

## 6.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

## 6.3 Demo06Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo06Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo06Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 6.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„ [SimpleRabbitListenerContainerFactory](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/config/SimpleRabbitListenerContainerFactory.java) Bean ï¼Œæ”¯æŒç”¨äºåˆ›å»º**æ”¯æŒæ‰¹é‡æ¶ˆè´¹**çš„ [SimpleRabbitListenerContainer](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java) ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo06Queue() {
            return new Queue(Demo06Message.QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo06Exchange() {
            return new DirectExchange(Demo06Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo06Message.EXCHANGE
        // Routing keyï¼šDemo06Message.ROUTING_KEY
        // Queueï¼šDemo06Message.QUEUE
        @Bean
        public Binding demo06Binding() {
            return BindingBuilder.bind(demo06Queue()).to(demo06Exchange()).with(Demo06Message.ROUTING_KEY);
        }

    }

    @Bean(name = "consumerBatchContainerFactory")
    public SimpleRabbitListenerContainerFactory consumerBatchContainerFactory(
            SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory connectionFactory) {
        // åˆ›å»º SimpleRabbitListenerContainerFactory å¯¹è±¡
        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
        configurer.configure(factory, connectionFactory);
        // é¢å¤–æ·»åŠ æ‰¹é‡æ¶ˆè´¹çš„å±æ€§
        factory.setBatchListener(true);
        // <X>
        factory.setBatchSize(10);
        factory.setReceiveTimeout(30 * 1000L);
        factory.setConsumerBatchEnabled(true);
        return factory;
    }

}
```



- DirectExchangeDemoConfiguration é…ç½®ç±»ï¼Œç”¨äºå®šä¹‰ Queueã€Exchangeã€Binding çš„é…ç½®ã€‚
- ç›¸æ¯”[ã€Œ5.1 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œé¢å¤–å¢åŠ äº† `batchSize = 10`ã€`receiveTimeout = 30 * 1000L`ã€`consumerBatchEnabled = 30 * 1000L` å±æ€§ã€‚ğŸ˜ˆ ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œ**æœ¬å°èŠ‚æ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯**ã€‚

## 6.5 Demo06Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo06Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo06Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€RoutingKey åå­—ä¸åŒã€‚

## 6.6 Demo06Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo05Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo05Consumer.java) ç±»ï¼Œ**æ‰¹é‡**æ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo06Consumer.java

@Component
@RabbitListener(queues = Demo06Message.QUEUE,
    containerFactory = "consumerBatchContainerFactory")
public class Demo06Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(List<Demo06Message> messages) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯æ•°é‡ï¼š{}]", Thread.currentThread().getId(), messages.size());
    }

}
```



- å’Œ[ã€Œ5.2 Demo05Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªå·®åœ¨æ¶ˆè´¹ä¸åŒçš„é˜Ÿåˆ—ã€‚

## 6.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo06ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo06ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæµ‹è¯• Consumer æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo06ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo06ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo06Producer producer;

    @Test
    public void testSyncSend01() throws InterruptedException {
        // å‘é€ 3 æ¡æ¶ˆæ¯
        this.testSyncSend(3);
    }

    @Test
    public void testSyncSen02() throws InterruptedException {
        // å‘é€ 10 æ¡æ¶ˆæ¯
        this.testSyncSend(10);
    }

    private void testSyncSend(int n) throws InterruptedException {
        for (int i = 0; i < n; i++) {
            // åŒæ­¥å‘é€æ¶ˆæ¯
            int id = (int) (System.currentTimeMillis() / 1000);
            producer.syncSend(id);
            logger.info("[testSyncSendMore][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);
        }

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- `#testSyncSend01()` æ–¹æ³•ï¼Œå‘é€ 3 æ¡æ¶ˆæ¯ï¼Œæµ‹è¯• Demo06Consumer è·å–æ•°é‡ä¸º `batchSize = 10` æ¶ˆæ¯ï¼Œ**è¶…æ—¶**æƒ…å†µä¸‹çš„æ‰¹é‡æ¶ˆè´¹ã€‚
- `#testSyncSend02()` æ–¹æ³•ï¼Œå‘é€ 10 æ¡æ¶ˆæ¯ï¼Œæµ‹è¯• Demo06Consumer è·å–æ•°é‡ä¸º `batchSize = 10` æ¶ˆæ¯ï¼Œ**æœªè¶…æ—¶**æƒ…å†µä¸‹çš„æ‰¹é‡æ¶ˆè´¹ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend01()` æ–¹æ³•ï¼Œ**è¶…æ—¶**æƒ…å†µä¸‹çš„æ‰¹é‡æ¶ˆè´¹ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer æˆåŠŸåŒæ­¥å‘é€äº† 3 æ¡æ¶ˆæ¯
2019-12-15 00:01:18.097  INFO 78389 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendMore][å‘é€ç¼–å·ï¼š[1575993678] å‘é€æˆåŠŸ]
2019-12-15 00:01:18.099  INFO 78389 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendMore][å‘é€ç¼–å·ï¼š[1575993678] å‘é€æˆåŠŸ]
2019-12-15 00:01:18.099  INFO 78389 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendMore][å‘é€ç¼–å·ï¼š[1575993678] å‘é€æˆåŠŸ]

// Consumer 30 ç§’è¶…æ—¶ç­‰å¾…åï¼Œæ‰¹é‡æ¶ˆè´¹åˆ° 3 æ¡æ¶ˆæ¯
2019-12-15 00:01:48.116  INFO 78389 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo06Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯æ•°é‡ï¼š3]
```



- ç¬¦åˆé¢„æœŸã€‚å…·ä½“èƒ–å‹çœ‹ä¸‹æ—¥å¿—ä¸Šçš„æ³¨é‡Šè¯´æ˜ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend02()` æ–¹æ³•ï¼Œ**æœªè¶…æ—¶**æƒ…å†µä¸‹çš„æ‰¹é‡æ¶ˆè´¹ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer æˆåŠŸåŒæ­¥å‘é€äº† 10 æ¡æ¶ˆæ¯
2019-12-15 00:03:50.406  INFO 78997 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendMore][å‘é€ç¼–å·ï¼š[1575993830] å‘é€æˆåŠŸ]
// ... çœç•¥ 8 æ¡æ¶ˆæ¯
2019-12-15 00:03:50.410  INFO 78997 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendMore][å‘é€ç¼–å·ï¼š[1575993830] å‘é€æˆåŠŸ]

// Consumer æ‹‰å–åˆ° 10 æ¡æ¶ˆæ¯åï¼Œç«‹å³æ‰¹é‡æ¶ˆè´¹åˆ° 10 æ¡æ¶ˆæ¯
2019-12-15 00:03:50.429  INFO 78997 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo06Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯æ•°é‡ï¼š10
```



- ç¬¦åˆé¢„æœŸã€‚å…·ä½“èƒ–å‹çœ‹ä¸‹æ—¥å¿—ä¸Šçš„æ³¨é‡Šè¯´æ˜ã€‚

ğŸ˜ˆ è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸¤ç§ Spring-AMQP çš„æ‰¹é‡æ¶ˆè´¹æ¶ˆè´¹çš„æ–¹æ³•ã€‚æ›´å¤šçš„å†…å®¹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠSpring-AMQP å®˜æ–¹æ–‡æ¡£ â€”â€” @RabbitListener with Batchingã€‹](https://docs.spring.io/spring-amqp/docs/current/reference/html/#receiving-batch) æ–‡æ¡£ã€‚