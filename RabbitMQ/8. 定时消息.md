# 8. å®šæ—¶æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-delay](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay)

åœ¨[ã€Œ7. æ¶ˆè´¹é‡è¯•ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Spring-AMQP åŸºäº RabbitMQ æä¾›çš„**æ­»ä¿¡é˜Ÿåˆ—**ï¼Œé€šè¿‡ `basic.nack` + `requeue=false` çš„æ–¹å¼ï¼Œå°†é‡è¯•æ¶ˆè´¹åˆ°è¾¾ä¸Šé™æ¬¡æ•°çš„æ¶ˆæ¯ï¼ŒæŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬è¿˜æ˜¯åŸºäº RabbitMQ çš„**æ­»ä¿¡é˜Ÿåˆ—**ï¼Œå®ç°**å®šæ—¶æ¶ˆæ¯**çš„åŠŸèƒ½ã€‚RabbitMQ æä¾›äº†è¿‡æœŸæ—¶é—´ [TTL](https://www.rabbitmq.com/ttl.html) æœºåˆ¶ï¼Œå¯ä»¥è®¾ç½®æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­çš„å­˜æ´»æ—¶é•¿ã€‚åœ¨æ¶ˆæ¯åˆ°è¾¾è¿‡æœŸæ—¶é—´æ—¶ï¼Œä¼šä»å½“å‰é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå¹¶è¢« RabbitMQ è‡ªåŠ¨è½¬å‘åˆ°å¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚

é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºæ¶ˆè´¹è€… Consumer ï¼Œæ¥æ¶ˆè´¹è¯¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ˜¯ä¸æ˜¯å°±å®ç°äº†**å»¶è¿Ÿé˜Ÿåˆ—**çš„æ•ˆæœã€‚ğŸ˜ˆ å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¾¿å®ç°äº†å®šæ—¶æ¶ˆæ¯çš„åŠŸèƒ½ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå®šæ—¶æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-delay](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay) é¡¹ç›®ã€‚

## 8.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/pom.xml) æ–‡ä»¶ã€‚

## 8.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

## 8.3 Demo08Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo08Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo08Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo08Message.java

public class Demo08Message implements Serializable {

    public static final String QUEUE = "QUEUE_DEMO_08"; // æ­£å¸¸é˜Ÿåˆ—
    public static final String DELAY_QUEUE = "DELAY_QUEUE_DEMO_08"; // å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰

    public static final String EXCHANGE = "EXCHANGE_DEMO_08";

    public static final String ROUTING_KEY = "ROUTING_KEY_08"; // æ­£å¸¸è·¯ç”±é”®
    public static final String DELAY_ROUTING_KEY = "DELAY_ROUTING_KEY_08"; // å»¶è¿Ÿè·¯ç”±é”®ï¼ˆæ­»ä¿¡è·¯ç”±é”®ï¼‰

    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- ç›¸æ¯”[ã€Œ8.3 Demo07Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼ŒåŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ¢äº†ä¸‹å‘½åï¼Œå°† `DEAD` æ”¹æˆ `DELAY` æ¥æ–¹ä¾¿èƒ–å‹ç†è§£ã€‚

## 8.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé¢å¤–æ·»åŠ **å»¶è¿Ÿé˜Ÿåˆ—**ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo08Queue() {
            return QueueBuilder.durable(Demo08Message.QUEUE) // durable: æ˜¯å¦æŒä¹…åŒ–
                    .exclusive() // exclusive: æ˜¯å¦æ’å®ƒ
                    .autoDelete() // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
                    .ttl(10 * 1000) // è®¾ç½®é˜Ÿåˆ—é‡Œçš„é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º 10 ç§’
                    .deadLetterExchange(Demo08Message.EXCHANGE)
                    .deadLetterRoutingKey(Demo08Message.DELAY_ROUTING_KEY)
                    .build();
        }

        // åˆ›å»º Delay Queue
        @Bean
        public Queue demo08DelayQueue() {
            return new Queue(Demo08Message.DELAY_QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo08Exchange() {
            return new DirectExchange(Demo08Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo08Message.EXCHANGE
        // Routing keyï¼šDemo08Message.ROUTING_KEY
        // Queueï¼šDemo08Message.QUEUE
        @Bean
        public Binding demo08Binding() {
            return BindingBuilder.bind(demo08Queue()).to(demo08Exchange()).with(Demo08Message.ROUTING_KEY);
        }

        // åˆ›å»º Delay Binding
        // Exchangeï¼šDemo08Message.EXCHANGE
        // Routing keyï¼šDemo08Message.DELAY_ROUTING_KEY
        // Queueï¼šDemo08Message.DELAY_QUEUE
        @Bean
        public Binding demo08DelayBinding() {
            return BindingBuilder.bind(demo08DelayQueue()).to(demo08Exchange()).with(Demo08Message.DELAY_ROUTING_KEY);
        }

    }

}
```



- ç›¸æ¯”[ã€Œ7.4 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œä¸»è¦æœ‰**ä¸€ä¸ª**å·®å¼‚ç‚¹ã€‚åœ¨ `#demo08Queue()` æ–¹æ³•æ¥åˆ›å»ºçš„ Queue ï¼Œæˆ‘ä»¬è®¾ç½®äº†è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯çš„é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º 10 ç§’ã€‚

## 8.5 Demo08Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo08Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo08Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo08Producer.java

@Component
public class Demo08Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id, Integer delay) {
        // åˆ›å»º Demo07Message æ¶ˆæ¯
        Demo08Message message = new Demo08Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo08Message.EXCHANGE, Demo08Message.ROUTING_KEY, message, new MessagePostProcessor() {

            @Override
            public Message postProcessMessage(Message message) throws AmqpException {
                // è®¾ç½®æ¶ˆæ¯çš„ TTL è¿‡æœŸæ—¶é—´
                if (delay != null && delay > 0) {
                    message.getMessageProperties().setExpiration(String.valueOf(delay)); // Spring-AMQP API è®¾è®¡æœ‰é—®é¢˜ï¼Œæ‰€ä»¥ä¼ å…¥äº† String = =
                }
                return message;
            }

        });
    }

}
```



- è°ƒç”¨ `#syncSend(Integer id, Integer delay)` æ–¹æ³•æ¥å‘é€æ¶ˆæ¯æ—¶ï¼Œå¦‚æœä¼ é€’äº†æ–¹æ³•å‚æ•° `delay` ï¼Œåˆ™æˆ‘ä»¬ä¼šè®¾ç½®æ¶ˆæ¯çš„ TTL è¿‡æœŸæ—¶é—´ã€‚

## 8.6 Demo08Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo08Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo08Consumer.java) ç±»ï¼Œæ¶ˆè´¹**å»¶è¿Ÿé˜Ÿåˆ—**ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰çš„æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
@Component
@RabbitListener(queues = Demo08Message.DELAY_QUEUE)
public class Demo08Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo08Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- åœ¨ç±»ä¸Šï¼Œæ·»åŠ äº† [`@RabbitListener`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/RabbitListener.java) æ³¨è§£ï¼Œå£°æ˜äº†æ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"DELAY_QUEUE_DEMO_08"` è¿™ä¸ª**å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰**
- åœ¨æ¶ˆè´¹é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬æ­£å¸¸æ¶ˆè´¹è¯¥æ¶ˆæ¯å³å¯ï¼Œå®ç°è‡ªå·±éœ€è¦çš„ä¸šåŠ¡é€»è¾‘ã€‚

## 8.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo08ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-delay/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo08ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæµ‹è¯•**å®šæ—¶æ¶ˆæ¯**çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo08ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo08ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo08Producer producer;

    @Test
    public void testSyncSend01() throws InterruptedException {
        // ä¸è®¾ç½®æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é˜Ÿåˆ—é»˜è®¤çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´
        this.testSyncSendDelay(null);
    }

    @Test
    public void testSyncSend02() throws InterruptedException {
        // è®¾ç½®å‘é€æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’
        this.testSyncSendDelay(5000);
    }

    private void testSyncSendDelay(Integer delay) throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id, delay);
        logger.info("[testSyncSendDelay][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



- `#testSyncSend01()` æ–¹æ³•ï¼Œä¸è®¾ç½®æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é˜Ÿåˆ—**é»˜è®¤çš„æ¶ˆæ¯è¿‡æœŸ**æ—¶é—´ã€‚
- `#testSyncSend02()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„**è¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’**ã€‚

æˆ‘ä»¬å…ˆæ¥æ‰§è¡Œ `#testSyncSend01()` æ–¹æ³•ï¼Œä¸è®¾ç½®æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é˜Ÿåˆ—**é»˜è®¤çš„æ¶ˆæ¯è¿‡æœŸ**æ—¶é—´ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 15:44:34.571  INFO 85481 --- [           main] c.i.s.l.r.producer.Demo08ProducerTest    : [testSyncSendDelay][å‘é€ç¼–å·ï¼š[1576050274] å‘é€æˆåŠŸ]

# Consumer 10 ç§’åï¼Œæ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯
2019-12-15 15:44:44.588  INFO 85481 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo08Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo08Message{id=1576050274}]
```



- ç¬¦åˆé¢„æœŸã€‚

æˆ‘ä»¬å†æ¥æ‰§è¡Œ `#testSyncSend02()` æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯çš„**è¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’**ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚
2019-12-15 15:45:41.076  INFO 85735 --- [           main] c.i.s.l.r.producer.Demo08ProducerTest    : [testSyncSendDelay][å‘é€ç¼–å·ï¼š[1576050341] å‘é€æˆåŠŸ]

# Consumer 5 ç§’åï¼Œæ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯
2019-12-15 15:45:46.090  INFO 85735 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo08Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo08Message{id=1576050341}]
```



- ç¬¦åˆé¢„æœŸã€‚

## 8.8 RabbitMQ Delayed Message Plugin

RabbitMQ ç›®å‰æä¾›äº† [RabbitMQ Delayed Message Plugin](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange) æ’ä»¶ï¼Œæä¾›æ›´åŠ **é€šç”¨**çš„å®šæ—¶æ¶ˆæ¯çš„åŠŸèƒ½ã€‚

ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè‰¿è‰¿è¿™é‡Œå…ˆæš‚æ—¶ä¸æä¾›ç¤ºä¾‹ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠSpring Boot RabbitMQ å»¶è¿Ÿæ¶ˆæ¯å®ç°å®Œæ•´ç‰ˆã€‹](http://www.iocoder.cn/Fight/Spring-Boot-RabbitMQ-deferred-message-implementation-full-version/?self) æ–‡ç« ã€‚

è¿™ä¸¤ç§æ–¹æ¡ˆï¼Œç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè¿˜æ˜¯**æ¨èç›´æ¥ä½¿ç”¨ RabbitMQ Delayed Message Plugin æ’ä»¶çš„æ–¹å¼**ã€‚æ¯•ç«Ÿï¼Œè¿™æ˜¯ RabbitMQ å®˜æ–¹è®¤å¯çš„æ’ä»¶ï¼Œä½¿ç”¨èµ·æ¥è‚¯å®šæ˜¯æ²¡é”™çš„ã€‚