# 12. äº‹åŠ¡æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-transaction](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction) ã€‚

RabbitMQ å†…ç½®æä¾›äº‹åŠ¡æ¶ˆæ¯çš„æ”¯æŒã€‚å¯¹äº‹åŠ¡æ¶ˆæ¯çš„æ¦‚å¿µä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠRabbitMQ ä¹‹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆäº‹åŠ¡ + Confirmï¼‰ã€‹](http://www.iocoder.cn/RabbitMQ/message-confirmation-mechanism-transaction-Confirm/?self) æ–‡ç« çš„[ã€Œäº‹åŠ¡æœºåˆ¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ã€‚

ä¸è¿‡ RabbitMQ æä¾›çš„å¹¶ä¸æ˜¯**å®Œæ•´çš„**çš„äº‹åŠ¡æ¶ˆæ¯çš„æ”¯æŒï¼Œç¼ºå°‘äº†**å›æŸ¥æœºåˆ¶**ã€‚ç›®å‰ï¼Œå¸¸ç”¨çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªæœ‰ RocketMQ æä¾›äº†å®Œæ•´çš„äº‹åŠ¡æ¶ˆæ¯çš„æ”¯æŒï¼Œå…·ä½“çš„å¯ä»¥çœ‹çœ‹[ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RocketMQ/?self) çš„[ã€Œ9. äº‹åŠ¡æ¶ˆæ¯ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ï¼ŒğŸ˜ˆ æš‚æ—¶ä¸æ‹“å±•å¼€æ¥è®²ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-transaction](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction) é¡¹ç›®ã€‚

## 12.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/pom.xml) æ–‡ä»¶ã€‚

## 12.2 åº”ç”¨é…ç½®æ–‡ä»¶

å’Œ [ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/resources/application.yaml) æ–‡ä»¶ã€‚

## 12.3 Demo11Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo11Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo11Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

## 12.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé¢å¤–é…ç½®äº‹åŠ¡ç›¸å…³çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
@EnableTransactionManagement
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo11Queue() {
            return new Queue(Demo11Message.QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo11Exchange() {
            return new DirectExchange(Demo11Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo11Message.EXCHANGE
        // Routing keyï¼šDemo11Message.ROUTING_KEY
        // Queueï¼šDemo11Message.QUEUE
        @Bean
        public Binding demo11Binding() {
            return BindingBuilder.bind(demo11Queue()).to(demo11Exchange()).with(Demo11Message.ROUTING_KEY);
        }

    }

    @Bean
    public RabbitTransactionManager rabbitTransactionManager(ConnectionFactory connectionFactory, RabbitTemplate rabbitTemplate) {
        // <Y> è®¾ç½® RabbitTemplate æ”¯æŒäº‹åŠ¡
        rabbitTemplate.setChannelTransacted(true);

        // åˆ›å»º RabbitTransactionManager å¯¹è±¡
        return new RabbitTransactionManager(connectionFactory);
    }

}
```



- DirectExchangeDemoConfiguration é…ç½®ç±»ï¼Œç”¨äºå®šä¹‰ Queueã€Exchangeã€Binding çš„é…ç½®ã€‚
- åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@EnableTransactionManagement` æ³¨è§£ï¼Œå¼€å¯[Spring Transaction](https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html) çš„æ”¯æŒã€‚
- åœ¨ `#rabbitTransactionManager()` æ–¹æ³•ï¼Œåˆ›å»º [RabbitTransactionManager](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/transaction/RabbitTransactionManager.java) äº‹åŠ¡ç®¡ç†å™¨ Bean ã€‚
- åœ¨ `<Y>` å¤„ï¼Œæ ‡è®°åˆ›å»ºçš„ RabbitMQ Channel æ˜¯äº‹åŠ¡æ€§çš„ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨ RabbitMQ çš„äº‹åŠ¡æ¶ˆæ¯ã€‚

å› ä¸º Spring-AMQP é€šè¿‡ RabbitTransactionManager æ¥å®ç°å¯¹ Spring Transaction çš„é›†æˆï¼Œæ‰€ä»¥åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦é…åˆä½¿ç”¨ `@Transactional` æ³¨è§£ï¼Œæ¥å£°æ˜äº‹åŠ¡å³å¯ã€‚

## 12.5 Demo11Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo11Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo11Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo11Producer.java

@Component
public class Demo11Producer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Transactional
    public void syncSend(Integer id) throws InterruptedException {
        // åˆ›å»º Demo11Message æ¶ˆæ¯
        Demo11Message message = new Demo11Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo11Message.EXCHANGE, Demo11Message.ROUTING_KEY, message);
        logger.info("[syncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // <X> ç­‰å¾…
        Thread.sleep(10 * 1000L);
    }

}
```



- åœ¨å‘é€æ¶ˆæ¯æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ äº† `@Transactional` æ³¨è§£ï¼Œå£°æ˜äº‹åŠ¡ã€‚å› ä¸ºæˆ‘ä»¬åˆ›å»ºäº† RabbitTransactionManager äº‹åŠ¡ç®¡ç†å™¨ï¼Œæ‰€ä»¥è¿™é‡Œä¼šåˆ›å»º RabbitMQ äº‹åŠ¡ã€‚

- åœ¨

   

  ```
  <X>
  ```

   

  å¤„ï¼Œæˆ‘ä»¬æ•…æ„ç­‰å¾…

   

  ```
  Thread#sleep(long millis)
  ```

   

  10 ç§’ï¼Œåˆ¤æ–­ RabbitMQ äº‹åŠ¡æ˜¯å¦ç”Ÿæ•ˆã€‚

  - å¦‚æœåŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸåï¼ŒConsumer ç«‹å³æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯´æ˜æœªç”Ÿæ•ˆã€‚
  - å¦‚æœ Consumer æ˜¯ 10 ç§’ä¹‹åï¼Œæ‰æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯´æ˜å·²ç”Ÿæ•ˆã€‚

## 12.6 Demo11Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo11Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo11Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_11"` ã€‚

## 12.7 ç®€å•æµ‹è¯•

åˆ›å»º [Demo11ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-transaction/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo11ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæµ‹è¯• Producer å‘é€**äº‹åŠ¡**æ¶ˆæ¯çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo11ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo11ProducerTest {

    @Autowired
    private Demo11Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
// Producer æˆåŠŸåŒæ­¥å‘é€äº† 1 æ¡æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œäº‹åŠ¡å¹¶æœªæäº¤
2019-12-12 22:03:05.525  INFO 17729 --- [           main] c.i.s.l.r.producer.Demo11Producer        : [syncSend][å‘é€ç¼–å·ï¼š[1576159385] å‘é€æˆåŠŸ]

// 10 ç§’åï¼ŒProducer æäº¤äº‹åŠ¡ã€‚
// æ­¤æ—¶ï¼ŒConsumer æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ã€‚
2019-12-12 22:03:15.548  INFO 17729 --- [ntContainer#4-1] c.i.s.l.r.consumer.Demo11Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:25 æ¶ˆæ¯å†…å®¹ï¼šDemo11Message{id=1576159385}]
```



- Consumer åœ¨äº‹åŠ¡æ¶ˆæ¯æäº¤åï¼Œæ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ã€‚ç¬¦åˆé¢„æœŸ~