# 14. ç”Ÿäº§è€…çš„å‘é€ç¡®è®¤

åœ¨ RabbitMQ ä¸­ï¼Œ**é»˜è®¤**æƒ…å†µä¸‹ï¼ŒProducer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼Œåªä¿è¯å°†æ¶ˆæ¯å†™å…¥åˆ° TCP Socket ä¸­æˆåŠŸï¼Œå¹¶ä¸ä¿è¯æ¶ˆæ¯å‘é€åˆ° RabbitMQ Broker æˆåŠŸï¼Œå¹¶ä¸”æŒä¹…åŒ–æ¶ˆæ¯åˆ°ç£ç›˜æˆåŠŸã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸Šè¿°çš„ç¤ºä¾‹ï¼ŒProducer åœ¨å‘é€æ¶ˆæ¯éƒ½ä¸æ˜¯ç»å¯¹å¯é ï¼Œæ˜¯å­˜åœ¨ä¸¢å¤±æ¶ˆæ¯çš„å¯èƒ½æ€§ã€‚

ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œåœ¨ RabbitMQ ä¸­ï¼ŒProducer é‡‡ç”¨ Confirm æ¨¡å¼ï¼Œå®ç°å‘é€æ¶ˆæ¯çš„ç¡®è®¤æœºåˆ¶ï¼Œä»¥ä¿è¯æ¶ˆæ¯å‘é€çš„å¯é æ€§ã€‚å®ç°åŸç†å¦‚ä¸‹ï¼š

- é¦–å…ˆï¼ŒProducer é€šè¿‡è°ƒç”¨ [`Channel#confirmSelect()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1278-L1283) æ–¹æ³•ï¼Œå°† Channel è®¾ç½®ä¸º Confirm æ¨¡å¼ã€‚
- ç„¶åï¼Œåœ¨è¯¥ Channel å‘é€çš„æ¶ˆæ¯æ—¶ï¼Œéœ€è¦å…ˆé€šè¿‡ [`Channel#getNextPublishSeqNo()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1285-L1290) æ–¹æ³•ï¼Œç»™å‘é€çš„æ¶ˆæ¯åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ ID ç¼–å·(`seqNo` ä» 1 å¼€å§‹é€’å¢)ï¼Œå†å‘é€è¯¥æ¶ˆæ¯ç»™ RabbitMQ Broker ã€‚
- ä¹‹åï¼ŒRabbitMQ Broker åœ¨æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œå¹¶è¢«è·¯ç”±åˆ°ç›¸åº”çš„é˜Ÿåˆ—ä¹‹åï¼Œä¼šå‘é€ä¸€ä¸ªåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€ç¼–å·(`deliveryTag`)çš„ç¡®è®¤ç»™ Producer ã€‚

é€šè¿‡ `seqNo` ç¼–å·ï¼Œå°† Producer å‘é€æ¶ˆæ¯çš„â€œè¯·æ±‚â€ï¼Œå’Œ RabbitMQ Broker ç¡®è®¤æ¶ˆæ¯çš„â€œå“åº”â€ä¸²è”åœ¨ä¸€èµ·ã€‚

é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒProducer å°±å¯ä»¥çŸ¥é“æ¶ˆæ¯æ˜¯å¦æˆåŠŸå‘é€åˆ° RabbitMQ Broker ä¹‹ä¸­ï¼Œä¿è¯æ¶ˆæ¯å‘é€çš„å¯é æ€§ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œæ•´ä¸ªæ‰§è¡Œçš„è¿‡ç¨‹å®é™…æ˜¯**å¼‚æ­¥**ï¼Œéœ€è¦æˆ‘ä»¬è°ƒç”¨ [`Channel#waitForConfirms()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1293-L1329) æ–¹æ³•ï¼Œ**åŒæ­¥**é˜»å¡ç­‰å¾… RabbitMQ Broker ç¡®è®¤æ¶ˆæ¯çš„â€œå“åº”â€ã€‚

ä¹Ÿå› æ­¤ï¼ŒProducer é‡‡ç”¨ Confirm æ¨¡å¼æ—¶ï¼Œæœ‰ä¸‰ç§ç¼–ç¨‹æ–¹å¼ï¼š

- ã€åŒæ­¥ã€‘æ™®é€š Confirm æ¨¡å¼ï¼šProducer æ¯å‘é€ä¸€æ¡æ¶ˆæ¯åï¼Œè°ƒç”¨ `Channel#waitForConfirms()` æ–¹æ³•ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ Confirm ã€‚

- ã€åŒæ­¥ã€‘æ‰¹é‡ Confirm æ¨¡å¼ï¼šProducer æ¯å‘é€ä¸€æ‰¹æ¶ˆæ¯åï¼Œè°ƒç”¨`Channel#waitForConfirms()` æ–¹æ³•ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ Confirm ã€‚

  > æœ¬è´¨ä¸Šï¼Œå’Œã€Œæ™®é€š Confirm æ¨¡å¼ã€æ˜¯ä¸€æ ·çš„ã€‚

- ã€å¼‚æ­¥ã€‘å¼‚æ­¥ Confirm æ¨¡å¼ï¼šProducer æä¾›ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼ŒRabbitMQ Broker åœ¨ Confirm äº†ä¸€æ¡æˆ–è€…å¤šæ¡æ¶ˆæ¯åï¼ŒProducer ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•ã€‚

ğŸ˜ˆ æ›´å¤šå…³äº Producer çš„ Confirm æ¨¡å¼çš„å†…å®¹ï¼Œèƒ–å‹å¯ä»¥é˜…è¯»å¦‚ä¸‹çš„æ–‡ç« ï¼š

- [ã€ŠConsumer Acknowledgements and Publisher Confirmsã€‹](https://www.rabbitmq.com/confirms.html) çš„ç”Ÿäº§è€…éƒ¨åˆ†çš„å†…å®¹ï¼Œå¯¹åº”ä¸­æ–‡ç¿»è¯‘ä¸º [ã€Šæ¶ˆè´¹è€…åº”ç­”ï¼ˆACKï¼‰å’Œå‘å¸ƒè€…ç¡®è®¤ï¼ˆConfirmï¼‰ã€‹](https://blog.bossma.cn/rabbitmq/consumer-ack-and-publisher-confirm/) ã€‚
- [ã€ŠRabbitMQ ä¹‹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆäº‹åŠ¡ + Confirmï¼‰ã€‹](http://www.iocoder.cn/RabbitMQ/message-confirmation-mechanism-transaction-Confirm/?self) æ–‡ç« çš„[ã€ŒConfirm æ¨¡å¼ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ã€‚

åœ¨ Spring-AMQP ä¸­ï¼Œåœ¨ [ConfirmType](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/connection/CachingConnectionFactory.java#L145-L167) ä¸­ï¼Œå®šä¹‰äº†ä¸‰ç§æ¶ˆæ¯ç¡®è®¤çš„æ–¹å¼ï¼š



```
// CachingConnectionFactory#ConfirmType.java

public enum ConfirmType {

	/**
	 * Use {@code RabbitTemplate#waitForConfirms()} (or {@code waitForConfirmsOrDie()}
	 * within scoped operations.
	 */
	SIMPLE, // ä½¿ç”¨åŒæ­¥çš„ Confirm æ¨¡å¼

	/**
	 * Use with {@code CorrelationData} to correlate confirmations with sent
	 * messsages.
	 */
	CORRELATED, // ä½¿ç”¨å¼‚æ­¥çš„ Confirm æ¨¡å¼

	/**
	 * Publisher confirms are disabled (default).
	 */
	NONE // ä¸ä½¿ç”¨ Confirm æ¨¡å¼

}
```



**åœ¨ä¸Šè¿°çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨äº† Spring-AMQP é»˜è®¤çš„ `NONE` æ¨¡å¼**ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸¤ä¸ªç¤ºä¾‹ï¼š

- åœ¨[ã€Œ14.1 åŒæ­¥ Confirm æ¨¡å¼ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `SIMPLE` ç±»å‹ï¼Œå®ç°åŒæ­¥çš„ Confirm æ¨¡å¼ã€‚
- åœ¨[ã€Œ14.2 å¼‚æ­¥ Confirm æ¨¡å¼ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `CORRELATED` ç±»å‹ï¼Œä½¿ç”¨å¼‚æ­¥çš„ Confirm æ¨¡å¼ã€‚

## 14.1 åŒæ­¥ Confirm æ¨¡å¼

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-confirm](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm) ã€‚

åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `ConfirmType.SIMPLE` ç±»å‹ï¼Œå®ç°åŒæ­¥çš„ Confirm æ¨¡å¼ã€‚

è¦æ³¨æ„ï¼Œè¿™é‡Œçš„**åŒæ­¥**ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬é€šè¿‡è°ƒç”¨ [`Channel#waitForConfirms()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1293-L1329) æ–¹æ³•ï¼Œ**åŒæ­¥**é˜»å¡ç­‰å¾… RabbitMQ Broker ç¡®è®¤æ¶ˆæ¯çš„â€œå“åº”â€ã€‚

è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-confirm](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm) é¡¹ç›®ã€‚

### 14.1.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/pom.xml) æ–‡ä»¶ã€‚

### 14.1.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`resources`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/resources) ç›®å½•ä¸‹ï¼Œåˆ›å»º [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/resources/application.yaml) é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
    publisher-confirm-type: simple # è®¾ç½® Confirm ç±»å‹ä¸º SIMPLE ã€‚
```



- ç›¸æ¯”[ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡**æ–°å¢** `spring.rabbitmq.publisher-confirm-type=simple` é…ç½®é¡¹ï¼Œè®¾ç½® Confirm ç±»å‹ä¸º `ConfirmType.SIMPLE` ã€‚

åœ¨è¯¥ç±»å‹ä¸‹ï¼ŒSpring-AMQP åœ¨åˆ›å»ºå®Œ RabbitMQ Channel ä¹‹åï¼Œä¼š**è‡ªåŠ¨**è°ƒç”¨ [`Channel#confirmSelect()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1278-L1283) æ–¹æ³•ï¼Œå°† Channel è®¾ç½®ä¸º Confirm æ¨¡å¼ã€‚

### 14.1.3 Demo13Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Message](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo13Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

### 14.1.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé…ç½®ç›¸å…³çš„ Exchangeã€Queueã€Binding ã€‚

å’Œ[ã€Œ3.1.5 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

### 14.1.4 Demo13Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Producer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo13Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚



```
// Demo13Producer.java

@Component
public class Demo13Producer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º Demo13Message æ¶ˆæ¯
        Demo13Message message = new Demo13Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.invoke(new RabbitOperations.OperationsCallback<Object>() {

            @Override
            public Object doInRabbit(RabbitOperations operations) {
                // åŒæ­¥å‘é€æ¶ˆæ¯
                operations.convertAndSend(Demo13Message.EXCHANGE, Demo13Message.ROUTING_KEY, message);
                logger.info("[doInRabbit][å‘é€æ¶ˆæ¯å®Œæˆ]");
                // ç­‰å¾…ç¡®è®¤
                operations.waitForConfirms(0); // timeout å‚æ•°ï¼Œå¦‚æœä¼ é€’ 0 ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…
                logger.info("[doInRabbit][ç­‰å¾… Confirm å®Œæˆ]");
                return null;
            }

        }, new ConfirmCallback() {

            @Override
            public void handle(long deliveryTag, boolean multiple) throws IOException {
                logger.info("[handle][Confirm æˆåŠŸ]");
            }

        }, new ConfirmCallback() {

            @Override
            public void handle(long deliveryTag, boolean multiple) throws IOException {
                logger.info("[handle][Confirm å¤±è´¥]");
            }

        });

    }

}
```



- åœ¨ RabbitTemplate æä¾›çš„ API æ–¹æ³•ä¸­ï¼Œå¦‚æœ Producer è¦ä½¿ç”¨åŒæ­¥çš„ Confirm æ¨¡å¼ï¼Œéœ€è¦è°ƒç”¨ `#invoke(action, acks, nacks)` æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // RabbitOperations.java
  // RabbitTemplate å®ç°äº† RabbitOperations æ¥å£
  
  /**
   * Invoke operations on the same channel.
   * If callbacks are needed, both callbacks must be supplied.
   * @param action the callback.
   * @param acks a confirm callback for acks.
   * @param nacks a confirm callback for nacks.
   * @param <T> the return type.
   * @return the result of the action method.
   * @since 2.1
   */
  @Nullable
  <T> T invoke(OperationsCallback<T> action, @Nullable com.rabbitmq.client.ConfirmCallback acks,
  		@Nullable com.rabbitmq.client.ConfirmCallback nacks);
  ```

  

  - å› ä¸º Confirm æ¨¡å¼éœ€è¦åŸºäº**ç›¸åŒ** Channel ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨è¯¥æ–¹æ³•ã€‚
  - åœ¨æ–¹æ³•å‚æ•° `action` ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ“ä½œã€‚
  - åœ¨æ–¹æ³•å‚æ•° `acks` ä¸­ï¼Œå®šä¹‰æ¥æ”¶åˆ° RabbitMQ Broker çš„æˆåŠŸâ€œå“åº”â€æ—¶çš„æˆå›è°ƒã€‚
  - åœ¨æ–¹æ³•å‚æ•° `nacks` ä¸­ï¼Œå®šä¹‰æ¥æ”¶åˆ° RabbitMQ Broker çš„å¤±è´¥â€œå“åº”â€æ—¶çš„æˆå›è°ƒã€‚

  > - å½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…åº”ç”¨ä¾¿å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ã€‚
  > - å¦‚æœ RabbitMQ å› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡ nack æ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥ nack æ¶ˆæ¯ã€‚

- å…·ä½“çš„å‘é€æ–¹æ³•çš„ä»£ç ï¼Œèƒ–å‹æ ¹æ®è‰¿è‰¿çš„æ³¨é‡Šï¼Œè¿›è¡Œç†è§£ä¸‹ã€‚

### 14.1.5 Demo13Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Consumer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo13Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_13"` ã€‚

### 14.1.6 ç®€å•æµ‹è¯•

åˆ›å»º [Demo13ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo13ProducerTest.java) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo13Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo13ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo13ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo13Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œ `#testSyncSend()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
// ä¸»çº¿ç¨‹ï¼ŒProducer å‘é€ 1 æ¡æ¶ˆæ¯å®Œæˆã€‚
2019-12-13 12:49:13.680  INFO 13247 --- [           main] c.i.s.l.r.producer.Demo13Producer        : [doInRabbit][å‘é€æ¶ˆæ¯å®Œæˆ]

// AMQConnection çº¿ç¨‹ï¼ŒProducer ç¡®è®¤æ”¶åˆ° RabbitMQ Broker å¯¹è¯¥æ¶ˆæ¯çš„æˆåŠŸâ€œå“åº”â€ ã€‚
2019-12-13 12:49:13.689  INFO 13247 --- [ 127.0.0.1:5672] c.i.s.l.r.producer.Demo13Producer        : [handle][Confirm æˆåŠŸ]

// ä¸»çº¿ç¨‹ï¼ŒProducer ç­‰å¾…è¯¥æ¶ˆæ¯çš„ Confirm å®Œæˆã€‚
2019-12-13 12:49:13.689  INFO 13247 --- [           main] c.i.s.l.r.producer.Demo13Producer        : [doInRabbit][ç­‰å¾… Confirm å®Œæˆ]

// å•å…ƒæµ‹è¯•ï¼Œæ‰“å°ä¸‹æ—¥å¿—ï¼Œå¯ä»¥å¿½ç•¥
2019-12-13 12:49:13.694  INFO 13247 --- [           main] c.i.s.l.r.producer.Demo13ProducerTest    :
[testSyncSend][å‘é€ç¼–å·ï¼š[1576212553] å‘é€æˆåŠŸ]

// æ¶ˆè´¹è€…çš„çº¿ç¨‹ï¼ŒConsumer æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯
2019-12-13 12:49:13.699  INFO 13247 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo13Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo13Message{id=1576212553}]
```



- ç¬¦åˆé¢„æœŸ~æ•´ä¸ªè¿‡ç¨‹ï¼Œå¥½å¥½ç†è§£è‰¿è‰¿åœ¨æ—¥å¿—ä¸Šï¼Œæ·»åŠ çš„è¿‡ç¨‹æ³¨é‡Šå™¢ã€‚

## 14.2 å¼‚æ­¥ Confirm æ¨¡å¼

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-confirm-async](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async) ã€‚

åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `ConfirmType.SIMPLE` ç±»å‹ï¼Œå®ç°å¼‚æ­¥çš„ Confirm æ¨¡å¼ã€‚

è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-demo-confirm-async](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async) é¡¹ç›®ã€‚

### 14.2.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/pom.xml) æ–‡ä»¶ã€‚

### 14.2.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`resources`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/resources) ç›®å½•ä¸‹ï¼Œåˆ›å»º [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/resources/application.yaml) é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
    publisher-confirm-type: correlated # è®¾ç½® Confirm ç±»å‹ä¸º CORRELATED ã€‚
```



- ç›¸æ¯”[ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡**æ–°å¢** `spring.rabbitmq.publisher-confirm-type=correlated` é…ç½®é¡¹ï¼Œè®¾ç½® Confirm ç±»å‹ä¸º `ConfirmType.CORRELATED` ã€‚

åœ¨è¯¥ç±»å‹ä¸‹ï¼ŒSpring-AMQP åœ¨åˆ›å»ºå®Œ RabbitMQ Channel ä¹‹åï¼Œä¹Ÿä¼š**è‡ªåŠ¨**è°ƒç”¨ [`Channel#confirmSelect()`](https://github.com/rabbitmq/rabbitmq-java-client/blob/master/src/main/java/com/rabbitmq/client/Channel.java#L1278-L1283) æ–¹æ³•ï¼Œå°† Channel è®¾ç½®ä¸º Confirm æ¨¡å¼ã€‚

### 14.2.3 Demo13Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo13Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚

å’Œ[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

### 14.2.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé…ç½®ç›¸å…³çš„ Exchangeã€Queueã€Binding ã€‚

å’Œ[ã€Œ3.1.5 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€Queueã€RoutingKey åå­—ä¸åŒã€‚

### 14.2.5 RabbitProducerConfirmCallback

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.core`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/core/) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitProducerConfirmCallback](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/core/RabbitProducerConfirmCallback.java) ç±»ï¼Œå®ç° [RabbitTemplate.ConfirmCallback](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitTemplate.java#L2712-L2727) æ¥å£ï¼Œæä¾› Producer æ”¶åˆ° RabbitMQ ç¡®è®¤æ¶ˆæ¯çš„â€œå“åº”â€çš„å›è°ƒã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitProducerConfirmCallback.java

@Component
public class RabbitProducerConfirmCallback implements RabbitTemplate.ConfirmCallback {

    private Logger logger = LoggerFactory.getLogger(getClass());

    public RabbitProducerConfirmCallback(RabbitTemplate rabbitTemplate) {
        rabbitTemplate.setConfirmCallback(this);
    }

    @Override
    public void confirm(CorrelationData correlationData, boolean ack, String cause) {
        if (ack) {
            logger.info("[confirm][Confirm æˆåŠŸ correlationData: {}]", correlationData);
        } else {
            logger.error("[confirm][Confirm å¤±è´¥ correlationData: {} cause: {}]", correlationData, cause);
        }
    }

}
```



- åœ¨æ„é€ æ–¹æ³•ä¸­ï¼ŒæŠŠè‡ªå·±è®¾ç½®åˆ° RabbitTemplate ä¸­ï¼Œä½œä¸º Confirm çš„å›è°ƒã€‚
- åœ¨ `#confirm(...)` æ–¹æ³•ä¸­ï¼Œæ ¹æ®æ˜¯å¦ `ack` æˆåŠŸï¼Œæ‰“å°ä¸åŒçš„æ—¥å¿—ã€‚

### 14.2.6 Demo13Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo13Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚



```
// Demo13Producer.java

@Component
public class Demo13Producer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void syncSend(Integer id) {
        // åˆ›å»º Demo13Message æ¶ˆæ¯
        Demo13Message message = new Demo13Message();
        message.setId(id);
        // åŒæ­¥å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(Demo13Message.EXCHANGE, Demo13Message.ROUTING_KEY, message);
    }

}
```



- ä¸éœ€è¦åƒ[ã€Œ14.1.4 Demo13Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€æ ·ï¼Œè€Œæ˜¯ç›´æ¥åƒæˆ‘ä»¬å…¶å®ƒç¤ºä¾‹ä¸€æ ·ï¼Œç›´æ¥ä½¿ç”¨ RabbitTemplate çš„ `#convertAndSend(...)` ç­‰ç­‰æ–¹æ³•å³å¯ã€‚

### 14.2.7 Demo13Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo13Consumer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo13Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.7 Demo01Consumerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºæ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"QUEUE_DEMO_13"` ã€‚

### 14.2.8 ç®€å•æµ‹è¯•

åˆ›å»º [Demo13ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo13Producer å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo13ProducerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class Demo13ProducerTest {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private Demo13Producer producer;

    @Test
    public void testSyncSend() throws InterruptedException {
        int id = (int) (System.currentTimeMillis() / 1000);
        producer.syncSend(id);
        logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

        // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
        new CountDownLatch(1).await();
    }

}
```



æ‰§è¡Œ `#testSyncSend()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
// å•å…ƒæµ‹è¯•ï¼Œæ‰“å°ä¸‹æ—¥å¿—ï¼Œå¯ä»¥å¿½ç•¥
2019-12-13 17:17:45.849  INFO 69003 --- [           main] c.i.s.l.r.producer.Demo13ProducerTest    :
[testSyncSend][å‘é€ç¼–å·ï¼š[1576228665] å‘é€æˆåŠŸ]

// RabbitConnectionFactory çº¿ç¨‹ï¼ŒProducer ç¡®è®¤æ”¶åˆ° RabbitMQ Broker å¯¹è¯¥æ¶ˆæ¯çš„æˆåŠŸâ€œå“åº”â€ ã€‚
// å› ä¸ºæˆ‘ä»¬åœ¨ Demo13Producer å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¹¶æœªä¼ å…¥ CorrelationData å‚æ•°ï¼Œæ‰€ä»¥ä¸º null ã€‚
2019-12-13 17:17:45.859  INFO 69003 --- [nectionFactory1] .i.s.l.r.c.RabbitProducerConfirmCallback : [confirm][Confirm æˆåŠŸ correlationData: null]

// æ¶ˆè´¹è€…çš„çº¿ç¨‹ï¼ŒConsumer æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯
2019-12-13 17:17:45.873  INFO 69003 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo13Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo13Message{id=1576228665}]
```



- ç¬¦åˆé¢„æœŸ~æ•´ä¸ªè¿‡ç¨‹ï¼Œå¥½å¥½ç†è§£è‰¿è‰¿åœ¨æ—¥å¿—ä¸Šï¼Œæ·»åŠ çš„è¿‡ç¨‹æ³¨é‡Šå™¢ã€‚

## 14.3 ReturnCallback

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-demo-confirm-async](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async) ã€‚

å½“ Producer æˆåŠŸå‘é€æ¶ˆæ¯åˆ° RabbitMQ Broker æ—¶ï¼Œä½†æ˜¯åœ¨é€šè¿‡ Exchange è¿›è¡Œ**åŒ¹é…ä¸åˆ°** Queue æ—¶ï¼ŒBroker ä¼šå°†è¯¥æ¶ˆæ¯å›é€€ç»™ Producer ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼Œç»§ç»­åœ¨ [lab-04-rabbitmq-demo-confirm-async](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async) é¡¹ç›®æ”¹é€ ã€‚

### 14.3.1 RabbitProducerReturnCallback

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.core`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/core/) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitProducerReturnCallback](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/core/RabbitProducerReturnCallback.java) ç±»ï¼Œå®ç° [RabbitTemplate.ReturnCallback](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitTemplate.java#L2712-L2727) æ¥å£ï¼Œæä¾› Producer æ”¶åˆ° RabbitMQ Broker å›é€€æ¶ˆæ¯çš„çš„å›è°ƒã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitProducerReturnCallback.java

@Component
public class RabbitProducerReturnCallback implements RabbitTemplate.ReturnCallback {

    private Logger logger = LoggerFactory.getLogger(getClass());

    public RabbitProducerReturnCallback(RabbitTemplate rabbitTemplate) {
        rabbitTemplate.setReturnCallback(this);
    }

    @Override
    public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) {
        logger.error("[returnedMessage][message: [{}] replyCode: [{}] replyText: [{}] exchange: [{}] routingKey: [{}]]",
                message, replyCode, replyText, exchange, routingKey);
    }

}
```



- åœ¨æ„é€ æ–¹æ³•ä¸­ï¼ŒæŠŠè‡ªå·±è®¾ç½®åˆ° RabbitTemplate ä¸­ï¼Œä½œä¸ºæ¶ˆæ¯ Return çš„å›è°ƒã€‚
- åœ¨ `#returnedMessage(...)` æ–¹æ³•ä¸­ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ã€‚å½“ç„¶ï¼Œå…·ä½“æ€ä¹ˆå¤„ç†ï¼Œèƒ–å‹å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å“ˆã€‚

### 14.3.2 Demo13Producer

ä¿®æ”¹ [Demo13Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo13Producer.java) ç±»ï¼Œå¢åŠ ä¸€ä¸ªå‘é€æ— æ³•åŒ¹é…åˆ° Queue çš„æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo13Producer.java

public void syncSendReturn(Integer id) {
    // åˆ›å»º Demo13Message æ¶ˆæ¯
    Demo13Message message = new Demo13Message();
    message.setId(id);
    // åŒæ­¥å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend(Demo13Message.EXCHANGE, "error", message);
}
```



- å‘é€æ¶ˆæ¯çš„ RoutingKey ï¼Œæˆ‘ä»¬æ•…æ„è®¾ç½®ä¸º `error` ï¼Œè¾¾åˆ°æ¶ˆæ¯æ— æ³•åŒ¹é…åˆ° Queue çš„æ•ˆæœã€‚

### 14.3.3 ç®€å•æµ‹è¯•

ä¿®æ”¹ [Demo13ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-confirm-async/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo13ProducerTest.java) æµ‹è¯•ç±»ï¼Œå¢åŠ è°ƒç”¨ Demo13Producer æ–°å¢çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo13ProducerTest.java

@Test
public void testSyncSendReturn() throws InterruptedException {
    int id = (int) (System.currentTimeMillis() / 1000);
    producer.syncSendReturn(id);
    logger.info("[testSyncSendReturn][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸ]", id);

    // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
    new CountDownLatch(1).await();
}
```



æ‰§è¡Œ `#testSyncSendReturn()` å•å…ƒæµ‹è¯•ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š



```
// å•å…ƒæµ‹è¯•ï¼Œæ‰“å°ä¸‹æ—¥å¿—ï¼Œå¯ä»¥å¿½ç•¥
2019-12-13 17:40:57.130  INFO 74326 --- [           main] c.i.s.l.r.producer.Demo13ProducerTest    : [testSyncSendReturn][å‘é€ç¼–å·ï¼š[1576230057] å‘é€æˆåŠŸ]

// RabbitConnectionFactory çº¿ç¨‹ï¼ŒProducer ç¡®è®¤æ”¶åˆ° RabbitMQ Broker å¯¹è¯¥æ¶ˆæ¯çš„é€€å› ã€‚
2019-12-13 17:41:02.817 ERROR 74326 --- [nectionFactory1] c.i.s.l.r.c.RabbitProducerReturnCallback : [returnedMessage][message: [(Body:'[B@4689be61(byte[187])' MessageProperties [headers={}, contentType=application/x-java-serialized-object, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, deliveryTag=0])] replyCode: [312] replyText: [NO_ROUTE] exchange: [EXCHANGE_DEMO_13] routingKey: []]

// RabbitConnectionFactory çº¿ç¨‹ï¼ŒProducer ç¡®è®¤æ”¶åˆ° RabbitMQ Broker å¯¹è¯¥æ¶ˆæ¯çš„æˆåŠŸâ€œå“åº”â€ ã€‚
// æ³¨æ„ï¼Œå³ä½¿å­˜åœ¨ RabbitMQ Broker å›é€€æ¶ˆæ¯çš„æƒ…å†µï¼Œä¾ç„¶ä¼šæ”¶åˆ°å¯¹è¯¥æ¶ˆæ¯çš„æˆåŠŸâ€œå“åº”â€
2019-12-13 17:41:02.819  INFO 74326 --- [nectionFactory1] .i.s.l.r.c.RabbitProducerConfirmCallback : [confirm][Confirm æˆåŠŸ correlationData: null]
```



- ç¬¦åˆé¢„æœŸ~æ•´ä¸ªè¿‡ç¨‹ï¼Œå¥½å¥½ç†è§£è‰¿è‰¿åœ¨æ—¥å¿—ä¸Šï¼Œæ·»åŠ çš„è¿‡ç¨‹æ³¨é‡Šå™¢ã€‚