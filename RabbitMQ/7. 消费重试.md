# 7. æ¶ˆè´¹é‡è¯•

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-04-rabbitmq-consume-retry](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry)

åœ¨å¼€å§‹æœ¬å°èŠ‚ä¹‹å‰ï¼Œèƒ–å‹é¦–å…ˆè¦å¯¹ RabbitMQ çš„[æ­»ä¿¡é˜Ÿåˆ—](https://www.rabbitmq.com/dlx.html)çš„æœºåˆ¶ï¼Œæœ‰ä¸€å®šçš„äº†è§£ã€‚ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹[ã€ŠRabbitMQ ä¹‹æ­»ä¿¡é˜Ÿåˆ—ã€‹](http://www.iocoder.cn/RabbitMQ/dead-letter-queue/?self)æ–‡ç« ã€‚

åœ¨æ¶ˆæ¯**æ¶ˆè´¹å¤±è´¥**çš„æ—¶å€™ï¼ŒSpring-AMQP ä¼šé€šè¿‡**æ¶ˆè´¹é‡è¯•**æœºåˆ¶ï¼Œé‡æ–°æŠ•é€’è¯¥æ¶ˆæ¯ç»™ Consumer ï¼Œè®© Consumer æœ‰æœºä¼šé‡æ–°æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®ç°æ¶ˆè´¹æˆåŠŸã€‚

å½“ç„¶ï¼ŒSpring-AMQP å¹¶ä¸ä¼šæ— é™é‡æ–°æŠ•é€’æ¶ˆæ¯ç»™ Consumer é‡æ–°æ¶ˆè´¹ï¼Œè€Œæ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¾¾åˆ° N æ¬¡é‡è¯•æ¬¡æ•°æ—¶ï¼ŒConsumer è¿˜æ˜¯æ¶ˆè´¹å¤±è´¥æ—¶ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¿›å…¥åˆ°**æ­»ä¿¡é˜Ÿåˆ—**ã€‚åç»­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡å‘ï¼Œæ¥ä½¿å¾—æ¶ˆè´¹è€…å®ä¾‹å†æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚

- åœ¨[ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RocketMQ/?self)çš„[ã€Œ6. æ¶ˆè´¹é‡è¯•ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆè´¹é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—ï¼Œæ˜¯ RocketMQ è‡ªå¸¦çš„åŠŸèƒ½ã€‚
- è€Œåœ¨ RabbitMQ ä¸­ï¼Œæ¶ˆè´¹é‡è¯•æ˜¯ç”± Spring-AMQP æ‰€å°è£…æä¾›çš„ï¼Œæ­»ä¿¡é˜Ÿåˆ—æ˜¯ RabbitMQ è‡ªå¸¦çš„åŠŸèƒ½ã€‚

é‚£ä¹ˆæ¶ˆè´¹å¤±è´¥åˆ°è¾¾æœ€å¤§æ¬¡æ•°çš„æ¶ˆæ¯ï¼Œæ˜¯æ€ä¹ˆè¿›å…¥åˆ°æ­»ä¿¡é˜Ÿåˆ—çš„å‘¢ï¼ŸSpring-AMQP åœ¨æ¶ˆæ¯åˆ°è¾¾æœ€å¤§æ¶ˆè´¹æ¬¡æ•°çš„æ—¶å€™ï¼Œä¼šå°†è¯¥æ¶ˆæ¯è¿›è¡Œå¦å®š(`basic.nack`)ï¼Œå¹¶ä¸” `requeue=false` ï¼Œè¿™æ ·åç»­å°±å¯ä»¥åˆ©ç”¨ RabbitMQ çš„[æ­»ä¿¡é˜Ÿåˆ—](https://www.rabbitmq.com/dlx.html)çš„æœºåˆ¶ï¼Œå°†è¯¥æ¶ˆæ¯è½¬å‘åˆ°æ­»ä¿¡é˜Ÿåˆ—ã€‚

å¦å¤–ï¼Œæ¯æ¡æ¶ˆæ¯çš„å¤±è´¥é‡è¯•ï¼Œæ˜¯å¯ä»¥é…ç½®ä¸€å®šçš„**é—´éš”æ—¶é—´**ã€‚å…·ä½“ï¼Œæˆ‘ä»¬åœ¨ç¤ºä¾‹çš„ä»£ç ä¸­ï¼Œæ¥è¿›è¡Œå…·ä½“çš„è§£é‡Šã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª Consumer æ¶ˆè´¹é‡è¯•çš„ç¤ºä¾‹ã€‚è€ƒè™‘åˆ°ä¸æ±¡æŸ“ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª [lab-04-rabbitmq-consume-retry](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry) é¡¹ç›®ã€‚

## 7.1 å¼•å…¥ä¾èµ–

å’Œ [ã€Œ3.1.1 å¼•å…¥ä¾èµ–ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) ä¸€è‡´ï¼Œè§ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/pom.xml) æ–‡ä»¶ã€‚

## 7.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`resources`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/resources) ç›®å½•ä¸‹ï¼Œåˆ›å»º [`application.yaml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/resources/application.yaml) é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
    listener:
      simple:
        # å¯¹åº” RabbitProperties.ListenerRetry ç±»
        retry:
          enabled: true # å¼€å¯æ¶ˆè´¹é‡è¯•æœºåˆ¶
          max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 3 ã€‚
          initial-interval: 1000 # é‡è¯•é—´éš”ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚é»˜è®¤ä¸º 1000 ã€‚
```



- ç›¸æ¯”[ã€Œ3.1.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡**æ–°å¢** `spring.rabbitmq.simple.retry.enable=true` é…ç½®é¡¹ï¼Œæ¥å¼€å¯ Spring-AMQP çš„æ¶ˆè´¹é‡è¯•çš„åŠŸèƒ½ã€‚åŒæ—¶ï¼Œé€šè¿‡**æ–°å¢** `max-attempts` å’Œ `initial-interval` é…ç½®é¡¹ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•°å’Œé—´éš”ã€‚

  > `max-attempts` é…ç½®é¡¹è¦æ³¨æ„ï¼Œæ˜¯ä¸€æ¡æ¶ˆæ¯ä¸€å…±å°è¯•æ¶ˆè´¹æ€»å…± `max-attempts` æ¬¡ï¼ŒåŒ…æ‹¬é¦–æ¬¡çš„æ­£å¸¸æ¶ˆè´¹ã€‚

- å¦å¤–ï¼Œèƒ–å‹å¯ä»¥é€šè¿‡æ·»åŠ  `spring.rabbitmq.listener.simple.retry.multiplier` é…ç½®é¡¹æ¥å®ç°**é€’ä¹˜**çš„æ—¶é—´é—´éš”ï¼Œæ·»åŠ  `spring.rabbitmq.listener.simple.retry.max-interval` é…ç½®é¡¹æ¥å®ç°**æœ€å¤§**çš„æ—¶é—´é—´éš”ã€‚

åœ¨ Spring-AMQP çš„æ¶ˆè´¹é‡è¯•æœºåˆ¶ä¸­ï¼Œåœ¨æ¶ˆè´¹å¤±è´¥åˆ°è¾¾æœ€å¤§æ¬¡æ•°åï¼Œä¼š**è‡ªåŠ¨**æŠ›å‡º [AmqpRejectAndDontRequeueException](https://github.com/spring-projects/spring-amqp/blob/master/spring-amqp/src/main/java/org/springframework/amqp/AmqpRejectAndDontRequeueException.java) å¼‚å¸¸ï¼Œä»è€Œç»“æŸè¯¥æ¶ˆæ¯çš„æ¶ˆè´¹é‡è¯•ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„é€»è¾‘ä¸­ï¼Œ**ä¸»åŠ¨**æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸ï¼Œä¹Ÿèƒ½ç»“æŸè¯¥æ¶ˆæ¯çš„æ¶ˆè´¹é‡è¯•ã€‚ğŸ˜ˆ ç»“æŸçš„æ–¹å¼ï¼ŒSpring-AMQP æ˜¯é€šè¿‡æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ `basic.nack` + `requeue=false` ï¼Œä»è€Œå®ç°è½¬å‘è¯¥æ¶ˆæ¯åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚

å¦å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`spring.rabbitmq.simple.retry.enable=false` ï¼Œå…³é—­ Spring-AMQP çš„æ¶ˆè´¹é‡è¯•åŠŸèƒ½ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œæ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸çš„æ¶ˆæ¯ï¼Œè¿˜æ˜¯ä¼šä¸€ç›´**é‡æ–°æ¶ˆè´¹**ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŸSpring-AMQP ä¼šå°†è¯¥æ¶ˆæ¯é€šè¿‡ `basic.nack` + `requeue=true` ï¼Œé‡æ–°æŠ•é€’å›**åŸé˜Ÿåˆ—çš„å°¾å·´**ã€‚å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¾¿ä¼šä¸æ–­æ‹‰å–åˆ°è¯¥æ¶ˆæ¯ï¼Œä¸æ–­â€œé‡è¯•â€æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å½“ç„¶åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸€æ ·å¯ä»¥**ä¸»åŠ¨**æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸ï¼Œä¹Ÿèƒ½ç»“æŸè¯¥æ¶ˆæ¯çš„æ¶ˆè´¹é‡è¯•ã€‚ğŸ˜ˆ ç»“æŸçš„æ–¹å¼ï¼ŒSpring-AMQP ä¹Ÿæ˜¯é€šè¿‡æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ `basic.nack` + `requeue=false` ï¼Œä»è€Œå®ç°è½¬å‘è¯¥æ¶ˆæ¯åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç®€å•è¯´è¯´ Spring-AMQP æ˜¯æ€ä¹ˆæä¾›**æ¶ˆè´¹é‡è¯•**çš„åŠŸèƒ½çš„ã€‚

- Spring-AMQP åŸºäº [spring-retry](https://github.com/spring-projects/spring-retry) é¡¹ç›®æä¾›çš„ [RetryTemplate](https://github.com/spring-projects/spring-retry/blob/master/src/main/java/org/springframework/retry/support/RetryTemplate.java) ï¼Œå®ç°é‡è¯•åŠŸèƒ½ã€‚Spring-AMQP åœ¨è·å–åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šäº¤ç»™ RetryTemplate æ¥è°ƒç”¨æ¶ˆè´¹è€… Consumer çš„ç›‘å¬å™¨ Listener(å°±æ˜¯æˆ‘ä»¬å®ç°çš„)ï¼Œå®ç°è¯¥æ¶ˆæ¯çš„**å¤šæ¬¡**æ¶ˆè´¹é‡è¯•ã€‚

- åœ¨è¯¥æ¶ˆæ¯çš„**æ¯æ¬¡æ¶ˆè´¹å¤±è´¥**åï¼ŒRetryTemplate ä¼šé€šè¿‡ [BackOffPolicy](https://github.com/spring-projects/spring-retry/blob/master/src/main/java/org/springframework/retry/backoff/BackOffPolicy.java) æ¥è¿›è¡Œè®¡ç®—ï¼Œè¯¥æ¶ˆæ¯çš„**ä¸‹ä¸€æ¬¡é‡æ–°æ¶ˆè´¹çš„æ—¶é—´**ï¼Œé€šè¿‡ `Thread#sleep(...)` æ–¹æ³•ï¼Œå®ç°é‡æ–°æ¶ˆè´¹çš„æ—¶é—´é—´éš”ã€‚åˆ°è¾¾æ—¶é—´é—´éš”åï¼ŒRetryTemplate åˆä¼šè°ƒç”¨æ¶ˆè´¹è€… Consumer çš„ç›‘å¬å™¨ Listener æ¥æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚

- å½“è¯¥æ¶ˆæ¯çš„é‡è¯•æ¶ˆè´¹åˆ°è¾¾**ä¸Šé™**åï¼ŒRetryTemplate ä¼šè°ƒç”¨ [MethodInvocationRecoverer](https://github.com/spring-projects/spring-retry/blob/master/src/main/java/org/springframework/retry/interceptor/MethodInvocationRecoverer.java) å›è°ƒæ¥å®ç°æ¢å¤ã€‚è€Œ Spring-AMQP è‡ªå®šä¹‰å®ç°äº† [RejectAndDontRequeueRecoverer](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/retry/RejectAndDontRequeueRecoverer.java) æ¥**è‡ªåŠ¨**æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸ï¼Œä»è€Œç»“æŸè¯¥æ¶ˆæ¯çš„æ¶ˆè´¹é‡è¯•ã€‚ğŸ˜ˆ ç»“æŸçš„æ–¹å¼ï¼ŒSpring-AMQP æ˜¯é€šè¿‡æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ `basic.nack` + `requeue=false` ï¼Œä»è€Œå®ç°è½¬å‘è¯¥æ¶ˆæ¯åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚

- æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒSpring-AMQP æä¾›çš„æ¶ˆè´¹é‡è¯•çš„**è®¡æ•°**æ˜¯**å®¢æˆ·ç«¯**çº§åˆ«çš„ï¼Œé‡å¯ JVM åº”ç”¨åï¼Œè®¡æ•°æ˜¯ä¼šä¸¢å¤±çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦è®¡æ•°è¿›è¡ŒæŒä¹…åŒ–ï¼Œéœ€è¦è‡ªå·±é‡æ–°å®ç°ä¸‹ã€‚

  > ğŸ˜ˆ RocketMQ æä¾›çš„æ¶ˆè´¹é‡è¯•çš„è®¡æ•°ï¼Œç›®å‰æ˜¯**æœåŠ¡ç«¯**çº§åˆ«ï¼Œå·²ç»è¿›è¡ŒæŒä¹…åŒ–ã€‚

> ğŸ˜œ çå“”å“”äº†å¥½é•¿ä¸€æ®µï¼Œæ¶‰åŠåˆ°çš„ä¿¡æ¯é‡å¯èƒ½æ¯”è¾ƒå¤§ï¼Œå¦‚æœè‰¿è‰¿æœ‰è§£é‡Šä¸æ¸…æ™°æˆ–è€…é”™è¯¯çš„åœ°æ–¹ï¼Œåˆæˆ–è€…å“ªé‡Œä¸äº†è§£ï¼Œå¯ä»¥ç»™è‰¿è‰¿ç•™è¨€ï¼Œä¹æ„ä¹‹è‡³ä¸ºèƒ–å‹è§£ç­”ã€‚
>
> åŒæ—¶ï¼Œä¹Ÿå¯ä»¥è°ƒè¯•ä¸‹æ•´ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°çš„æºç ï¼Œæ›´åŠ å…·è±¡ä¸‹ã€‚ã€Œæºç ä¹‹å‰ï¼Œäº†æ— ç§˜å¯†ã€ã€‚

## 7.3 Demo07Message

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.message`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo07Message](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/message/Demo07Message.java) æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo07Message.java


    public static final String QUEUE = "QUEUE_DEMO_07"; // æ­£å¸¸é˜Ÿåˆ—
    public static final String DEAD_QUEUE = "DEAD_QUEUE_DEMO_07"; // æ­»ä¿¡é˜Ÿåˆ—

    public static final String EXCHANGE = "EXCHANGE_DEMO_07";

    public static final String ROUTING_KEY = "ROUTING_KEY_07"; // æ­£å¸¸è·¯ç”±é”®
    public static final String DEAD_ROUTING_KEY = "DEAD_ROUTING_KEY_07"; // æ­»ä¿¡è·¯ç”±é”®


    /**
     * ç¼–å·
     */
    private Integer id;

    // ... çœç•¥ set/get/toString æ–¹æ³•

}
```



- ç›¸æ¯”[ã€Œ3.1.4 Demo01Messageã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œé¢å¤–å¢åŠ äº†æ­»ä¿¡é˜Ÿåˆ—ä¼šç”¨åˆ°çš„ Queue å’Œ RoutingKey ï¼Œè€Œ Exchange æˆ‘ä»¬å…ˆå¤ç”¨ `EXCHANGE = "EXCHANGE_DEMO_07"` ã€‚

## 7.4 RabbitConfig

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config) åŒ…ä¸‹ï¼Œåˆ›å»º [RabbitConfig](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/config/RabbitConfig.java) é…ç½®ç±»ï¼Œé¢å¤–æ·»åŠ **æ­»ä¿¡é˜Ÿåˆ—**çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RabbitConfig.java

@Configuration
public class RabbitConfig {

    /**
     * Direct Exchange ç¤ºä¾‹çš„é…ç½®ç±»
     */
    public static class DirectExchangeDemoConfiguration {

        // åˆ›å»º Queue
        @Bean
        public Queue demo07Queue() {
            return QueueBuilder.durable(Demo07Message.QUEUE) // durable: æ˜¯å¦æŒä¹…åŒ–
                    .exclusive() // exclusive: æ˜¯å¦æ’å®ƒ
                    .autoDelete() // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
                    .deadLetterExchange(Demo07Message.EXCHANGE)
                    .deadLetterRoutingKey(Demo07Message.DEAD_ROUTING_KEY)
                    .build();
        }

        // åˆ›å»º Dead Queue
        @Bean
        public Queue demo07DeadQueue() {
            return new Queue(Demo07Message.DEAD_QUEUE, // Queue åå­—
                    true, // durable: æ˜¯å¦æŒä¹…åŒ–
                    false, // exclusive: æ˜¯å¦æ’å®ƒ
                    false); // autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤
        }

        // åˆ›å»º Direct Exchange
        @Bean
        public DirectExchange demo07Exchange() {
            return new DirectExchange(Demo07Message.EXCHANGE,
                    true,  // durable: æ˜¯å¦æŒä¹…åŒ–
                    false);  // exclusive: æ˜¯å¦æ’å®ƒ
        }

        // åˆ›å»º Binding
        // Exchangeï¼šDemo07Message.EXCHANGE
        // Routing keyï¼šDemo07Message.ROUTING_KEY
        // Queueï¼šDemo07Message.QUEUE
        @Bean
        public Binding demo07Binding() {
            return BindingBuilder.bind(demo07Queue()).to(demo07Exchange()).with(Demo07Message.ROUTING_KEY);
        }

        // åˆ›å»º Dead Binding
        // Exchangeï¼šDemo07Message.EXCHANGE
        // Routing keyï¼šDemo07Message.DEAD_ROUTING_KEY
        // Queueï¼šDemo07Message.DEAD_QUEUE
        @Bean
        public Binding demo07DeadBinding() {
            return BindingBuilder.bind(demo07DeadQueue()).to(demo07Exchange()).with(Demo07Message.DEAD_ROUTING_KEY);
        }

    }

}
```



- ç›¸æ¯”[ã€Œ3.1.5 RabbitConfigã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)æ¥è¯´ï¼Œä¸»è¦æœ‰**ä¸¤ä¸ª**å·®å¼‚ç‚¹ã€‚
- ç¬¬ä¸€ç‚¹ï¼Œåˆ›å»ºçš„æ­£å¸¸ Queue é¢å¤–è®¾ç½®äº†ï¼Œå½“æ¶ˆæ¯æˆä¸ºæ­»ä¿¡æ—¶ï¼ŒRabbitMQ è‡ªåŠ¨è½¬å‘åˆ° Exchange ä¸º `Demo07Message.EXCHANGE`ï¼ŒRoutingKey ä¸º `Demo07Message.DEAD_ROUTING_KEY` çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚
- ç¬¬äºŒç‚¹ï¼Œé€šè¿‡ `#demo07DeadQueue()` æ–¹æ³•æ¥åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—çš„ Queue ï¼Œé€šè¿‡ `#demo07DeadBinding()` æ–¹æ³•æ¥åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—çš„ Binding ã€‚ğŸ˜ˆ å› ä¸ºæˆ‘ä»¬é‡ç”¨äº† Exchange ä¸º `Demo07Message.EXCHANGE` ï¼Œæ‰€ä»¥æ— éœ€åˆ›å»ºã€‚å½“ç„¶ï¼Œèƒ–å‹ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œåˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—çš„ Exchange ã€‚

## 7.5 Demo07Producer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.producer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo07Producer](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-demo-batch-consume-02/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo07Producer.java) ç±»ï¼Œå®ƒä¼šä½¿ç”¨ Spring-AMQP å°è£…æä¾›çš„ RabbitTemplate ï¼Œå®ç°å‘é€æ¶ˆæ¯ã€‚

å’Œ[ã€Œ3.1.6 Demo01Producerã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#)ä¸€è‡´ï¼Œåªæ˜¯ Exchangeã€RoutingKey åå­—ä¸åŒã€‚

## 7.6 Demo07Consumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo07Consumer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo07Consumer.java) ç±»ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo07Consumer.java

@Component
@RabbitListener(queues = Demo07Message.QUEUE)
public class Demo07Consumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo07Message message) {
        logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        // <X> æ³¨æ„ï¼Œæ­¤å¤„æŠ›å‡ºä¸€ä¸ª RuntimeException å¼‚å¸¸ï¼Œæ¨¡æ‹Ÿæ¶ˆè´¹å¤±è´¥
        throw new RuntimeException("æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸");
    }

}
```



- åœ¨ `<X>` å¤„ï¼Œæˆ‘ä»¬åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶å€™ï¼ŒæŠ›å‡ºä¸€ä¸ª RuntimeException å¼‚å¸¸ï¼Œæ¨¡æ‹Ÿæ¶ˆè´¹å¤±è´¥ã€‚

## 7.7 Demo07DeadConsumer

åœ¨ [`cn.iocoder.springboot.lab04.rabbitmqdemo.consumer`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/) åŒ…ä¸‹ï¼Œåˆ›å»º [Demo07DeadConsumer](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/main/java/cn/iocoder/springboot/lab04/rabbitmqdemo/consumer/Demo07DeadConsumer.java) ç±»ï¼Œæ¶ˆè´¹**æ­»ä¿¡é˜Ÿåˆ—**çš„æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Demo07DeadConsumer.java

@Component
@RabbitListener(queues = Demo07Message.DEAD_QUEUE)
public class Demo07DeadConsumer {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @RabbitHandler
    public void onMessage(Demo07Message message) {
        logger.info("[onMessage][ã€æ­»ä¿¡é˜Ÿåˆ—ã€‘çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    }

}
```



- åœ¨ç±»ä¸Šï¼Œæ·»åŠ äº† [`@RabbitListener`](https://github.com/spring-projects/spring-amqp/blob/master/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/annotation/RabbitListener.java) æ³¨è§£ï¼Œå£°æ˜äº†æ¶ˆè´¹çš„é˜Ÿåˆ—æ˜¯ `"DEAD_QUEUE_DEMO_07"` è¿™ä¸ª**æ­»ä¿¡é˜Ÿåˆ—**ã€‚

è¿™é‡Œçš„æ¶ˆè´¹é€»è¾‘ï¼Œä»…ä»…æ˜¯ç¤ºä¾‹ï¼Œå®ç°é€»è¾‘èƒ–å‹æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œè‡ªå·±æ¥å…·ä½“å®ç°ï¼Œå˜¿å˜¿ã€‚

## 7.8 ç®€å•æµ‹è¯•

å’Œ [ã€Œ3.1.8 ç®€å•æµ‹è¯•ã€](https://www.iocoder.cn/Spring-Boot/RabbitMQ/#) å¤§ä½“ä¸€è‡´ï¼Œè§ [Demo05ProducerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-04-rabbitmq/lab-04-rabbitmq-consume-retry/src/test/java/cn/iocoder/springboot/lab04/rabbitmqdemo/producer/Demo07ProducerTest.java) å•å…ƒæµ‹è¯•ç±»ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend()` æ–¹æ³•ï¼Œæµ‹è¯• Consumer æ¶ˆè´¹é‡è¯•çš„æ•ˆæœã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š



```
# Producer æˆåŠŸåŒæ­¥å‘é€äº† 1 æ¡æ¶ˆæ¯
2019-12-15 14:21:40.424  INFO 66569 --- [           main] c.i.s.l.r.producer.Demo07ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1576045300] å‘é€æˆåŠŸ]

# Demo07Consumer ç¬¬ 1 æ¬¡æ¶ˆè´¹
2019-12-15 14:21:40.442  INFO 66569 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo07Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo07Message{id=1576045300}]
# ä¸€ç§’åï¼ŒConsumer ç¬¬ 2 æ¬¡æ¶ˆè´¹
2019-12-15 14:21:41.446  INFO 66569 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo07Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo07Message{id=1576045300}]
# ä¸€ç§’åï¼ŒConsumer ç¬¬ 3 æ¬¡æ¶ˆè´¹
2019-12-15 14:21:42.450  INFO 66569 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo07Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:17 æ¶ˆæ¯å†…å®¹ï¼šDemo07Message{id=1576045300}]

# RejectAndDontRequeueRecoverer æ‰“å°è¯¥æ¶ˆæ¯æ¶ˆè´¹é‡è¯•åˆ°è¾¾ä¸Šé™ï¼ŒåŒæ—¶æ‰“å°å¼‚å¸¸å †æ ˆ
2019-12-15 14:21:42.457  WARN 66569 --- [ntContainer#0-1] o.s.a.r.r.RejectAndDontRequeueRecoverer  : Retries exhausted for message (Body:'[B@514e3b1c(byte[187])' MessageProperties [headers={}, contentType=application/x-java-serialized-object, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=EXCHANGE_DEMO_07, receivedRoutingKey=ROUTING_KEY_07, deliveryTag=1, consumerTag=amq.ctag-UpkeXbl-7TYRNt_LuYDZJQ, consumerQueue=QUEUE_DEMO_07])
// ... çœç•¥ä¸€å¤§å †å¼‚å¸¸å †æ ˆ

# Demo07DeadConsumer æ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—çš„è¯¥æ¡æ¶ˆæ¯
2019-12-15 14:21:42.463  INFO 66569 --- [ntContainer#1-1] c.i.s.l.r.consumer.Demo07DeadConsumer    : [onMessage][ã€æ­»ä¿¡é˜Ÿåˆ—ã€‘çº¿ç¨‹ç¼–å·:19 æ¶ˆæ¯å†…å®¹ï¼šDemo07Message{id=1576045300}]
```



- Demo07Consumer é‡è¯•æ¶ˆè´¹æ¶ˆæ¯ 3 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 1 ç§’ï¼Œå…¨éƒ¨éƒ½å¤±è´¥ï¼Œæœ€ç»ˆè¯¥æ¶ˆæ¯è½¬å‘åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚
- Demo07DeadConsumer æ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„è¯¥æ¶ˆæ¯ã€‚

## 7.9 å‘é€é‡è¯•

åœ¨ Spring-AMQP ä¹Ÿæä¾›äº†æ¶ˆæ¯å‘é€å¤±è´¥æ—¶çš„é‡è¯•æœºåˆ¶ï¼Œä¹Ÿæ˜¯åŸºäº [spring-retry](https://github.com/spring-projects/spring-retry) é¡¹ç›®æä¾›çš„ [RetryTemplate](https://github.com/spring-projects/spring-retry/blob/master/src/main/java/org/springframework/retry/support/RetryTemplate.java) æ¥å®ç°ã€‚åœ¨ `application.yaml` é…ç½®å¦‚ä¸‹å³å¯ï¼š



```
spring:
  # RabbitMQ é…ç½®é¡¹ï¼Œå¯¹åº” RabbitProperties é…ç½®ç±»
  rabbitmq:
    host: 127.0.0.1 # RabbitMQ æœåŠ¡çš„åœ°å€
    port: 5672 # RabbitMQ æœåŠ¡çš„ç«¯å£
    username: guest # RabbitMQ æœåŠ¡çš„è´¦å·
    password: guest # RabbitMQ æœåŠ¡çš„å¯†ç 
    template:
      # å¯¹åº” RabbitProperties.Retry ç±»
      retry:
        enabled: true # å¼€å¯å‘é€æœºåˆ¶
        max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 3 ã€‚
        initial-interval: 1000 # é‡è¯•é—´éš”ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚é»˜è®¤ä¸º 1000 ã€‚
```



- `spring.rabbitmq.template.enable=true` é…ç½®é¡¹ï¼Œæ¥å¼€å¯ Spring-AMQP çš„å‘é€é‡è¯•çš„åŠŸèƒ½ã€‚åŒæ—¶ï¼Œé€šè¿‡**æ–°å¢** `max-attempts` å’Œ `initial-interval` é…ç½®é¡¹ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•°å’Œé—´éš”ã€‚

  > `max-attempts` é…ç½®é¡¹è¦æ³¨æ„ï¼Œæ˜¯ä¸€æ¡æ¶ˆæ¯ä¸€å…±å°è¯•æ¶ˆè´¹æ€»å…± `max-attempts` æ¬¡ï¼ŒåŒ…æ‹¬é¦–æ¬¡çš„æ­£å¸¸æ¶ˆè´¹ã€‚

- å¦å¤–ï¼Œèƒ–å‹å¯ä»¥é€šè¿‡æ·»åŠ  `spring.rabbitmq.template.retry.multiplier` é…ç½®é¡¹æ¥å®ç°**é€’ä¹˜**çš„æ—¶é—´é—´éš”ï¼Œæ·»åŠ  `spring.rabbitmq.template.retry.max-interval` é…ç½®é¡¹æ¥å®ç°**æœ€å¤§**çš„æ—¶é—´é—´éš”ã€‚

è¿™é‡Œè‰¿è‰¿å°±æš‚æ—¶ä¸æ‹“å±•å¼€æ¥è®²ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±å°è¯•ä¸‹å“ˆã€‚